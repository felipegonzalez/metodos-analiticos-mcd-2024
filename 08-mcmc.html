<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Métodos analíticos - 8&nbsp; Markov Chain Monte Carlo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./09-modelos-jerarquicos.html" rel="next">
<link href="./07-buenos-malos-controles.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Buscar"
  }
}</script>
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="site_libs/viz-1.8.2/viz.js"></script>
<link href="site_libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="site_libs/grViz-binding-1.0.10/grViz.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./08-mcmc.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Métodos analíticos</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Buscar"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Temario y referencias</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduccion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-flujo-basico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Flujo de trabajo básico: motivación</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-flujo-basico-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Flujo de trabajo básico: refinando el modelo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-modelos-genericos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Componentes de modelación 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-dags.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Modelos gráficos y causalidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-calculo-do.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Identificación y cálculo-do</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-buenos-malos-controles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Buenos y malos controles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-mcmc.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-modelos-jerarquicos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Modelos jerárquicos</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-exp-naturales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Otros métodos para inferencia causal</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-series-de-tiempo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modelos de espacio de estados</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#algoritmos-metropolis-hastings" id="toc-algoritmos-metropolis-hastings" class="nav-link active" data-scroll-target="#algoritmos-metropolis-hastings"><span class="header-section-number">8.1</span> Algoritmos Metropolis-Hastings</a>
  <ul class="collapse">
  <li><a href="#ejemplo-dos-implementaciones-de-metropolis" id="toc-ejemplo-dos-implementaciones-de-metropolis" class="nav-link" data-scroll-target="#ejemplo-dos-implementaciones-de-metropolis">Ejemplo: dos implementaciones de Metropolis</a></li>
  <li><a href="#balance-detallado" id="toc-balance-detallado" class="nav-link" data-scroll-target="#balance-detallado">Balance detallado</a></li>
  <li><a href="#ejemplo-metropolis-bivariado" id="toc-ejemplo-metropolis-bivariado" class="nav-link" data-scroll-target="#ejemplo-metropolis-bivariado">Ejemplo: Metropolis bivariado</a></li>
  </ul></li>
  <li><a href="#monte-carlo-hamiltoniano" id="toc-monte-carlo-hamiltoniano" class="nav-link" data-scroll-target="#monte-carlo-hamiltoniano"><span class="header-section-number">8.2</span> Monte Carlo Hamiltoniano</a>
  <ul class="collapse">
  <li><a href="#formulación-hamiltoniana-1-introducción" id="toc-formulación-hamiltoniana-1-introducción" class="nav-link" data-scroll-target="#formulación-hamiltoniana-1-introducción">Formulación Hamiltoniana 1: introducción</a></li>
  <li><a href="#formulación-hamiltoniana-2-densidades-de-probabilidad" id="toc-formulación-hamiltoniana-2-densidades-de-probabilidad" class="nav-link" data-scroll-target="#formulación-hamiltoniana-2-densidades-de-probabilidad">Formulación Hamiltoniana 2: densidades de probabilidad</a></li>
  <li><a href="#balance-detallado-para-hmc" id="toc-balance-detallado-para-hmc" class="nav-link" data-scroll-target="#balance-detallado-para-hmc">Balance detallado para HMC</a></li>
  <li><a href="#integración-de-las-ecuaciones-de-hamilton" id="toc-integración-de-las-ecuaciones-de-hamilton" class="nav-link" data-scroll-target="#integración-de-las-ecuaciones-de-hamilton">Integración de las ecuaciones de Hamilton</a></li>
  <li><a href="#ejemplo-hmc-en-una-distribución-normal-bivariada" id="toc-ejemplo-hmc-en-una-distribución-normal-bivariada" class="nav-link" data-scroll-target="#ejemplo-hmc-en-una-distribución-normal-bivariada">Ejemplo: HMC en una distribución normal bivariada</a></li>
  <li><a href="#comparación-de-hmc-y-metropolis" id="toc-comparación-de-hmc-y-metropolis" class="nav-link" data-scroll-target="#comparación-de-hmc-y-metropolis">Comparación de HMC y Metropolis</a></li>
  <li><a href="#hmc-en-stan" id="toc-hmc-en-stan" class="nav-link" data-scroll-target="#hmc-en-stan">HMC en Stan</a></li>
  </ul></li>
  <li><a href="#diagnósticos-de-convergencia" id="toc-diagnósticos-de-convergencia" class="nav-link" data-scroll-target="#diagnósticos-de-convergencia"><span class="header-section-number">8.3</span> Diagnósticos de convergencia</a>
  <ul class="collapse">
  <li><a href="#modelos-con-variables-latentes" id="toc-modelos-con-variables-latentes" class="nav-link" data-scroll-target="#modelos-con-variables-latentes">Modelos con variables latentes</a></li>
  <li><a href="#diagnóstico-trazas-de-cadenas" id="toc-diagnóstico-trazas-de-cadenas" class="nav-link" data-scroll-target="#diagnóstico-trazas-de-cadenas"><span class="header-section-number">8.3.1</span> Diagnóstico: Trazas de cadenas</a></li>
  <li><a href="#diagnóstico-valores-r-hat" id="toc-diagnóstico-valores-r-hat" class="nav-link" data-scroll-target="#diagnóstico-valores-r-hat"><span class="header-section-number">8.3.2</span> Diagnóstico: valores R-hat</a></li>
  <li><a href="#diagnóstico-tamaño-de-muestra-efectivo" id="toc-diagnóstico-tamaño-de-muestra-efectivo" class="nav-link" data-scroll-target="#diagnóstico-tamaño-de-muestra-efectivo"><span class="header-section-number">8.3.3</span> Diagnóstico: Tamaño de muestra efectivo</a></li>
  </ul></li>
  <li><a href="#extendiendo-el-modelo-de-variable-latente" id="toc-extendiendo-el-modelo-de-variable-latente" class="nav-link" data-scroll-target="#extendiendo-el-modelo-de-variable-latente"><span class="header-section-number">8.4</span> Extendiendo el modelo de variable latente</a></li>
  <li><a href="#transiciones-divergentes" id="toc-transiciones-divergentes" class="nav-link" data-scroll-target="#transiciones-divergentes"><span class="header-section-number">8.5</span> Transiciones divergentes</a>
  <ul class="collapse">
  <li><a href="#el-embudo-de-neal" id="toc-el-embudo-de-neal" class="nav-link" data-scroll-target="#el-embudo-de-neal"><span class="header-section-number">8.5.1</span> El embudo de Neal</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DiagrammeR)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">theme_set</span>(ggplot2<span class="sc">::</span><span class="fu">theme_light</span>())</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>inv_logit <span class="ot">&lt;-</span> \(x) <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>x)) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>En esta sección exlicaremos brevemente cómo funcionan paquetes como Stan para producir simulaciones de una posteriores complicadas en dimensión alta.</p>
<p>En primer lugar, recordemos que si queremos calcular la posterior de un modelo (generalmente para calcular después resúmenes que involucran integrales de esta posterior) tenemos los siguiente enfoques:</p>
<ol type="1">
<li>Intentar hacer los cálculos analíticamente.</li>
<li>Usar una aproximación de rejilla.</li>
<li>Simulación por Markov Chain Monte Carlo (MCMC).</li>
</ol>
<p>Stan utiliza 3, y hay variedad de algoritmos MCMC. Ya discutimos que 1, la aproximación analítica, es en general imposible (a menos fuera de ciertos modelos restringidos). La aproximación 2 excesivamente intensiva, al grado que sólo para modelos muy chicos y con pocos parámetros es posible utilizarla. Existen otros métodos también como aproximaciones cuadráticas que en ciertos casos funcionan, pero son limitados en su aplicación.</p>
<p>La idea de simulación de variables aleatorias es ahora fundamental en <a href="https://en.wikipedia.org/wiki/Monte_Carlo_method">muchas áreas científicas</a>, incluyendo la estadística, y los métodos que la utilizan se llaman métodos de <strong>Monte Carlo</strong>. Por ejemplo, considera el método bootstrap, pruebas de permutaciones, validación cruzada, y en general simulación para cálculo de resúmenes que son difíciles de calcular directamente (por ejemplo, la mediana de una distribución Gamma, ver Median approximations and bounds <a href="https://en.wikipedia.org/wiki/Gamma_distribution">aquí</a>).</p>
<section id="algoritmos-metropolis-hastings" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="algoritmos-metropolis-hastings"><span class="header-section-number">8.1</span> Algoritmos Metropolis-Hastings</h2>
<p>Uno de los primeros algoritmos MCMC fue el de Metropolis-Hastings, que veremos primero en algunos ejemplos. Veremos también por qué ahora tenemos mejores opciones que MH para estimar posteriores de nuestros modelos.</p>
<section id="ejemplo-dos-implementaciones-de-metropolis" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo-dos-implementaciones-de-metropolis">Ejemplo: dos implementaciones de Metropolis</h3>
<p>Supongamos que queremos simular de una variable aleatoria <span class="math inline">\(X\)</span> con distribución discreta sobre los valores <span class="math inline">\(1,2\ldots, k\)</span> con probabilidades <span class="math inline">\(p(1),p(2),\ldots,p(k)\)</span>. Este problema puede resolverse fácilmente de varias maneras, pero utilizaremos un método de Monte Carlo tipo Metropolis. Supongamos que podemos simular de una variable aleatoria <span class="math inline">\(U\)</span> que es uniforme en <span class="math inline">\(1,2,\ldots, k\)</span> (con probabilidades iguales a 1/k).</p>
<p>Lo que podemos hacer es lo que sigue, para <span class="math inline">\(i=1,\ldots, M\)</span>:</p>
<ol start="0" type="1">
<li>Para <span class="math inline">\(i=1\)</span>, comenzamos fijando un valor <span class="math inline">\(x_1\)</span> en <span class="math inline">\(1,2,\ldots, k\)</span>.</li>
</ol>
<p>Para cada <span class="math inline">\(i\)</span>,</p>
<ol start="2" type="1">
<li>Simulamos una uniforme en <span class="math inline">\(1,2,\ldots, k\)</span>. Al valor <span class="math inline">\(u_i\)</span> obtenido le llamamos valor <em>propuesto</em>.</li>
<li>Calculamos <span class="math inline">\(q = p(u_i)/p(x_i)\)</span> (el cociente de la probabilidad del valor propuesto entre la probabilidad del valor actualo).</li>
<li>Si <span class="math inline">\(q &gt; 1\)</span>, aceptamos el valor propuesto y ponemos <span class="math inline">\(x_{i+1} = u_i\)</span>.</li>
<li>Si <span class="math inline">\(q &lt; 1\)</span>, aceptamos el valor propuesto con probabilidad <span class="math inline">\(q\)</span> (<span class="math inline">\(x_{i+1} = u_i\)</span>), y con probabilidad <span class="math inline">\(1-q\)</span> rechazamos (<span class="math inline">\(x_{i+1} = x_i\)</span>).</li>
</ol>
<p>El resultado es una sucesión de valores <span class="math inline">\(x_1,x_2,\ldots, x_M\)</span>. Es posible demostrar que la distribución de estas <span class="math inline">\(x_i\)</span> converge a la distribución <span class="math inline">\(p(1),\ldots, p(k)\)</span> si <span class="math inline">\(M\)</span> es suficientemente grande.</p>
<p>Este método se llama <strong>Metropolis-Hastings</strong>. Es un método de Monte Carlo, y como podemos ver, se trata de una <strong>cadena de Markov</strong>, pues la distribución cada siguiente lugar <span class="math inline">\(x_{i+1}\)</span>, condicionada al valor actual <span class="math inline">\(x_i\)</span> no depende de valores anteriores de las <span class="math inline">\(x\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">45123</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># definimos estas p</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>k <span class="sc">-</span> k<span class="sc">/</span><span class="dv">3</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="dv">10</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">/</span><span class="fu">sum</span>(p)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>dist_obj <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span>k, <span class="at">p =</span> p)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># simulamos</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="dv">200000</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">numeric</span>(M)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>k, <span class="dv">1</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> p[u] <span class="sc">/</span> p[x[i]]</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> q){</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    x[i<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> u</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    x[i<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> x[i]  </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En rojo mostramos las probabilidades objetivo que queremos estimar, y en negro las estimadas con nuestro método de arriba.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>resultados_sim <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> x) <span class="sc">|&gt;</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_sim =</span> <span class="fu">row_number</span>())</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>resumen_sim <span class="ot">&lt;-</span> resultados_sim <span class="sc">|&gt;</span> <span class="fu">count</span>(x) <span class="sc">|&gt;</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(<span class="fu">tibble</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span>k, <span class="at">p =</span> p)) <span class="sc">|&gt;</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(n), <span class="dv">0</span>, n)) <span class="sc">|&gt;</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_aprox =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(x)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dist_obj, <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> p)) <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> resumen_sim, </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> p_aprox), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Como vemos, los valores de <span class="math inline">\(x_1,\ldots, x_M\)</span> se distribuyen aproximadamente como la distribución <span class="math inline">\(p\)</span> objetivo. Esta es una manera de simular valores de esta distribución discreta <span class="math inline">\(p\)</span>. Podemos ver cómo se ven las simulaciones sucesivas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(resultados_sim <span class="sc">|&gt;</span> <span class="fu">filter</span>(n_sim <span class="sc">&lt;</span> <span class="dv">400</span>), <span class="fu">aes</span>(<span class="at">x =</span> n_sim, <span class="at">y =</span> x)) <span class="sc">+</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>El defecto que tiene este algoritmo es que puede ser relativamente lento, pues vemos que hay periodos largos donde se “atora” en valores de probabilidad relativamente alta. La razón es que en muchos pasos, estamos proponiendo “saltos al vacío” a lugares de probabilidad muy baja, que rara vez se aceptan.</p>
<p>Podemos hacer más eficiente nuestro algoritmo si le permitimos explorar con mayor facilidad los posibles valores de <span class="math inline">\(x\)</span>. Esto se logra proponiendo saltos locales: si estamos en <span class="math inline">\(x_i\)</span>, entonces proponemos los valores <span class="math inline">\(x_i - 1\)</span> y <span class="math inline">\(x_i + 1\)</span> con la misma probabilidad 1/2 (excepto en los extremos donde sólo proponemos <span class="math inline">\(x_i,x_i+1\)</span> o <span class="math inline">\(x_i-1,x_i\)</span>).</p>
<p>Proponemos entonces la suguiente modificación del paso 1 de propuesta:</p>
<ol start="0" type="1">
<li>Para <span class="math inline">\(i=1\)</span>, comenzamos fijando un valor <span class="math inline">\(x_1\)</span> en <span class="math inline">\(1,2,\ldots, k\)</span>.</li>
</ol>
<p>Para cada <span class="math inline">\(i\)</span>,</p>
<ol start="2" type="1">
<li>Si <span class="math inline">\(1&lt; x_i&lt;k\)</span>, escogemos al azar un salto a la derecha o al izquierda con igual probabilidad 1/2. En los extremos <span class="math inline">\(x_i=1\)</span> o <span class="math inline">\(x_i=k\)</span> escogemos entre <span class="math inline">\(1,2\)</span> o <span class="math inline">\(k-1,k\)</span> respectivamente. Al valor <span class="math inline">\(u_i\)</span> obtenido le llamamos valor <em>propuesto</em>.</li>
<li>Calculamos <span class="math inline">\(q = p(u_i)/p(x_i)\)</span> .</li>
<li>Si <span class="math inline">\(q &gt; 1\)</span>, aceptamos el valor propuesto y ponemos <span class="math inline">\(x_{i+1} = u_i\)</span>.</li>
<li>Si <span class="math inline">\(q &lt; 1\)</span>, aceptamos el valor propuesto con probabilidad <span class="math inline">\(q\)</span> (<span class="math inline">\(x_{i+1} = u_i\)</span>), y con probabilidad <span class="math inline">\(q\)</span> rechazamos(<span class="math inline">\(x_{i+1} = x_i\)</span>).</li>
</ol>
<p>Esto lo escribimos como sigue:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set.seed(4511)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># simulamos</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">numeric</span>(M)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(x[i] <span class="sc">-</span> <span class="dv">1</span>,  x[i] <span class="sc">+</span> <span class="dv">1</span>), <span class="dv">1</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(u <span class="sc">==</span> k<span class="sc">+</span><span class="dv">1</span>) u <span class="ot">&lt;-</span> k</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(u <span class="sc">==</span> <span class="dv">0</span>) u <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> p[u] <span class="sc">/</span> p[x[i]]</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> q){</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    x[i<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> u</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    x[i<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> x[i]  </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Obtenemos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>resultados_sim_2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> x) <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_sim =</span> <span class="fu">row_number</span>())</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>resumen_sim_2 <span class="ot">&lt;-</span> resultados_sim_2 <span class="sc">|&gt;</span> <span class="fu">count</span>(x) <span class="sc">|&gt;</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p_aprox =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dist_obj, <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> p)) <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> resumen_sim_2, </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> p_aprox), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Y podemos ver cómo evoluciona nuestra cadena de Markov:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(resultados_sim_2 <span class="sc">|&gt;</span> <span class="fu">filter</span>(n_sim <span class="sc">&lt;</span> <span class="dv">400</span>), <span class="fu">aes</span>(<span class="at">x =</span> n_sim, <span class="at">y =</span> x)) <span class="sc">+</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>¿Cómo se comparan estos dos métodos? Podemos ver por ejemplo cómo se comparan las distribuciones aproximadas hasta cierto número de iteraciones con la verdadera distribución objetivo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>approx_sim <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">seq</span>(<span class="dv">200</span>, <span class="dv">30000</span>, <span class="at">by =</span> <span class="dv">200</span>), <span class="cf">function</span>(n_sims){</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  resumen_1 <span class="ot">&lt;-</span> resultados_sim <span class="sc">|&gt;</span> <span class="fu">filter</span>(n_sim <span class="sc">&lt;=</span> n_sims) <span class="sc">|&gt;</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">p_aprox =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>n) <span class="sc">|&gt;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">right_join</span>(dist_obj, <span class="at">by =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">metodo =</span> <span class="st">"MH-1"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">n_sims =</span> n_sims) </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  resumen_2 <span class="ot">&lt;-</span> resultados_sim_2 <span class="sc">|&gt;</span> <span class="fu">filter</span>(n_sim <span class="sc">&lt;=</span> n_sims) <span class="sc">|&gt;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">p_aprox =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>n) <span class="sc">|&gt;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">right_join</span>(dist_obj, <span class="at">by =</span> <span class="st">"x"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">metodo =</span> <span class="st">"MH-2"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">n_sims =</span> n_sims) </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(resumen_1, resumen_2) <span class="sc">|&gt;</span> </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">p_aprox =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(p_aprox), <span class="dv">0</span>, p_aprox))</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>approx_sim <span class="sc">|&gt;</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dif_abs =</span> <span class="fu">abs</span> (p_aprox<span class="sc">-</span>p)) <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(metodo, n_sims) <span class="sc">|&gt;</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">dif_abs =</span> <span class="fu">sum</span>(dif_abs)) <span class="sc">|&gt;</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(n_sims, dif_abs, <span class="at">color =</span> metodo)) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'metodo'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>En este caso, considera qué es lo que sucede en cada uno de estos casos:</p>
<ol type="1">
<li>El algoritmo que da saltos grandes muchas veces rechaza porque cae en un área de probilidad muy baja.</li>
<li>El algoritmo que da saltos chicos puede tardar en explorar regiones de probabilidad relativamente alta con suficiente frecuencia (tarda un moverse de un lugar a otro), por su naturaleza de “caminata aleatoria”. Pero sus tasas de aceptación son más altas.</li>
</ol>
<p>Este es el primer <em>trade-off</em> que existe en este algoritmo: tomar pasos grandes y balancear las probabilidades quizá rechazando muy frecuentemente (no es eficiente), o tomar pasos chicos y vagar más tiempo para visitar regiones de alta probabilidad, aunque con menos tasa de rechazo. Dependiendo de la distribución que queremos aproximar podemos inclinarnos más por una o por otra opción. En dimensiones altas generalmente ninguna combinación es muy buena.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Idea básica de MCMC
</div>
</div>
<div class="callout-body-container callout-body">
<p>En MCMC, buscamos un cadena de Markov que, en el largo plazo, visite cada posible valor del parámetro proporcionalmente a la probabildad posterior del parámetro. En el caso multivariado es la misma idea: cada combinación de parámetros debe ser visitada por la cadena en proporción a su probabilidad posterior.</p>
</div>
</div>
</section>
<section id="balance-detallado" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="balance-detallado">Balance detallado</h3>
<p>¿Por qué funcionan estos algoritmos? Supongamos que en cada paso, se cumple que (balance detallado): <span class="math display">\[{q(x|y)}p(y) = {q(y|x)}{p(x)}\]</span> donde <span class="math inline">\(q(x|y)\)</span> son las probabilidades de transición de nuestra cadena de Markov propuesta. Esta ecuación dice que la proporción de transiciones de <span class="math inline">\(y\)</span> a <span class="math inline">\(x\)</span> en relación a las transiciones de <span class="math inline">\(x\)</span> a <span class="math inline">\(y\)</span> es la misma que la proporción de probabilidad que hay entre <span class="math inline">\(y\)</span> y <span class="math inline">\(x\)</span> en la distribución objetivo.</p>
<p>Esta ecuación implica que si la probabilidad se distribuye como <span class="math inline">\(p(x)\)</span>, entonces al transicionar con <span class="math inline">\(q\)</span> la probabilidad fluje de manera que se mantiene estática en <span class="math inline">\(p\)</span>, es decir <span class="math inline">\(p\)</span> es una <em>distribución estacionaria</em> para la cadena de Markov producida por las transiciones.</p>
<p>Esto es fácil de demostrar pues <span class="math display">\[\sum_{y} q(x|y)p(y) = \sum_{y} q(y|x)p(x) = p(x) \sum_{y} q(y|x) = p(x).\]</span></p>
<p>Bajo otros supuestos adicionales de ergodicidad (aperiodicidad y tiempos de recurrencia finitos, es decir, las transiciones <em>mezclan</em> bien los estados), entonces podemos simular la cadena de Markov por un tiempo suficientemente largo y con esto obtener una muestra de la distribución objetivo <span class="math inline">\(p\)</span>, es decir, la distribución estacionaria <span class="math inline">\(p(x)\)</span> también es la distribución de largo plazo para cualquier cadena que simulemos.</p>
<p>¿Cómo podemos diseñar entonces las <span class="math inline">\(q(x|y)\)</span> correspondientes?</p>
<p>Comenzamos considerando distribuciones propuesta <span class="math inline">\(q_0(x|y)\)</span> que no necesariamente satisfacen la ecuación de balance, y supondremos como en los ejemplos de arriba (verifícalo) que nuestras transiciones tienen probabilidades simétricas <span class="math inline">\(q_0(y|x) = q_0(x|y)\)</span>. Entonces, cuando <span class="math inline">\(p(y)/p(x) &gt; 1\)</span>, queremos transicionar de <span class="math inline">\(x\)</span> a <span class="math inline">\(y\)</span> con más frecuencia que de <span class="math inline">\(y\)</span> a <span class="math inline">\(x\)</span>. Comenzando en <span class="math inline">\(x\)</span>, si la propuesta de <span class="math inline">\(q_0(y|x)\)</span> es <span class="math inline">\(y\)</span>, podríamos poner entonces que el sistema transicione con probabilidad 1 a <span class="math inline">\(y\)</span>. Sin embargo, si empezamos en <span class="math inline">\(y\)</span> y la propuesta es <span class="math inline">\(x\)</span>, ponemos que el sistema sólo transiciona de <span class="math inline">\(y\)</span> a <span class="math inline">\(x\)</span> con probabilidad <span class="math inline">\(p(x)/p(y)\)</span>.</p>
<p>De esta manera, obtenemos que bajo <span class="math inline">\(q(y|x)\)</span>, <span class="math inline">\(x\)</span> transiciona a <span class="math inline">\(y\)</span> con probabilidad $q_0(y|x) multiplicada por <span class="math inline">\(\min\{1, p(y)/p(x)\}\)</span>. Entonces, el cociente <span class="math inline">\(\frac{q(y|x)}{q(x|y)}\)</span> (usando también la simetría de <span class="math inline">\(q_0(y|x)\)</span>, es igual a <span class="math inline">\(\frac{p(y)}{p(x)}\)</span> si <span class="math inline">\(p(y)&lt;p(x)\)</span>. Si <span class="math inline">\(p(x)&gt;p(y)\)</span>, entonces siguiendo el mismo argumento, y por simetría de <span class="math inline">\(q_0(y|x)\)</span>, se cumple que el cociente de probabilidades es tambien igual a <span class="math inline">\(\frac{p(y)}{p(x)}\)</span>. Esto demuestra que se cumple el balance detallado.</p>
<p>De esta forma, balanceamos las transiciones de <span class="math inline">\(q_0(y|x)\)</span> modificando con el proceso de adaptación y rechazo, para que la cadena de Markov resultante tenga la distribución estacionario <span class="math inline">\(p(x)\)</span>, que es la distribución objetivo.</p>
</section>
<section id="ejemplo-metropolis-bivariado" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo-metropolis-bivariado">Ejemplo: Metropolis bivariado</h3>
<p>Supongamos ahora que quisiéramos simular de una normal multivariada con media en c(2,3) y matriz de covarianza <span class="math inline">\(\Sigma\)</span>, que supondremos es tal que la desviación estándar de cada variable es 1 y la correlación es 0.8. La matriz <span class="math inline">\(\Sigma\)</span> tiene 1 en la diagonal y 0.8 fuera de la diagonal.</p>
<p>La distribución objetivo <span class="math inline">\(p\)</span> está dada entonces (módulo una constante de proporcionalidad):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>construir_log_p <span class="ot">&lt;-</span> <span class="cf">function</span>(m, Sigma){</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  Sigma_inv <span class="ot">&lt;-</span> <span class="fu">solve</span>(Sigma)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(z){</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> (<span class="fu">t</span>(z<span class="sc">-</span>m) <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> (z<span class="sc">-</span>m))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>Sigma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.8</span>, <span class="fl">0.8</span>, <span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>log_p <span class="ot">&lt;-</span> <span class="fu">construir_log_p</span>(m, Sigma)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Nótese que como Metropolis hace cocientes de probabilidades, sólo es necesario conocer la densidad objetivo módulo una constante de proporcionalidad.</p>
<p>Una algoritmo de Metropolis podría ser el siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simulamos</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>metropolis_mc <span class="ot">&lt;-</span> <span class="cf">function</span>(M, <span class="at">z_inicial =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), log_p, delta_x, delta_y){</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> M, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  z[<span class="dv">1</span>, ] <span class="ot">&lt;-</span>z_inicial</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(z) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  rechazo <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(M<span class="dv">-1</span>)){</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    x_prop <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, z[i, <span class="dv">1</span>], delta_x)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    y_prop <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, z[i, <span class="dv">2</span>], delta_y)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    z_prop <span class="ot">&lt;-</span> <span class="fu">c</span>(x_prop, y_prop)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    q <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">log_p</span>(z_prop) <span class="sc">-</span> <span class="fu">log_p</span>(z[i, ]))</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> q){</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>      z[i <span class="sc">+</span> <span class="dv">1</span>, ] <span class="ot">&lt;-</span> z_prop</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>      rechazo <span class="ot">&lt;-</span> rechazo <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>      z[i <span class="sc">+</span> <span class="dv">1</span>, ] <span class="ot">&lt;-</span> z[i, ]</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(rechazo <span class="sc">/</span> M)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  z_tbl <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(z) <span class="sc">|&gt;</span> </span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">n_sim =</span> <span class="fu">row_number</span>())</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  z_tbl</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>z_tbl <span class="ot">&lt;-</span> <span class="fu">metropolis_mc</span>(M, <span class="fu">c</span>(<span class="fl">2.5</span>, <span class="fl">3.5</span>), log_p, <span class="fl">1.0</span>, <span class="fl">1.0</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.59752</code></pre>
</div>
</div>
<p>Vemos que tenemos una tasa alta de rechazos. ¿Por qué? Veamos cómo se ven las simulaciones hasta 500 iteraciones:</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estas las usamos para graficar</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>sims_normal <span class="ot">&lt;-</span> mvtnorm<span class="sc">::</span><span class="fu">rmvnorm</span>(<span class="dv">100000</span>, <span class="at">mean =</span> m, <span class="at">sigma =</span> Sigma)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(sims_normal) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>sims_normal <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(sims_normal)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>elipses_normal <span class="ot">&lt;-</span><span class="fu">list</span>(<span class="fu">stat_ellipse</span>(<span class="at">data =</span> sims_normal, <span class="fu">aes</span>(x, y), </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">level =</span> <span class="fu">c</span>(<span class="fl">0.9</span>), <span class="at">type =</span> <span class="st">"norm"</span>, <span class="at">colour =</span> <span class="st">"salmon"</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">data =</span> sims_normal, <span class="fu">aes</span>(x, y), </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">level =</span> <span class="fu">c</span>(<span class="fl">0.5</span>), <span class="at">type =</span> <span class="st">"norm"</span>, <span class="at">colour =</span> <span class="st">"salmon"</span>), </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">data =</span> sims_normal, <span class="fu">aes</span>(x, y), </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">level =</span> <span class="fu">c</span>(<span class="fl">0.2</span>), <span class="at">type =</span> <span class="st">"norm"</span>, <span class="at">colour =</span> <span class="st">"salmon"</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>graf_tbl <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">500</span>, <span class="dv">20</span>), <span class="cf">function</span>(i){</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  z_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(n_sim <span class="sc">&lt;=</span> i) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">num_sims =</span> i)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(graf_tbl, <span class="fu">aes</span>(x, y)) <span class="sc">+</span> </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  elipses_normal <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>num_sims) <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>anim_mh_1 <span class="ot">&lt;-</span> z_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(n_sim <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(x, y, <span class="at">group =</span> n_sim), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transition_reveal</span>(n_sim) <span class="sc">+</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  elipses_normal <span class="sc">+</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Iteración: {frame_along}'</span>) <span class="sc">+</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">anim_save</span>(<span class="at">animation =</span> anim_mh_1, <span class="at">filename =</span> <span class="st">"figuras/mh-1-normal.gif"</span>, </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>())</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figuras/mh-1-normal.gif" class="img-fluid figure-img"></p>
<figcaption>Metropolis Hastings</figcaption>
</figure>
</div>
<p><strong>Observaciones</strong>:</p>
<ul>
<li>Los puntos que tienen intensidad alta son puntos donde hubo varios rechazos. Esto es porque las propuestas a veces caen en elipses de baja probabilidad (en la gráfica mostramos una elipse de 50% probabilidad y otra de 95%).</li>
<li>Esto se debe a que los saltos en cada dirección son de desviación estándar 1, y esto fácilmente nos lleva a una zona de alta probabilidad a una de baja probabilidad.</li>
<li>Sin embargo, a largo plazo, vemos cómo la cadena está visitando las regiones de alta probabilidad con aparentemente la frecuencia correcta.</li>
</ul>
<p>Podemos entonces proponer saltos más chicos, por ejemplo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>z_tbl <span class="ot">&lt;-</span> <span class="fu">metropolis_mc</span>(M, <span class="fu">c</span>(<span class="fl">2.5</span>, <span class="fl">3.5</span>), log_p, <span class="fl">0.2</span>, <span class="fl">0.2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.15584</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>graf_tbl <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">500</span>, <span class="dv">20</span>), <span class="cf">function</span>(i){</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  z_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(n_sim <span class="sc">&lt;=</span> i) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">num_sims =</span> i)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(graf_tbl, <span class="fu">aes</span>(x, y)) <span class="sc">+</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">data =</span> sims_normal, <span class="fu">aes</span>(x, y), </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">level =</span> <span class="fu">c</span>( <span class="fl">0.9</span>), <span class="at">type =</span> <span class="st">"norm"</span>, <span class="at">colour =</span> <span class="st">"salmon"</span>) <span class="sc">+</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">data =</span> sims_normal, <span class="fu">aes</span>(x, y), </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">level =</span> <span class="fu">c</span>( <span class="fl">0.5</span>), <span class="at">type =</span> <span class="st">"norm"</span>, <span class="at">colour =</span> <span class="st">"salmon"</span>) <span class="sc">+</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>num_sims) <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>anim_mh_2 <span class="ot">&lt;-</span> z_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(n_sim <span class="sc">&lt;</span> <span class="dv">150</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(x, y, <span class="at">group =</span> n_sim), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transition_reveal</span>(n_sim) <span class="sc">+</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  elipses_normal <span class="sc">+</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Iteración: {frame_along}'</span>) <span class="sc">+</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="fu">anim_save</span>(<span class="at">animation =</span> anim_mh_2, <span class="at">filename =</span> <span class="st">"figuras/mh-2-normal.gif"</span>, </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>())</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figuras/mh-2-normal.gif" class="img-fluid figure-img"></p>
<figcaption>Metropolis Hastings salto chico</figcaption>
</figure>
</div>
<p><strong>Observaciones</strong>:</p>
<ul>
<li>En este caso tenemos una tasa de aceptación más alta.</li>
<li>Sin embargo, la cadena parece “vagar” en la regiones de probabilidad alta, y tiene dificultades para explorar correctamente estas regiones: se comporta localmente como una caminata aleatoria.</li>
<li>Sin embargo, a largo plazo, vemos cómo la cadena está visitando las regiones de alta probabilidad con aparentemente la frecuencia correcta.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Metropolis-Hastings
</div>
</div>
<div class="callout-body-container callout-body">
<p>En el algoritmo de Metropolis Hastings hay una tensión natural entre el tamaño de salto y la tasa de aceptación. Si el tamaño de los saltos es muy grande, la tasa de aceptación puede ser baja y esto producen ineficiencias. Si el tamaño de los saltos es muy chico, la tasa de aceptación es más alta, pero esto también es ineficiente pues la cadena puede explorar muy lentamente el espacio de parámetros.</p>
</div>
</div>
<p>Existen métodos que pueden superar este problema, como son muestreo de Gibbs y Monte Carlo Hamiltoniano. El primero no lo discutiremos, pues requiere poder simular fácilmente de cada parámetro dados los otros, y esto no siempre es posible. Veremos más el segundo, donde usaremos información del gradiente de la distribución objetivo para proponer exploración más eficiente.</p>
</section>
</section>
<section id="monte-carlo-hamiltoniano" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="monte-carlo-hamiltoniano"><span class="header-section-number">8.2</span> Monte Carlo Hamiltoniano</h2>
<p>Una manera de mejorar la exploración de Metropolis es utilizar una distribución de propuestas más apropiada. La intuición en el caso anterior es:</p>
<ul>
<li>Hay direcciones de más curvatura de la posterior que otras: movimientos relativamente chicos en las direcciones de alta curvatura nos llevan a regiones de probabilidad demasiado baja, y entonces tendemos a rechazar. Pero hacer movimientos aún más chicos para evitar rechazos nos lleva a explorar muy lentamente el espacio de parámetros.</li>
<li>Podríamos evitar esto si nuestros saltos siguieran la curvatura natural de la distribución, como una pelota que rueda por la superficie de la distribución objetivo (con signo negativo, de forma que regiones de probabilidad alta sean valles o regiones bajas).</li>
</ul>
<p>La idea de HMC es considerar el problema de muestrear de una distribución como un problema físico, donde introducimos aleatoridad solamente en cuanto a la “energía” de la pelota que va a explorar la posterior. Inicialmente impartimos un momento tomado al azar a la pelota, seguimos su trayectoria por un tiempo y el lugar a donde llega es nuestra nueva simulación. Esto permite que podamos dar saltos más grandes, sin “despeñarnos” en regiones de probabilidad muy baja y así evitar rechazos.</p>
<p>Adicionalmente, veremos que si definimos el sistema físico apropiadamente, es posible obtener ecuaciones de balance detallado, lo cual en teoría nos garantiza una manera de transicionar que resultará a largo plazo en una muestra de la distribución objetivo.</p>
<section id="formulación-hamiltoniana-1-introducción" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="formulación-hamiltoniana-1-introducción">Formulación Hamiltoniana 1: introducción</h3>
<p>Primero veremos cuál es la formulación Hamiltoniana (muy simple) de un sistema físico que nos sirve para encontrar la trayectoria de partículas del sistema. Consideremos una sola partícula cuya posición está dada por <span class="math inline">\(q\)</span>, que suponemos en una sola dimensión. La partícula rueda en una superficie cuya altura describimos como <span class="math inline">\(V(q)\)</span>, y tiene en cada instante tiene momento <span class="math inline">\(p = m\dot{q}\)</span>.</p>
<p>El Hamiltoniano es la energía total de este sistema, en el <em>espacio fase</em> que describe el estado de cada partícula dadas su posición y momento <span class="math inline">\((p,q)\)</span>, y es la suma de energía cinética más energía potencial:</p>
<p><span class="math inline">\(H(p,q) = T(p) + V(q)\)</span></p>
<p>donde <span class="math inline">\(V(q) = q^2/2\)</span> está dada y <span class="math inline">\(T(p) = \frac{p^2}{2m}\)</span>, de modo que</p>
<p><span class="math display">\[H(p, q) = \frac{p^2}{2m} + V(q) = \frac{p^2}{2m} + \frac{q^2}{2}\]</span></p>
<p>Ahora consideremos las curvas de nivel de <span class="math inline">\(H\)</span> (energía total constante), que en este caso se conservan a lo largo del movimiento de la partícula. Como sabemos por cálculo, estas curvas son perpendiculares al gradiente del Hamiltoniano, que es <span class="math inline">\((\partial{H}/\partial{p}, \partial{H}/\partial{q})\)</span>. El movimiento de las partículas, sin embargo, es a lo largo de las curvas de nivel, de manera que el flujo instantáneo debe estar dado por el gradiente de <span class="math inline">\(H\)</span> rotado 90 grados, es decir, por <span class="math inline">\((\partial{H}/\partial{q}, -\partial{H}/\partial{p})\)</span>.</p>
<p>Entonces tenemos que el movimiento de la partícula debe cumplir las ecuaciones de Hamilton:</p>
<p><span class="math display">\[\frac{dp}{dt} = \frac{\partial{H}}{\partial{q}}, \frac{dq}{dt} = -\frac{\partial{H}}{\partial{p}}\]</span> Simplificando y usando la definición de <span class="math inline">\(H\)</span>, obtenemos que <span class="math display">\[\frac{dq}{dt} = \frac{p}{m}, \frac{dp}{dt} = -\frac{\partial{V}}{\partial{q}} = -q\]</span> Ilustramos este campo vectorial en la siguiente gráfica, donde escogemos <span class="math inline">\(V(q) = q^2/2\)</span>, <span class="math inline">\(m=1\)</span>, y dibujamos algunas curvas de nivel del Hamiltoniano:</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>espacio_fase_1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">p =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">1000</span>), <span class="at">q =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">1000</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand</span>(p, q) <span class="sc">|&gt;</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dq =</span> p, <span class="at">dp =</span> <span class="sc">-</span>q) <span class="sc">|&gt;</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">H =</span> p<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span> <span class="sc">+</span> q<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>espacio_fase <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">p =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">10</span>), <span class="at">q =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">10</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand</span>(p, q) <span class="sc">|&gt;</span> </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dq =</span> p, <span class="at">dp =</span> <span class="sc">-</span>q)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>espacio_fase <span class="sc">|&gt;</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(p, q)) <span class="sc">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_contour</span>(<span class="at">data =</span> espacio_fase_1, <span class="fu">aes</span>(<span class="at">x =</span> p, <span class="at">y =</span> q, <span class="at">z =</span> H)) <span class="sc">+</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> p <span class="sc">+</span> dp<span class="sc">/</span><span class="dv">5</span>, <span class="at">yend =</span> q <span class="sc">+</span> dq<span class="sc">/</span><span class="dv">5</span>), </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.1</span>, <span class="st">"inches"</span>))) <span class="sc">+</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Movimiento en espacio fase: 1 dimensión"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Ojo</strong>: este no es le movimiento de una partícula en dimensión 2: es el movimiento de la partícula en el espacio fase <span class="math inline">\((p,q)\)</span>, y la variable de posición <span class="math inline">\(q\)</span> es de dimensión 1. Los ciclos de la gráfica muestran como conforme la partícula se mueve, energía potencial y cinética se intercambian a lo largo de su trayectoria en un “hilo”.</p>
</section>
<section id="formulación-hamiltoniana-2-densidades-de-probabilidad" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="formulación-hamiltoniana-2-densidades-de-probabilidad">Formulación Hamiltoniana 2: densidades de probabilidad</h3>
<p>Consideremos una partícula en el espacio de parámetros <span class="math inline">\(\theta\)</span>. En esta formulación, si <span class="math inline">\(\theta\)</span> son los parámetros de interés, consideramos la energía potencial del sistema como <span class="math inline">\(V(p) = -\log p(\theta)\)</span>, donde <span class="math inline">\(p(\theta)\)</span> es la distribución objetivo.</p>
<p>Buscamos simular del sistema con ecuaciones de movimiento para <span class="math inline">\(\theta\)</span>. Como hicimos antes, vamos a “levantar” al espacio fase incluyendo el momento, que denotaremos como <span class="math inline">\(\rho\)</span>. La energía cinética, en el caso más simple, podemos definirla (en la práctica existen reescalamientos) como como <span class="math inline">\(T(\rho) =\frac{1}{2}\sum_i \rho_i^2\)</span> (la energía cinética es proporcional al momento cuadrado, pues el momento es masa por velocidad).</p>
<p>El Hamiltoniano por definición <span class="math inline">\(H(\rho, \theta) = T(\rho) + V(\theta)\)</span>, y las ecuaciones de Hamilton son las mismas que arriba, que en este caso nos dan</p>
<p><span class="math display">\[\frac{d\theta}{dt} = \rho, \frac{d\rho}{dt} = \nabla(\log(p(\theta)).\]</span></p>
<p>Si resolvemos estas ecuaciones, podemos entonces simular del sistema como sigue:</p>
<ol type="1">
<li>Dado un punto inicial <span class="math inline">\(\theta\)</span>, escogemos un momento inicial <span class="math inline">\(\rho\)</span> al azar, por ejemplo cada componente normal <span class="math inline">\(N(0,1)\)</span> (en la práctica existe un reescalamiento, pero en general queremos que <span class="math inline">\(p(\rho) = p(-\rho)\)</span>). Es decir, agregamos inicialmente una cantidad aleatoria de energía a la partícula.</li>
<li>Usando las ecuaciones de Hamilton, actualizamos la posición <span class="math inline">\(\theta\)</span> y el momento de la partícula un cierto tiempo <span class="math inline">\(t\)</span> fijo, de manera que no quedemos muy cerca del valor inicial, pero tampoco hagamos demasiado trabajo computacional.</li>
<li>La posición nueva <span class="math inline">\(\theta^*\)</span> es aceptada como nuestra nueva simulación (si el paso 2 es <em>exacto</em>, pero frecuentemente no lo es).</li>
<li>Repetimos los pasos 1-3 un número suficiente de veces para obtener simulaciones de la posterior.</li>
</ol>
<p>Este método produce simulaciones de la distribución objetivo bajo condiciones de regularidad. Podemos demostrar por ejemplo, que se cumple el balance detallado.</p>
</section>
<section id="balance-detallado-para-hmc" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="balance-detallado-para-hmc">Balance detallado para HMC</h3>
<p>Supongamos que las transiciones que da este sistema son <span class="math inline">\(q(y|x)\)</span>. Nótese que dado el momento simulado, tenemos el estado <span class="math inline">\((\rho, x)\)</span>, y la transición <span class="math inline">\(x\to\y\)</span> es determinista, gobernada por las ecuaciones de Hamilton. Escribimos la transición como <span class="math display">\[(\rho, x) \to (\rho^*, y).\]</span> Nótese que <span class="math inline">\(\rho\)</span> y <span class="math inline">\(x\)</span> determinan la transición, de modo que</p>
<p><span class="math display">\[p(x)q(y|x) = p(x)p(\rho) = \exp(-H(\rho, x)) = \exp(-H(\rho^*, y))\]</span> Que es cierto por conservación de la energía total y la transición sigue exactamente trayectorias del Hamiltoniano. Esta última cantidad, usando un argumento similar, es igual a</p>
<p><span class="math display">\[p(y)p(\rho^*) = p(y)p(-\rho^*) = p(y) q(x|y)\]</span> La segunda igualdad se da porque <span class="math inline">\(p(\rho)\)</span> es Gaussiana (simétrica). Y finalmente, la última igualdad se da porque si necesitamos momento <span class="math inline">\(\rho\)</span> para llegar de <span class="math inline">\(x\)</span> a <span class="math inline">\((\rho^*, y)\)</span>, entonces necesitamos <span class="math inline">\(-\rho^*\)</span> (volteamos la velocidad ifnal) para llegar de <span class="math inline">\(y\)</span> a <span class="math inline">\((\rho, x)\)</span>, pues el sistema físico es reversible.</p>
<p>Nótese que este argumento se rompe si por ejemplo si es imposible transicionar de un punto a otro (por ejemplo, cuando la distribución objetivo <span class="math inline">\(p\)</span> tiene dos regiones separadas de probabilidad positiva).</p>
</section>
<section id="integración-de-las-ecuaciones-de-hamilton" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="integración-de-las-ecuaciones-de-hamilton">Integración de las ecuaciones de Hamilton</h3>
<p>Para aproximar soluciones de estas ecuaciones diferenciales utilizamos el integrador <a href="https://en.wikipedia.org/wiki/Leapfrog_integration">leapfrog</a>, en el que hacemos actualizaciones alternadas de posición y momento con un tamaño de paso <span class="math inline">\(\epsilon\)</span> chico. Hacemos este paso un número <span class="math inline">\(L\)</span> de veces, para no quedar muy cerca del valor inicial.</p>
<p>En nuestro ejemplo, actualizaríamos por ejemplo el momento a la mitad del paso:</p>
<p><span class="math display">\[\rho_{t+\epsilon/2} = \rho_t - \frac{\epsilon}{2}\nabla(\log(p(\theta_t)))\]</span> Seguido de una actualización de la posición:</p>
<p><span class="math display">\[\theta_{t+\epsilon} = \theta_t + \epsilon \rho_{t+\epsilon/2}\]</span> y finalmente otra actualización del momento:</p>
<p><span class="math display">\[\rho_{t+\epsilon} = \rho_{t+\epsilon/2} - \frac{\epsilon}{2}\nabla(\log(p(\theta_{t+\epsilon})))\]</span> Al final de este proceso, encontraremos que por errores numéricos, quizá el Hamiltoniano varió un poco. Si esto sucede, podemos hacer un paso de aceptación y rechazo como en Metropolis Hastings, donde la probabilidad de aceptar es</p>
<p><span class="math display">\[\min\left(1, \exp(H(\rho,\theta) - H(\rho^{*},\theta^{*}))\right)\]</span> donde <span class="math inline">\(\rho^{*}\)</span> y <span class="math inline">\(\theta^{*}\)</span> son los valores de momento y posición nuevos y <span class="math inline">\(H(\rho,\theta)\)</span> es el Hamiltoniano en el paso anterior.</p>
<p><strong>Observaciones</strong>:</p>
<ol type="1">
<li>Un caso posible obtengamos desbordes o casi desbordes numéricos del momento o la posición (el Hamiltoniano en el punto inicial es órdenes de magnitud diferente que el inicial, ver <a href="https://mc-stan.org/docs/reference-manual/mcmc.html#divergent-transitions">el manual de Stan</a> ). Esto indica problemas graves con el algoritmo de integración, y en general marcamos estas iteraciones como <strong>divergentes</strong>. Estas fallas pueden producir, como veremos, exploración insuficiente de la distribución objetivo.</li>
<li>Si queremos usar HMC directamente, es delicado afinar el tamaño de paso, la distribución de propuesta para el momento, y el número de saltos <span class="math inline">\(L\)</span>. En Stan, que usa una variación de HMC, estos valores son ajustados en el periodo de calentamiento o <em>warmup</em>, antes de</li>
</ol>
</section>
<section id="ejemplo-hmc-en-una-distribución-normal-bivariada" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo-hmc-en-una-distribución-normal-bivariada">Ejemplo: HMC en una distribución normal bivariada</h3>
<p>Primero calculamos el gradiente que requerimos. En este caso, podemos hacerlo analíticamente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>construir_log_p <span class="ot">&lt;-</span> <span class="cf">function</span>(m, Sigma){</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  Sigma_inv <span class="ot">&lt;-</span> <span class="fu">solve</span>(Sigma)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(z){</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> (<span class="fu">t</span>(z<span class="sc">-</span>m) <span class="sc">%*%</span> Sigma_inv <span class="sc">%*%</span> (z<span class="sc">-</span>m))</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>Sigma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.8</span>, <span class="fl">0.8</span>, <span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>log_p <span class="ot">&lt;-</span> <span class="fu">construir_log_p</span>(m, Sigma)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># en diferenciación automática, el siguiente constructor</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># puede tomar como argumento log_p, pero aquí la escribimos</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co"># explícitamente</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>construir_grad_log_p <span class="ot">&lt;-</span> <span class="cf">function</span>(m, Sigma){</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  Sigma_inv <span class="ot">&lt;-</span> <span class="fu">solve</span>(Sigma)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(theta){</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span> Sigma_inv <span class="sc">%*%</span> (theta<span class="sc">-</span>m)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>grad_log_p <span class="ot">&lt;-</span> <span class="fu">construir_grad_log_p</span>(m, Sigma)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>construir_H <span class="ot">&lt;-</span> <span class="cf">function</span>(m, Sigma){</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  Sigma_inv <span class="ot">&lt;-</span> <span class="fu">solve</span>(Sigma)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(theta, rho){</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span> <span class="fu">log_p</span>(theta) <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">sum</span>(rho<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>H <span class="ot">&lt;-</span> <span class="fu">construir_H</span>(m, Sigma)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="fu">log_p</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]
[1,] -1.388889</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grad_log_p</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]
[1,]  2.777778
[2,] -2.222222</code></pre>
</div>
</div>
<p>Ahora, implementamos el algoritmo de HMC. Primero, definimos una función</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>hamilton_mc <span class="ot">&lt;-</span> <span class="cf">function</span>(n, <span class="at">theta_0 =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), log_p, grad_log_p, epsilon, L){</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">length</span>(theta_0)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  theta <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, p)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  theta[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> theta_0</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  rho <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, p)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  theta_completa <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n<span class="sc">*</span>L, p)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  theta_completa[<span class="dv">1</span>, <span class="dv">0</span>] <span class="ot">&lt;-</span> theta_0</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  rho_completa <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n<span class="sc">*</span>L, p) </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  indice_completa <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  rechazo <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n){</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    prop_rho <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    rho[i<span class="dv">-1</span>, ] <span class="ot">&lt;-</span> prop_rho</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    prop_theta <span class="ot">&lt;-</span> theta[i<span class="dv">-1</span>, ]</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>L){</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>      prop_rho <span class="ot">&lt;-</span> prop_rho <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> epsilon <span class="sc">*</span> <span class="fu">grad_log_p</span>(prop_theta)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>      prop_theta <span class="ot">&lt;-</span> prop_theta <span class="sc">+</span> epsilon <span class="sc">*</span> prop_rho </span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>      prop_rho  <span class="ot">&lt;-</span> prop_rho <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> epsilon <span class="sc">*</span> <span class="fu">grad_log_p</span>(prop_theta)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>      theta_completa[indice_completa,] <span class="ot">&lt;-</span> prop_theta</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>      rho_completa[indice_completa,] <span class="ot">&lt;-</span> prop_rho</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>      indice_completa <span class="ot">&lt;-</span> indice_completa <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    q <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="dv">1</span>, <span class="fu">exp</span>(<span class="fu">H</span>(theta[i<span class="dv">-1</span>, ], rho[i<span class="dv">-1</span>, ]) <span class="sc">-</span> </span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">H</span>(prop_theta, prop_rho))) </span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> q){</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>      theta[i, ] <span class="ot">&lt;-</span> prop_theta</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>      rechazo <span class="ot">&lt;-</span> rechazo <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>      theta[i, ] <span class="ot">&lt;-</span> theta[i<span class="dv">-1</span>, ]</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>      rho[i, ] <span class="ot">&lt;-</span> rho[i<span class="dv">-1</span>, ]</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>      theta_completa[indice_completa <span class="sc">-</span> <span class="dv">1</span>,] <span class="ot">&lt;-</span> theta[i<span class="dv">-1</span>, ]</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>      rho_completa[indice_completa <span class="sc">-</span> <span class="dv">1</span>,] <span class="ot">&lt;-</span> rho[i<span class="dv">-1</span>, ]</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(rechazo <span class="sc">/</span> n)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">sims =</span> <span class="fu">tibble</span>(<span class="at">x =</span> theta[,<span class="dv">1</span>], <span class="at">y =</span> theta[,<span class="dv">2</span>]),</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>       <span class="at">trayectorias =</span> <span class="fu">tibble</span>(<span class="at">x =</span> theta_completa[,<span class="dv">1</span>], <span class="at">y =</span> theta_completa[,<span class="dv">2</span>]) <span class="sc">|&gt;</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mutate</span>(<span class="at">iteracion =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">each =</span> L), <span class="at">paso =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>L, <span class="at">times =</span> n)))</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Revisamos que la muestra aproxima apropiadamente nuestra distribución</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>hmc_salida <span class="ot">&lt;-</span> <span class="fu">hamilton_mc</span>(<span class="dv">1000</span>, <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), log_p, grad_log_p, <span class="fl">0.2</span>, <span class="dv">12</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.016</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hmc_salida<span class="sc">$</span>sims, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">data =</span> sims_normal, <span class="fu">aes</span>(x, y), </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">level =</span> <span class="fu">c</span>(<span class="fl">0.9</span>), <span class="at">type =</span> <span class="st">"norm"</span>, <span class="at">colour =</span> <span class="st">"salmon"</span>) <span class="sc">+</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">data =</span> sims_normal, <span class="fu">aes</span>(x, y), </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">level =</span> <span class="fu">c</span>( <span class="fl">0.5</span>), <span class="at">type =</span> <span class="st">"norm"</span>, <span class="at">colour =</span> <span class="st">"salmon"</span>) <span class="sc">+</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">level =</span> <span class="fu">c</span>( <span class="fl">0.9</span>), <span class="at">colour =</span> <span class="st">"green"</span>, <span class="at">type =</span> <span class="st">"norm"</span>) <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">level =</span> <span class="fu">c</span>( <span class="fl">0.5</span>), <span class="at">colour =</span> <span class="st">"green"</span>, <span class="at">type =</span> <span class="st">"norm"</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>tray_tbl <span class="ot">&lt;-</span> hmc_salida<span class="sc">$</span>trayectorias</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tray_tbl)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
        x      y iteracion  paso
    &lt;dbl&gt;  &lt;dbl&gt;     &lt;int&gt; &lt;int&gt;
1  0      0              1     1
2 -0.0185 0.0409         1     2
3 -0.0757 0.231          1     3
4 -0.148  0.545          1     4
5 -0.201  0.940          1     5
6 -0.192  1.37           1     6</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>anim_hmc <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(tray_tbl <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">iter =</span> <span class="dv">4</span><span class="sc">*</span><span class="fu">as.numeric</span>(paso <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">s =</span> <span class="fu">as.numeric</span>(paso <span class="sc">==</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">filter</span>(iteracion <span class="sc">&lt;</span> <span class="dv">30</span>) <span class="sc">|&gt;</span> </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mutate</span>(<span class="at">tiempo =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mutate</span>(<span class="at">tiempo =</span> tiempo <span class="sc">+</span> <span class="fu">cumsum</span>(<span class="dv">50</span> <span class="sc">*</span> s)), </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span> </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> iter, <span class="at">alpha =</span> iter, <span class="at">size =</span> iter, <span class="at">group =</span> tiempo)) <span class="sc">+</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_path</span>(<span class="at">colour =</span> <span class="st">"gray"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transition_reveal</span>(tiempo) <span class="sc">+</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  elipses_normal <span class="sc">+</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) </span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="fu">anim_save</span>(<span class="at">animation =</span> anim_hmc, <span class="at">filename =</span> <span class="st">"figuras/hmc-normal.gif"</span>, </span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>())</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figuras/hmc-normal.gif" class="img-fluid figure-img"></p>
<figcaption>HMC</figcaption>
</figure>
</div>
<p><strong>Observaciones</strong>:</p>
<ul>
<li>Nótese que ahora podemos dar pasos más grandes a lo largo de los lugares donde concentra mayor probabilidad.</li>
<li>Esto implica dos cosas: evitamos el comportamiento de caminata aleatoria (pasos muy cortos), y también tasas de rechazo alto (cuando los pasos son muy grandes en HMC)</li>
<li>El algoritmo utiliza información adicional: además de calcular la posterior, como en metropolis, es necesario calcular también el gradiente de la posterior.</li>
<li>Este algoritmo hace más trabajo para cada iteración (requiere la integración leapfrog), pero cada iteración es más informativa</li>
<li>Bien afinado, funciona para problemas de dimensión alta (cientos o miles de parámetros), donde geométricamente la densidad está concentrada en un espacio geométricamente chico. Existen todavía dificultades que discutiremos en otros modelos más adelante.</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Observamos que hasta ahora no hemos aplicado estos algoritmos para simular de la posterior de un modelo: hemos tomado distribuciones fijas y usamos MCMC para simular de ellas. El proceso para una posterior es el mismo, pero usualmente más complicado pues generalmente involucra mucho más parámetros y una posterior que no tiene una forma analítica conocida.</p>
<p>Sin embargo, la aplicación para una posterior es la misma: siempre podemos calcular el logaritmo de la posterior (al menos hasta una constante de proporcionalidad), y siempre podemos usar diferenciación automática para calcular el gradiente de la log posterior. Podemos aplicar entonces HMC o Metropolis.</p>
</div>
</div>
</section>
<section id="comparación-de-hmc-y-metropolis" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="comparación-de-hmc-y-metropolis">Comparación de HMC y Metropolis</h3>
<p>Finalmente, haremos una comparación entre el desempeño de HMC y Metropolis en el caso de la distribución normal. Utilizaremos otra normal bivariada con más correlación.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">737</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>Sigma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="fl">0.9</span>, <span class="sc">-</span><span class="fl">0.9</span>, <span class="dv">1</span>), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>log_p <span class="ot">&lt;-</span> <span class="fu">construir_log_p</span>(m, Sigma)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>grad_log_p <span class="ot">&lt;-</span> <span class="fu">construir_grad_log_p</span>(m, Sigma)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(hmc_1 <span class="ot">&lt;-</span> <span class="fu">hamilton_mc</span>(<span class="dv">1000</span>, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), log_p, grad_log_p, <span class="fl">0.2</span>, <span class="dv">12</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.042</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.063   0.000   0.063 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(metropolis_1 <span class="ot">&lt;-</span> <span class="fu">metropolis_mc</span>(<span class="dv">1000</span>, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), log_p, <span class="fl">0.2</span>, <span class="fl">0.2</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.204</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.017   0.000   0.018 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(metropolis_2 <span class="ot">&lt;-</span> <span class="fu">metropolis_mc</span>(<span class="dv">1000</span>, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), log_p, <span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.692</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.018   0.000   0.018 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>sims_hmc <span class="ot">&lt;-</span> hmc_1<span class="sc">$</span>sims <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">n_sim =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">algoritmo =</span> <span class="st">"hmc"</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>sims_metropolis_1 <span class="ot">&lt;-</span> metropolis_1 <span class="sc">|&gt;</span> </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">algoritmo =</span> <span class="st">"metropolis (corto)"</span>) </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>sims_metropolis_2 <span class="ot">&lt;-</span> metropolis_2 <span class="sc">|&gt;</span> </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">algoritmo =</span> <span class="st">"metropolis (largo)"</span>) </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>sims_comp <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sims_hmc, sims_metropolis_1, sims_metropolis_2)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>anim_comp <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(sims_comp <span class="sc">|&gt;</span> <span class="fu">filter</span>(n_sim <span class="sc">&lt;</span> <span class="dv">200</span>)) <span class="sc">+</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transition_reveal</span>(n_sim) <span class="sc">+</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(x, y), <span class="at">colour =</span> <span class="st">"gray"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span> </span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(x, y, <span class="at">group =</span> n_sim)) <span class="sc">+</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>algoritmo)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="fu">anim_save</span>(<span class="at">animation =</span> anim_comp, <span class="at">filename =</span> <span class="st">"figuras/comparacion-normal.gif"</span>, <span class="at">height =</span> <span class="dv">250</span>, <span class="at">width =</span> <span class="dv">500</span>,</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">units =</span> <span class="st">"px"</span>,</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>())</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figuras/comparacion-normal.gif" class="img-fluid figure-img"></p>
<figcaption>Comparación</figcaption>
</figure>
</div>
</section>
<section id="hmc-en-stan" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="hmc-en-stan">HMC en Stan</h3>
<p>En Stan se incluyen tres componentes adicionales importantes para estimar posteriores de manera eficiente:</p>
<ol type="1">
<li>Periodos de <em>warm-up</em> (calentamiento) y <em>sampling</em> (muestreo). En el periodo de calentamiento, el muestreador afina tamaños de paso, escalamiento de la distribución de propuesta (normal multivariada), y otros parámetros de manera automática.</li>
<li>Implementación de <a href="https://en.wikipedia.org/wiki/Automatic_differentiation">diferenciación automática</a> para no tener que calcular el grandiente de la log posterior directamente. A partir del código que damos, se crean automáticamente funciones que calculan el grandiente (no es una aproximación numérica).</li>
<li>Implementación de HMC sin vueltas en U (NUTS): una afinación adicional es dinámicamente adaptar el número de pasos de integración para evitar “regresos”, como vimos que sucedía en los ejemplos de arriba. Ver por ejemplo <a href="https://elevanth.org/blog/2017/11/28/build-a-better-markov-chain/">aquí</a>, o la documentación de Stan.</li>
</ol>
</section>
</section>
<section id="diagnósticos-de-convergencia" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="diagnósticos-de-convergencia"><span class="header-section-number">8.3</span> Diagnósticos de convergencia</h2>
<p>Aunque casi nunca es posible demostrar rigurosamente que las simulaciones de un algoritmo MCMC dan buena aproximación de la distribución posterior de interés, especialmente con HMC y NUTS, tenemos muchos diagnósticos que fallan cuando existen problemas serios.</p>
<p>En primer lugar, será útil correr distintas cadenas con valores iniciales aleatorios diferentes, analizamos cada una y las comparamos entre sí. Recordamos que cada una de estas cadenas tiene como distribución estacionaria límite la distribución posterior. Diagnósticos que indican que las cadenas se comportan de manera muy distinta, explorando distintas regiones del espacio de parámetros, o que no han convergido porque exploran lentamente el espacio de parámetros, son señales de problemas.</p>
<p>Los diagnósticos más comunes son:</p>
<ol type="1">
<li>Traza de cadenas</li>
<li>Medida R-hat de convergencia: mide la variabilidad entre cadenas y dentro de cadenas.</li>
<li>Número de muestras efectivas (ESS) y autocorrelación.</li>
<li>Transiciones divergentes.</li>
</ol>
<section id="modelos-con-variables-latentes" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="modelos-con-variables-latentes">Modelos con variables latentes</h3>
<p>Veremos el ejemplo de calificación de vinos de distintos países de <span class="citation" data-cites="rethinking">McElreath (<a href="#ref-rethinking" role="doc-biblioref">2020</a>)</span>, sus diagnósticos, y aprovecharemos para introducir variables no observadas o latentes para enriquecer nuestras herramientas de modelación.</p>
<p>Nuestra pregunta general es si el país de origen de los vinos influye en su calidad. Los datos que tenemos son calificaciones de vinos de distintos países por distintos jueces. La <em>calidad</em> del vino no la observamos directamente, sino que es causa de las calificaciones que recibe. Para construir nuestro diagrama, las consideraciones básicas son:</p>
<ol type="1">
<li>El origen del vino es una causa del calidad del vino (es nuestra cantidad a estimar).</li>
<li>Los jueces tienen distintas maneras de calificar, de manera que son causa de variación en las calificaciones (hay jueces más duros, otros más barcos, etc.) No observamos directamente que tan “duro” es cada juez.</li>
<li>Los jueces califican vinos de distintos países de manera ciega. Sin embargo es posible que reconozcan el país de origen por las características de los vinos, de manera que puede existir un efecto directo de Origen en Calificación (no pasa por Calidad).</li>
<li>Es posible que Jueces de distintos países tienen distintos estándares de calificación.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DiagrammeR)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">"</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2, rankdir = LR]</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="st">    Origen</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="st">    Score</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="st">    Origen_Juez</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape = circle]</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="st">    Q</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="st">    J</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="st">    Origen -&gt; Q</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="st">    Origen -&gt; Score</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="st">    Q -&gt; Score</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="st">    J -&gt; Score</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="st">    Origen_Juez -&gt; J</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-6cbc281c701078736e66" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-6cbc281c701078736e66">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2, rankdir = LR]\n  node [shape=plaintext]\n    Origen\n    Score\n    Origen_Juez\n  node [shape = circle]\n    Q\n    J\n  edge [minlen = 3]\n    Origen -> Q\n    Origen -> Score\n    Q -> Score\n    J -> Score\n    Origen_Juez -> J\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Y vemos, por nuestro análisis del DAG, que podemos identificar el efecto de Origen sobre Calidad sin necesidad de estratificar por ninguna variable (no hay puertas traseras). Sin embaergo, podemos estratificar por Juez para obtener más precisión (ver sección anterior de buenos y malos controles).</p>
<section id="primera-iteración-modelo-simple" class="level4" data-number="8.3.0.1">
<h4 data-number="8.3.0.1" class="anchored" data-anchor-id="primera-iteración-modelo-simple"><span class="header-section-number">8.3.0.1</span> Primera iteración: modelo simple</h4>
<p>Comenzamos con un modelo simple, y lo iremos construyendo para obtener la mejor estimación posible de la influencia del país de origen en la calidad del vino. Nuestro primer modelo consideramos que la calificación de cada vino depende de su calidad, y modelamos con una normal:</p>
<p><span class="math display">\[S_i \sim \text{Normal}(\mu_i, \sigma)\]</span> donde <span class="math display">\[\mu_i = Q_{vino(i)}\]</span>. Nuestra medida de calidad tiene escala arbitaria. Como usaremos la calificación estandarizada, podemos poner <span class="math display">\[Q_j \sim \text{Normal}(0, 1).\]</span> finalmente, ponemos una inicial para <span class="math inline">\(\sigma\)</span>, por ejemplo <span class="math inline">\(\sigma \sim \text{Exponential}(1)\)</span> (puedes experimentar con una normal truncada también)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>This is cmdstanr version 0.7.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan path: /home/runner/.cmdstan/cmdstan-2.34.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan version: 2.34.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
A newer version of CmdStan is available. See ?install_cmdstan() to install it.
To disable this check set option or environment variable CMDSTANR_NO_VER_CHECK=TRUE.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>mod_vinos_1 <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/vinos-1.stan"</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_vinos_1)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N; //número de calificaciones
  int&lt;lower=0&gt; n_vinos; //número de vinos
  int&lt;lower=0&gt; n_jueces; //número de jueces
  vector[N]  S;
  array[N]  int juez;
  array[N]  int vino;
}

parameters {
  vector[n_vinos] Q;
  real &lt;lower=0&gt; sigma;
}

transformed parameters {
  vector[N] media_score;
  // determinístico dado parámetros
  for (i in 1:N){
    media_score[i] = Q[vino[i]];
  }
}

model {
  // partes no determinísticas
  S ~ normal(media_score, sigma);
  Q ~ std_normal();
  sigma ~ exponential(1);
}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wines 2022 de Statistical Rethinking</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>wines_2012 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../datos/wines_2012.csv"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 180 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (3): judge, flight, wine
dbl (3): score, wine.amer, judge.amer

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(wines_2012)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 180
Columns: 6
$ judge      &lt;chr&gt; "Jean-M Cardebat", "Jean-M Cardebat", "Jean-M Cardebat", "J…
$ flight     &lt;chr&gt; "white", "white", "white", "white", "white", "white", "whit…
$ wine       &lt;chr&gt; "A1", "B1", "C1", "D1", "E1", "F1", "G1", "H1", "I1", "J1",…
$ score      &lt;dbl&gt; 10.0, 13.0, 14.0, 15.0, 8.0, 13.0, 15.0, 11.0, 9.0, 12.0, 1…
$ wine.amer  &lt;dbl&gt; 1, 1, 0, 0, 1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 0,…
$ judge.amer &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>wines_2012 <span class="ot">&lt;-</span> wines_2012 <span class="sc">|&gt;</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">juez_num =</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(judge)),</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">vino_num =</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(wine))) <span class="sc">|&gt;</span> </span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">score_est =</span> (score <span class="sc">-</span> <span class="fu">mean</span>(score))<span class="sc">/</span><span class="fu">sd</span>(score))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>n_jueces <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(wines_2012<span class="sc">$</span>juez_num))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>n_vinos <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(wines_2012<span class="sc">$</span>vino_num))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="st">"num_vinos"</span> <span class="ot">=</span> n_jueces, <span class="st">"num_jueces"</span> <span class="ot">=</span> n_vinos, <span class="st">"num_datos"</span> <span class="ot">=</span> <span class="fu">nrow</span>(wines_2012))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num_vinos num_jueces  num_datos 
         9         20        180 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>datos_lst <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(wines_2012),</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_vinos =</span> n_vinos,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_jueces =</span> n_jueces,</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> wines_2012<span class="sc">$</span>score_est,</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">vino =</span> wines_2012<span class="sc">$</span>vino_num,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">juez =</span> wines_2012<span class="sc">$</span>juez_num</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_1 <span class="ot">&lt;-</span> mod_vinos_1<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> datos_lst,</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">2000</span>,</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">1000</span>,</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">step_size =</span> <span class="fl">0.1</span>,</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 1 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 1 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 2 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 2 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 2 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 3 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 3 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 3 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 4 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 4 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 4 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 1 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 1 finished in 0.3 seconds.
Chain 3 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 3 finished in 0.4 seconds.
Chain 2 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 4 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 2 finished in 0.4 seconds.
Chain 4 finished in 0.4 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.4 seconds.
Total execution time: 0.6 seconds.</code></pre>
</div>
</div>
<p>Vemos que hay variabilidad en los vinos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_1<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"Q"</span>, <span class="st">"sigma"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, q5, q95, rhat, ess_bulk, ess_tail) <span class="sc">|&gt;</span> </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">!=</span> <span class="st">"lp__"</span>) <span class="sc">|&gt;</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(mean, sd, q5, q95, rhat, ess_bulk, ess_tail), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Q[1]</td>
<td style="text-align: right;">0.137</td>
<td style="text-align: right;">0.317</td>
<td style="text-align: right;">-0.396</td>
<td style="text-align: right;">0.672</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">20694.09</td>
<td style="text-align: right;">5373.128</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[2]</td>
<td style="text-align: right;">0.103</td>
<td style="text-align: right;">0.321</td>
<td style="text-align: right;">-0.425</td>
<td style="text-align: right;">0.629</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">20994.93</td>
<td style="text-align: right;">5362.172</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[3]</td>
<td style="text-align: right;">0.271</td>
<td style="text-align: right;">0.318</td>
<td style="text-align: right;">-0.247</td>
<td style="text-align: right;">0.798</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20676.69</td>
<td style="text-align: right;">5913.964</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[4]</td>
<td style="text-align: right;">0.555</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">0.043</td>
<td style="text-align: right;">1.069</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18730.09</td>
<td style="text-align: right;">5575.563</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[5]</td>
<td style="text-align: right;">-0.120</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">-0.636</td>
<td style="text-align: right;">0.390</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">19760.24</td>
<td style="text-align: right;">5848.199</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[6]</td>
<td style="text-align: right;">-0.370</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">-0.880</td>
<td style="text-align: right;">0.145</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">16654.60</td>
<td style="text-align: right;">5972.842</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[7]</td>
<td style="text-align: right;">0.286</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-0.231</td>
<td style="text-align: right;">0.795</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17442.52</td>
<td style="text-align: right;">6084.769</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[8]</td>
<td style="text-align: right;">0.271</td>
<td style="text-align: right;">0.319</td>
<td style="text-align: right;">-0.256</td>
<td style="text-align: right;">0.805</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18199.26</td>
<td style="text-align: right;">5596.789</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[9]</td>
<td style="text-align: right;">0.080</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-0.438</td>
<td style="text-align: right;">0.584</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">19534.73</td>
<td style="text-align: right;">5983.451</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[10]</td>
<td style="text-align: right;">0.118</td>
<td style="text-align: right;">0.308</td>
<td style="text-align: right;">-0.386</td>
<td style="text-align: right;">0.626</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">21143.80</td>
<td style="text-align: right;">5814.923</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[11]</td>
<td style="text-align: right;">-0.010</td>
<td style="text-align: right;">0.321</td>
<td style="text-align: right;">-0.546</td>
<td style="text-align: right;">0.510</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20940.00</td>
<td style="text-align: right;">5531.936</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[12]</td>
<td style="text-align: right;">-0.029</td>
<td style="text-align: right;">0.322</td>
<td style="text-align: right;">-0.560</td>
<td style="text-align: right;">0.500</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">18276.46</td>
<td style="text-align: right;">5849.228</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[13]</td>
<td style="text-align: right;">-0.105</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">-0.609</td>
<td style="text-align: right;">0.414</td>
<td style="text-align: right;">1.003</td>
<td style="text-align: right;">20575.88</td>
<td style="text-align: right;">5957.570</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[14]</td>
<td style="text-align: right;">0.005</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">-0.505</td>
<td style="text-align: right;">0.525</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17541.60</td>
<td style="text-align: right;">5723.524</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[15]</td>
<td style="text-align: right;">-0.215</td>
<td style="text-align: right;">0.318</td>
<td style="text-align: right;">-0.740</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17150.01</td>
<td style="text-align: right;">5412.980</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[16]</td>
<td style="text-align: right;">-0.201</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">-0.722</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17596.06</td>
<td style="text-align: right;">5120.461</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[17]</td>
<td style="text-align: right;">-0.142</td>
<td style="text-align: right;">0.316</td>
<td style="text-align: right;">-0.665</td>
<td style="text-align: right;">0.379</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20718.38</td>
<td style="text-align: right;">6172.910</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[18]</td>
<td style="text-align: right;">-0.860</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-1.384</td>
<td style="text-align: right;">-0.343</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18745.31</td>
<td style="text-align: right;">6126.091</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[19]</td>
<td style="text-align: right;">-0.161</td>
<td style="text-align: right;">0.311</td>
<td style="text-align: right;">-0.666</td>
<td style="text-align: right;">0.343</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18166.25</td>
<td style="text-align: right;">6352.717</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[20]</td>
<td style="text-align: right;">0.380</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">-0.127</td>
<td style="text-align: right;">0.896</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">21072.45</td>
<td style="text-align: right;">5060.363</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">0.997</td>
<td style="text-align: right;">0.054</td>
<td style="text-align: right;">0.912</td>
<td style="text-align: right;">1.092</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">13245.07</td>
<td style="text-align: right;">6385.483</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</section>
</section>
<section id="diagnóstico-trazas-de-cadenas" class="level3" data-number="8.3.1">
<h3 data-number="8.3.1" class="anchored" data-anchor-id="diagnóstico-trazas-de-cadenas"><span class="header-section-number">8.3.1</span> Diagnóstico: Trazas de cadenas</h3>
<p>Para hacer diagnósticos, podemos comenzar con las trazas de una cadena para todas las estimaciones de calidad de vino. Cada cadena se inicia con distintos valores aleatorios, pero cumplen en teoría que su distribución de equilibrio es la posterior de interés pues sus transiciones usan el mismo mecanismo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(ajuste_vinos_1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"Q"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> <span class="fu">filter</span>(.chain <span class="sc">==</span> <span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>La traza de una cadena es la gráfica de las simulaciones de cada parámetro. Generalmente buscamos que: no tenga tendencia, que no se quede “atorada” en algunos valores, y que no muestre oscilaciones de baja frecuencia (la cadena “vaga” por los valores que explora).</p>
</div>
</div>
<p>Si incluímos todas las cadenas, nos fijemos en que todas ellas exploren regiones similares del espacio de parámetros:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">color_scheme_set</span>(<span class="st">"viridis"</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(ajuste_vinos_1<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"Q"</span>, <span class="at">format =</span> <span class="st">"df"</span>)) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Lo que no queremos ver es lo siguiente, por ejemplo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_malo <span class="ot">&lt;-</span> mod_vinos_1<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> datos_lst,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">5</span>,</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">100</span>,</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">1000</span>,</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">step_size =</span><span class="dv">1</span> ,</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 WARNING: No variance estimation is 
Chain 1          performed for num_warmup &lt; 20 
Chain 1 Iteration:   1 / 105 [  0%]  (Warmup) 
Chain 1 Iteration:   6 / 105 [  5%]  (Sampling) 
Chain 1 Iteration: 105 / 105 [100%]  (Sampling) 
Chain 2 WARNING: No variance estimation is 
Chain 2          performed for num_warmup &lt; 20 
Chain 2 Iteration:   1 / 105 [  0%]  (Warmup) 
Chain 2 Iteration:   6 / 105 [  5%]  (Sampling) 
Chain 2 Iteration: 105 / 105 [100%]  (Sampling) 
Chain 3 WARNING: No variance estimation is 
Chain 3          performed for num_warmup &lt; 20 
Chain 3 Iteration:   1 / 105 [  0%]  (Warmup) 
Chain 3 Iteration:   6 / 105 [  5%]  (Sampling) 
Chain 3 Iteration: 105 / 105 [100%]  (Sampling) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: normal_lpdf: Scale parameter is 0, but must be positive! (in '/tmp/Rtmp3xJGaj/model-4f9b132aaddd.stan', line 25, column 2 to column 33)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 WARNING: No variance estimation is 
Chain 4          performed for num_warmup &lt; 20 
Chain 4 Iteration:   1 / 105 [  0%]  (Warmup) 
Chain 4 Iteration:   6 / 105 [  5%]  (Sampling) 
Chain 4 Iteration: 105 / 105 [100%]  (Sampling) 
Chain 1 finished in 0.0 seconds.
Chain 2 finished in 0.0 seconds.
Chain 3 finished in 0.0 seconds.
Chain 4 finished in 0.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.0 seconds.
Total execution time: 0.2 seconds.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 324 of 400 (81.0%) transitions ended with a divergence.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 2 of 4 chains had an E-BFMI less than 0.3.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">color_scheme_set</span>(<span class="st">"viridisA"</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(ajuste_vinos_malo<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"Q"</span>, <span class="at">format =</span> <span class="st">"df"</span>)) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Hay varios problemas graves:</p>
<ul>
<li>Algunas cadenas parecen “atoradas” en ciertos valores</li>
<li>Algunas cadenas parecen caminatas aleatorias (oscilaciones de baja frecuencia)</li>
<li>Las cadenas no exploran de manera similar el espacio de parámetros</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Traza de cadenas
</div>
</div>
<div class="callout-body-container callout-body">
<p>El diagnóstico de traza consiste en graficar las cadenas de los parámetros en el orden de la iteración. Buscamos ver que:</p>
<ol type="1">
<li>Las cadenas no tienen tendencia o oscilaciones de frecuencia muy baja.</li>
<li>Las cadenas no se atoran en valores específicos.</li>
<li>Las distintas cadenas exploran de manera similar el espacio de parámetros.</li>
</ol>
<p>Cuando falla alguna de estas, en el mejor de los casos las cadenas son ineficientes (veremos que requerimos un número mucho mayor de iteraciones), y en el peor de los casos dan resultados sesgados que no son confiables.</p>
</div>
</div>
</section>
<section id="diagnóstico-valores-r-hat" class="level3" data-number="8.3.2">
<h3 data-number="8.3.2" class="anchored" data-anchor-id="diagnóstico-valores-r-hat"><span class="header-section-number">8.3.2</span> Diagnóstico: valores R-hat</h3>
<p>Cuando nuestro método de simulación converge a la distribución posterior, esperamos que las cadenas, durante todo su proceso, exploran la misma región del espacio de parámetros.</p>
<p>Podemos entonces considerar, para cada parámetro:</p>
<ul>
<li>Cuánta variación hay en cada cadena.</li>
<li>Qué tan distintas son las cadenas entre ellas.</li>
</ul>
<p>Esperamos que la variación entre cadenas es chica, y la variación dentro de cada cadena es similar para todas las cadenas. Calculamos entonces un cociente de varianzas: la varianza total sobre todas las simulaciones de todas las cadenas, y el promedio de varianzas de las cadenas. Si las cadenas están explorando regiones similares, esperamos que este cociente de varianzas sea cercano a 1.</p>
<p>Escribiremos ahora esta idea para entender cómo se calculan estas cantidades. Supongamos que cada cadena se denota por <span class="math inline">\(\theta_m\)</span>, para <span class="math inline">\(M\)</span> cadenas, y las iteraciones de cada cadena son <span class="math inline">\(\theta_m^{(i)}\)</span> para <span class="math inline">\(i=1,\ldots, N\)</span> iteraciones. Definimos (ver <a href="https://mc-stan.org/docs/">el manual de Stan</a> o <span class="citation" data-cites="handbookmc">Brooks et&nbsp;al. (<a href="#ref-handbookmc" role="doc-biblioref">2011</a>)</span> por ejemplo) primero la varianza entre cadenas, que es (ojo: usaremos definiciones aproximadas para entender más fácilmente):</p>
<p><span class="math display">\[b=\frac{1}{M-1}\sum_{m=1}^M (\bar{\theta}_m - \bar{\theta})^2\]</span> donde <span class="math inline">\(\bar{\theta}_m\)</span> es el promedio de las iteraciones de la cadena <span class="math inline">\(m\)</span>, y <span class="math inline">\(\bar{\theta}\)</span> es el promedio del las <span class="math inline">\(\bar{\theta}_m\)</span>.</p>
<p>Definimos también la varianza dentro de las cadenas, que es el promedio de la varianza de cada cadena:</p>
<p><span class="math display">\[w=\frac{1}{M}\sum_{m=1}^M \frac{1}{N}\sum_{i=1}^N (\theta_m^{(i)} - \bar{\theta}_m)^2\]</span> Finalmente, la <span class="math inline">\(R\)</span>-hat, o estadística de <em>potencial de reducción de escala</em>, es (para <span class="math inline">\(N\)</span> grande),</p>
<p><span class="math display">\[\hat{R} = \sqrt{\frac{b+w}{w}}\]</span></p>
<p>Buscamos entonces que este valor <strong>sea cercano a 1</strong>. Si es mayor a 1.05, es señal de posibles problemas de convergencia (pocas iteraciones u otras fallas en la convergencia). Si es menor que 1.01, generalmente decimos que “pasamos” esta prueba. Esto <em>no es garantía</em> de que la convergencia se ha alcanzado: la primera razón es que este diagnóstico, por ejemplo, sólo considera media y varianza, de forma que en principio podríamos pasar esta prueba aún cuando las cadenas tengan comportamiento distinto en otras estadísticas de orden más alto (por ejemplo, una cadena que oscila poco y de vez en cuando salta a un atípico vs otra que tiene variación moderada pueden ser similares en medias y varianzas).</p>
<p>En Stan, adicionalmente, se divide cada cadena en dos mitades, y el análisis se hace sobre <span class="math inline">\(2M\)</span> medias cadenas. Esto ayuda a detectar por ejemplo problemas donde una cadena sube y luego baja, por ejemplo, de modo que puede tener el mismo promedio que otras que exploran correctamente.</p>
<p><strong>Nota</strong>: Estas fórmulas pretenden explicar de manera simple el concepto de <span class="math inline">\(R\)</span>-hat, y son correctas para <span class="math inline">\(N\)</span> grande, lo cual casi siempre es el caso (al menos <span class="math inline">\(N\geq 100\)</span>). Puedes consultar una definición más estándar con correcciones por grados de libertad en el manual de Stan o cualquier libro de MCMC.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Diagnóstico de R-hat
</div>
</div>
<div class="callout-body-container callout-body">
<p>El diagnóstico de R-hat compara la varianza dentro de las cadenas y de cadena a cadena. Cuando este valor es relativamente grande (por ejemplo mayor a 1.05), es señal de que las cadenas no han explorado apropiadamente el espacio de parámetros (o decimos que no están “mezclando”). En general, buscamos que este valor sea menor a 1.02.</p>
<p>Se llama también potencial de reducción a escala porque busca indicar cuánto se podría reducir la varianza de la distribución actual si dejáramos correr las cadenas por más iteraciones (pues a largo plazo no debe haber varianza entre cadenas).</p>
</div>
</div>
<p>En nuestro ejemplo apropiado, observamos valores muy cercanos a 1 para todos los parámetros:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_1<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"Q"</span>, <span class="st">"sigma"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, q5, q95, rhat, ess_bulk, ess_tail) <span class="sc">|&gt;</span> </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(mean, sd, q5, q95, rhat, ess_bulk, ess_tail), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">!=</span> <span class="st">"lp__"</span>) <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Q[1]</td>
<td style="text-align: right;">0.137</td>
<td style="text-align: right;">0.317</td>
<td style="text-align: right;">-0.396</td>
<td style="text-align: right;">0.672</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">20694.09</td>
<td style="text-align: right;">5373.128</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[2]</td>
<td style="text-align: right;">0.103</td>
<td style="text-align: right;">0.321</td>
<td style="text-align: right;">-0.425</td>
<td style="text-align: right;">0.629</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">20994.93</td>
<td style="text-align: right;">5362.172</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[3]</td>
<td style="text-align: right;">0.271</td>
<td style="text-align: right;">0.318</td>
<td style="text-align: right;">-0.247</td>
<td style="text-align: right;">0.798</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20676.69</td>
<td style="text-align: right;">5913.964</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[4]</td>
<td style="text-align: right;">0.555</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">0.043</td>
<td style="text-align: right;">1.069</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18730.09</td>
<td style="text-align: right;">5575.563</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[5]</td>
<td style="text-align: right;">-0.120</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">-0.636</td>
<td style="text-align: right;">0.390</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">19760.24</td>
<td style="text-align: right;">5848.199</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[6]</td>
<td style="text-align: right;">-0.370</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">-0.880</td>
<td style="text-align: right;">0.145</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">16654.60</td>
<td style="text-align: right;">5972.842</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[7]</td>
<td style="text-align: right;">0.286</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-0.231</td>
<td style="text-align: right;">0.795</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17442.52</td>
<td style="text-align: right;">6084.769</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[8]</td>
<td style="text-align: right;">0.271</td>
<td style="text-align: right;">0.319</td>
<td style="text-align: right;">-0.256</td>
<td style="text-align: right;">0.805</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18199.26</td>
<td style="text-align: right;">5596.789</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[9]</td>
<td style="text-align: right;">0.080</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-0.438</td>
<td style="text-align: right;">0.584</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">19534.73</td>
<td style="text-align: right;">5983.451</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[10]</td>
<td style="text-align: right;">0.118</td>
<td style="text-align: right;">0.308</td>
<td style="text-align: right;">-0.386</td>
<td style="text-align: right;">0.626</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">21143.80</td>
<td style="text-align: right;">5814.923</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[11]</td>
<td style="text-align: right;">-0.010</td>
<td style="text-align: right;">0.321</td>
<td style="text-align: right;">-0.546</td>
<td style="text-align: right;">0.510</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20940.00</td>
<td style="text-align: right;">5531.936</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[12]</td>
<td style="text-align: right;">-0.029</td>
<td style="text-align: right;">0.322</td>
<td style="text-align: right;">-0.560</td>
<td style="text-align: right;">0.500</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">18276.46</td>
<td style="text-align: right;">5849.228</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[13]</td>
<td style="text-align: right;">-0.105</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">-0.609</td>
<td style="text-align: right;">0.414</td>
<td style="text-align: right;">1.003</td>
<td style="text-align: right;">20575.88</td>
<td style="text-align: right;">5957.570</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[14]</td>
<td style="text-align: right;">0.005</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">-0.505</td>
<td style="text-align: right;">0.525</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17541.60</td>
<td style="text-align: right;">5723.524</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[15]</td>
<td style="text-align: right;">-0.215</td>
<td style="text-align: right;">0.318</td>
<td style="text-align: right;">-0.740</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17150.01</td>
<td style="text-align: right;">5412.980</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[16]</td>
<td style="text-align: right;">-0.201</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">-0.722</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17596.06</td>
<td style="text-align: right;">5120.461</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[17]</td>
<td style="text-align: right;">-0.142</td>
<td style="text-align: right;">0.316</td>
<td style="text-align: right;">-0.665</td>
<td style="text-align: right;">0.379</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20718.38</td>
<td style="text-align: right;">6172.910</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[18]</td>
<td style="text-align: right;">-0.860</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-1.384</td>
<td style="text-align: right;">-0.343</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18745.31</td>
<td style="text-align: right;">6126.091</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[19]</td>
<td style="text-align: right;">-0.161</td>
<td style="text-align: right;">0.311</td>
<td style="text-align: right;">-0.666</td>
<td style="text-align: right;">0.343</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18166.25</td>
<td style="text-align: right;">6352.717</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[20]</td>
<td style="text-align: right;">0.380</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">-0.127</td>
<td style="text-align: right;">0.896</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">21072.45</td>
<td style="text-align: right;">5060.363</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">0.997</td>
<td style="text-align: right;">0.054</td>
<td style="text-align: right;">0.912</td>
<td style="text-align: right;">1.092</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">13245.07</td>
<td style="text-align: right;">6385.483</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>En nuestro ejemplo “malo”, obtenemos valores no aceptabels de R-hat para varios parámetros.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_malo<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"Q"</span>, <span class="st">"sigma"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, q5, q95, rhat, ess_bulk, ess_tail) <span class="sc">|&gt;</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(mean, sd, q5, q95, rhat, ess_bulk, ess_tail), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">!=</span> <span class="st">"lp__"</span>) <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Q[1]</td>
<td style="text-align: right;">-0.167</td>
<td style="text-align: right;">0.345</td>
<td style="text-align: right;">-0.538</td>
<td style="text-align: right;">0.427</td>
<td style="text-align: right;">2.367</td>
<td style="text-align: right;">5.335</td>
<td style="text-align: right;">4.502</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[2]</td>
<td style="text-align: right;">-0.012</td>
<td style="text-align: right;">0.289</td>
<td style="text-align: right;">-0.306</td>
<td style="text-align: right;">0.556</td>
<td style="text-align: right;">1.633</td>
<td style="text-align: right;">7.010</td>
<td style="text-align: right;">4.670</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[3]</td>
<td style="text-align: right;">0.226</td>
<td style="text-align: right;">0.246</td>
<td style="text-align: right;">-0.188</td>
<td style="text-align: right;">0.596</td>
<td style="text-align: right;">1.379</td>
<td style="text-align: right;">9.802</td>
<td style="text-align: right;">14.937</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[4]</td>
<td style="text-align: right;">0.651</td>
<td style="text-align: right;">0.385</td>
<td style="text-align: right;">0.032</td>
<td style="text-align: right;">1.088</td>
<td style="text-align: right;">1.596</td>
<td style="text-align: right;">7.207</td>
<td style="text-align: right;">12.047</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[5]</td>
<td style="text-align: right;">-0.173</td>
<td style="text-align: right;">0.253</td>
<td style="text-align: right;">-0.547</td>
<td style="text-align: right;">0.191</td>
<td style="text-align: right;">1.441</td>
<td style="text-align: right;">8.933</td>
<td style="text-align: right;">58.601</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[6]</td>
<td style="text-align: right;">-0.387</td>
<td style="text-align: right;">0.626</td>
<td style="text-align: right;">-1.277</td>
<td style="text-align: right;">0.704</td>
<td style="text-align: right;">2.367</td>
<td style="text-align: right;">5.372</td>
<td style="text-align: right;">4.348</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[7]</td>
<td style="text-align: right;">0.084</td>
<td style="text-align: right;">0.364</td>
<td style="text-align: right;">-0.291</td>
<td style="text-align: right;">0.812</td>
<td style="text-align: right;">1.340</td>
<td style="text-align: right;">10.165</td>
<td style="text-align: right;">27.683</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[8]</td>
<td style="text-align: right;">0.272</td>
<td style="text-align: right;">0.254</td>
<td style="text-align: right;">-0.180</td>
<td style="text-align: right;">0.558</td>
<td style="text-align: right;">1.372</td>
<td style="text-align: right;">9.580</td>
<td style="text-align: right;">18.466</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[9]</td>
<td style="text-align: right;">-0.117</td>
<td style="text-align: right;">0.188</td>
<td style="text-align: right;">-0.377</td>
<td style="text-align: right;">0.247</td>
<td style="text-align: right;">1.689</td>
<td style="text-align: right;">13.208</td>
<td style="text-align: right;">30.165</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[10]</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">0.347</td>
<td style="text-align: right;">-0.460</td>
<td style="text-align: right;">0.496</td>
<td style="text-align: right;">1.557</td>
<td style="text-align: right;">7.600</td>
<td style="text-align: right;">25.190</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[11]</td>
<td style="text-align: right;">0.068</td>
<td style="text-align: right;">0.618</td>
<td style="text-align: right;">-1.137</td>
<td style="text-align: right;">0.840</td>
<td style="text-align: right;">2.724</td>
<td style="text-align: right;">5.072</td>
<td style="text-align: right;">7.003</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[12]</td>
<td style="text-align: right;">0.119</td>
<td style="text-align: right;">0.270</td>
<td style="text-align: right;">-0.245</td>
<td style="text-align: right;">0.625</td>
<td style="text-align: right;">1.237</td>
<td style="text-align: right;">14.834</td>
<td style="text-align: right;">42.161</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[13]</td>
<td style="text-align: right;">0.089</td>
<td style="text-align: right;">0.491</td>
<td style="text-align: right;">-0.489</td>
<td style="text-align: right;">1.235</td>
<td style="text-align: right;">1.868</td>
<td style="text-align: right;">6.388</td>
<td style="text-align: right;">28.327</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[14]</td>
<td style="text-align: right;">0.172</td>
<td style="text-align: right;">0.736</td>
<td style="text-align: right;">-0.780</td>
<td style="text-align: right;">1.299</td>
<td style="text-align: right;">2.064</td>
<td style="text-align: right;">5.741</td>
<td style="text-align: right;">18.739</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[15]</td>
<td style="text-align: right;">0.082</td>
<td style="text-align: right;">0.407</td>
<td style="text-align: right;">-0.491</td>
<td style="text-align: right;">0.605</td>
<td style="text-align: right;">2.109</td>
<td style="text-align: right;">5.718</td>
<td style="text-align: right;">17.270</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[16]</td>
<td style="text-align: right;">-0.055</td>
<td style="text-align: right;">0.339</td>
<td style="text-align: right;">-0.548</td>
<td style="text-align: right;">0.394</td>
<td style="text-align: right;">1.711</td>
<td style="text-align: right;">6.843</td>
<td style="text-align: right;">25.826</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[17]</td>
<td style="text-align: right;">0.104</td>
<td style="text-align: right;">0.310</td>
<td style="text-align: right;">-0.444</td>
<td style="text-align: right;">0.502</td>
<td style="text-align: right;">1.811</td>
<td style="text-align: right;">6.325</td>
<td style="text-align: right;">20.519</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[18]</td>
<td style="text-align: right;">-0.562</td>
<td style="text-align: right;">0.429</td>
<td style="text-align: right;">-1.076</td>
<td style="text-align: right;">0.479</td>
<td style="text-align: right;">1.959</td>
<td style="text-align: right;">6.022</td>
<td style="text-align: right;">28.327</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[19]</td>
<td style="text-align: right;">-0.162</td>
<td style="text-align: right;">0.281</td>
<td style="text-align: right;">-0.600</td>
<td style="text-align: right;">0.248</td>
<td style="text-align: right;">1.561</td>
<td style="text-align: right;">7.410</td>
<td style="text-align: right;">41.928</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[20]</td>
<td style="text-align: right;">0.122</td>
<td style="text-align: right;">0.737</td>
<td style="text-align: right;">-1.036</td>
<td style="text-align: right;">0.922</td>
<td style="text-align: right;">1.949</td>
<td style="text-align: right;">6.030</td>
<td style="text-align: right;">4.348</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">0.958</td>
<td style="text-align: right;">0.239</td>
<td style="text-align: right;">0.751</td>
<td style="text-align: right;">1.092</td>
<td style="text-align: right;">1.571</td>
<td style="text-align: right;">7.369</td>
<td style="text-align: right;">8.522</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p><strong>Nota</strong>: si algunos parámetros tienen valores R-hat cercanos a 1 pero otros no, en general no podemos confiar en los resultados de las simulaciones. Esto es señal de problemas de convergencia y deben ser diagnosticados.</p>
</section>
<section id="diagnóstico-tamaño-de-muestra-efectivo" class="level3" data-number="8.3.3">
<h3 data-number="8.3.3" class="anchored" data-anchor-id="diagnóstico-tamaño-de-muestra-efectivo"><span class="header-section-number">8.3.3</span> Diagnóstico: Tamaño de muestra efectivo</h3>
<p>Las simulaciones de MCMC típicamente están autocorrelacionadas (pues comenzamos en una región y muchas veces nos movemos poco). Esto significa que la cantidad de información de <span class="math inline">\(N\)</span> simulaciones MCMC no es la misma que la que obtendríamos con <span class="math inline">\(N\)</span> simulaciones <strong>independientes</strong> de la posterior.</p>
<p>Este concepto también se usa en muestreo: por ejemplo, existe menos información en una muestra de 100 personas que fueron muestreadas por conglomerados de 50 casas (por ejemplo, seleccionando al azar hogares y luego a dos adultos dentro de cada hogar) que seleccionar 100 hogares y escoger a un al azar un adulto de cada hogar. La segunda muestra tienen más información de la población, pues en la primera muestra parte de la información es “compartida” por el hecho de vivir en el mismo hogar. Para encontrar un número “efectivo” de muestra que haga comparables estos dos diseños, comparamos la varianza que obtendríamos del estimador de interes en cada caso. Si consideramos como base el segundo diseño (muestro aleatorio independiente), el primer diseño tendrá más varianza. Eso quiere decir que para que hubiera la misma varianza en los dos diseños, bastaría una muestra más chica (digamos 60 hogares) del segundo diseño independiente. Decimos que el tamaño efectivo de muestra del primer diseño es de 60 personas (el caso donde las varianzas de los dos diseños son iguales).</p>
<p>En el caso de series de tiempo, tenemos que considerar autocorrelación en la serie. Supongamos que quisiéramos estimar la media de una serie de tiempo (suponemos que a largo plazo el promedio de la serie de tiempo es una constante finita). Una muestra con autocorrelación alta produce malos estimadores de esta media incluso para tamaños de muestra relativamente grande:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>mu_verdadera <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>simular_series <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">T =</span> <span class="dv">500</span>, <span class="at">num_series =</span> <span class="dv">100</span>, <span class="at">ar =</span> <span class="fl">0.9</span>){</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(<span class="dv">1</span><span class="sc">:</span>num_series, <span class="cf">function</span>(rep){</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    serie <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="sc">+</span> <span class="fu">arima.sim</span>(<span class="at">n =</span> T, <span class="fu">list</span>(<span class="at">ar =</span> ar), <span class="at">n.start =</span> <span class="dv">200</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>ar<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">t =</span> <span class="dv">1</span><span class="sc">:</span>T, <span class="at">serie =</span> serie, <span class="at">serie_id =</span> rep, <span class="at">ar =</span> ar)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>series_1_tbl <span class="ot">&lt;-</span> <span class="fu">simular_series</span>(<span class="at">T=</span> <span class="dv">200</span>, <span class="at">n =</span> <span class="dv">4</span>, <span class="at">ar =</span> <span class="fl">0.80</span>)</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>series_2_tbl <span class="ot">&lt;-</span> <span class="fu">simular_series</span>(<span class="at">T=</span> <span class="dv">200</span>, <span class="at">n =</span> <span class="dv">4</span>, <span class="at">ar =</span> <span class="fl">0.00001</span>)</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>series_tbl <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(series_1_tbl, series_2_tbl)</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>series_tbl <span class="sc">|&gt;</span> </span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(t, serie, <span class="at">group =</span> serie_id, <span class="at">colour =</span> <span class="fu">factor</span>(serie_id))) <span class="sc">+</span> </span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span> </span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> mu_verdadera, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>ar, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Calculamos las medias para un ejemplo con autocorrelación y otro sin ellas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>series_95_tbl <span class="ot">&lt;-</span> <span class="fu">simular_series</span>(<span class="at">T=</span> <span class="dv">300</span>, <span class="at">n =</span> <span class="dv">500</span>, <span class="at">ar =</span> <span class="fl">0.80</span>) </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>series_05_tbl <span class="ot">&lt;-</span> <span class="fu">simular_series</span>(<span class="at">T=</span> <span class="dv">300</span>, <span class="at">n =</span> <span class="dv">500</span>, <span class="at">ar =</span> <span class="fl">0.00001</span>) </span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>series_tbl <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(series_95_tbl, series_05_tbl)</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>series_tbl <span class="sc">|&gt;</span> <span class="fu">group_by</span>(serie_id, ar) <span class="sc">|&gt;</span> </span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(serie)) <span class="sc">|&gt;</span> </span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(media)) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> </span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> mu_verdadera, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribución de medias de series de tiempo"</span>) <span class="sc">+</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>ar)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'serie_id'. You can override using the
`.groups` argument.
`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Y vemos que la precisión de la estimación cuando la correlación es relativamente baja es mucho más alta que cuando la correlación es alta. ¿Cuál es el tamaño efectivo de muestra para series con autocorrelación ar= 0.8? Vemos que es aproximadamente 35, o dicho de otra manera, la serie sin correlación nos da casi 10 veces más información por observación que la correlacionada:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>series_95_tbl <span class="ot">&lt;-</span> <span class="fu">simular_series</span>(<span class="at">T=</span> <span class="dv">300</span>, <span class="at">n =</span> <span class="dv">1000</span>, <span class="at">ar =</span> <span class="fl">0.8</span>) </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>series_05_tbl <span class="ot">&lt;-</span> <span class="fu">simular_series</span>(<span class="at">T=</span> <span class="dv">35</span>, <span class="at">n =</span> <span class="dv">1000</span>, <span class="at">ar =</span> <span class="fl">0.00001</span>) </span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>series_tbl <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(series_95_tbl, series_05_tbl)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>series_tbl <span class="sc">|&gt;</span> <span class="fu">group_by</span>(serie_id, ar) <span class="sc">|&gt;</span> </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(serie)) <span class="sc">|&gt;</span> </span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(media)) <span class="sc">+</span> <span class="fu">geom_histogram</span>() <span class="sc">+</span> </span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> mu_verdadera, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribución de medias de series de tiempo"</span>) <span class="sc">+</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>ar)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'serie_id'. You can override using the
`.groups` argument.
`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Es posible hacer una estimación teórica del tamaño efectivo de muestra. Para esto, podemos notar que la varianza del promedio de una serie de tiempo depende de la estructura de autocorrelación. Supondremos que la serie de tiempo es estacionaria y cada <span class="math inline">\(y_t\)</span> tiene varianza <span class="math inline">\(\sigma^2\)</span> y correlación <span class="math inline">\(\rho\)</span> con <span class="math inline">\(y_{t-1}\)</span>. Entonces:</p>
<p><span class="math display">\[Var(\bar{y})=\frac{1}{n^2}\text{Var} \left(\sum_{t=1}^n y_t \right) =
\frac{n\sigma^2}{n^2}\sum_{t=1}^n \text{Var}(y_t) + \frac{2\sigma^2}{n^2}\sum_{t=1}^{n-1}\sum_{s=t+1}^n\text{Corr}(y_t, y_s)\]</span></p>
<p>Que se simplifica a (para <span class="math inline">\(n\)</span> grande):</p>
<p><span class="math display">\[\text{Var}(\bar{y}) = \frac{\sigma^2}{n} + \frac{2\sigma^2}{n}\sum_{h=1}^{n-1}(1-h/n)\rho_{h} \approx \frac{\sigma^2}{n}\left (1+2\sum_{h=1}^{n-1}\rho_t\right )\]</span> Si suponemos <span class="math inline">\(\rho_h = \text{corr}(y_t, y_{t+h})\)</span> para cualquier <span class="math inline">\(t\)</span>. En nuestro caso anterior, el factor de corrección es aproximadamente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>(<span class="fl">0.8</span>)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>) <span class="sc">|&gt;</span> <span class="fu">sum</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tamaño efectivo de muestra
</div>
</div>
<div class="callout-body-container callout-body">
<p>Si hacemos <span class="math inline">\(N\)</span> iteraciones en una cadena estacionaria con función de autocorrelación <span class="math inline">\(\rho_h\)</span>, el tamaño efectivo de muestra teórico se define como</p>
<p><span class="math display">\[N_{eff} = \frac{N}{1 + 2\sum_{h=1}^{\infty}\rho_h}\]</span></p>
<p>Si pudiéramos hacer simulaciones independientes de la posterior, <span class="math inline">\(N_{eff}\)</span> es el tamaño de muestra requerido para obtener la misma información que la cadena autocorrelacionada de tamaño <span class="math inline">\(N\)</span>. Usualmente, aunque no siempre, <span class="math inline">\(N_{eff}&lt;N\)</span> para cadenas de MCMC.</p>
</div>
</div>
<p><strong>Observaciones</strong>:</p>
<ol type="1">
<li>Esta es una definición teórica para entender el concepto. Para ver cómo se estima en la práctica puedes consultar <a href="https://mc-stan.org/docs/reference-manual/analysis.html#effective-sample-size.section">el manual de Stan</a> o <span class="citation" data-cites="handbookmc">(<a href="#ref-handbookmc" role="doc-biblioref">Brooks et&nbsp;al. 2011</a>)</span>.</li>
<li>En algunos muestreadores que dan pasos cortos como en los ejemplos de Metropolis-Hastings que vimos, a veces es necesario hacer cientos de miles de iteraciones para obtener un tamaño efectivo de muestra apropiado para hacer inferencia. Stan generalmente obtiene tamaños efectivos de muestra mucho más altos con menos iteraciones (aunque cada iteración es más costosa).</li>
<li>Considerando experiencia y teoría, tamaños efectivos de muestra mínimos se considera de 400 o más (ver <a href="https://arxiv.org/abs/1903.08008">aquí</a>).</li>
</ol>
<p>En nuestro ejemplo, tenemos tamaños de muestra efectivos satisfactorios:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_1<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"Q"</span>, <span class="st">"sigma"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, q5, q95, rhat, <span class="fu">contains</span>(<span class="st">"ess"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(mean, sd, q5, q95, rhat, ess_bulk, ess_tail), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">!=</span> <span class="st">"lp__"</span>) <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Q[1]</td>
<td style="text-align: right;">0.137</td>
<td style="text-align: right;">0.317</td>
<td style="text-align: right;">-0.396</td>
<td style="text-align: right;">0.672</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">20694.09</td>
<td style="text-align: right;">5373.128</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[2]</td>
<td style="text-align: right;">0.103</td>
<td style="text-align: right;">0.321</td>
<td style="text-align: right;">-0.425</td>
<td style="text-align: right;">0.629</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">20994.93</td>
<td style="text-align: right;">5362.172</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[3]</td>
<td style="text-align: right;">0.271</td>
<td style="text-align: right;">0.318</td>
<td style="text-align: right;">-0.247</td>
<td style="text-align: right;">0.798</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20676.69</td>
<td style="text-align: right;">5913.964</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[4]</td>
<td style="text-align: right;">0.555</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">0.043</td>
<td style="text-align: right;">1.069</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18730.09</td>
<td style="text-align: right;">5575.563</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[5]</td>
<td style="text-align: right;">-0.120</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">-0.636</td>
<td style="text-align: right;">0.390</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">19760.24</td>
<td style="text-align: right;">5848.199</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[6]</td>
<td style="text-align: right;">-0.370</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">-0.880</td>
<td style="text-align: right;">0.145</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">16654.60</td>
<td style="text-align: right;">5972.842</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[7]</td>
<td style="text-align: right;">0.286</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-0.231</td>
<td style="text-align: right;">0.795</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17442.52</td>
<td style="text-align: right;">6084.769</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[8]</td>
<td style="text-align: right;">0.271</td>
<td style="text-align: right;">0.319</td>
<td style="text-align: right;">-0.256</td>
<td style="text-align: right;">0.805</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18199.26</td>
<td style="text-align: right;">5596.789</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[9]</td>
<td style="text-align: right;">0.080</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-0.438</td>
<td style="text-align: right;">0.584</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">19534.73</td>
<td style="text-align: right;">5983.451</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[10]</td>
<td style="text-align: right;">0.118</td>
<td style="text-align: right;">0.308</td>
<td style="text-align: right;">-0.386</td>
<td style="text-align: right;">0.626</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">21143.80</td>
<td style="text-align: right;">5814.923</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[11]</td>
<td style="text-align: right;">-0.010</td>
<td style="text-align: right;">0.321</td>
<td style="text-align: right;">-0.546</td>
<td style="text-align: right;">0.510</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20940.00</td>
<td style="text-align: right;">5531.936</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[12]</td>
<td style="text-align: right;">-0.029</td>
<td style="text-align: right;">0.322</td>
<td style="text-align: right;">-0.560</td>
<td style="text-align: right;">0.500</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">18276.46</td>
<td style="text-align: right;">5849.228</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[13]</td>
<td style="text-align: right;">-0.105</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">-0.609</td>
<td style="text-align: right;">0.414</td>
<td style="text-align: right;">1.003</td>
<td style="text-align: right;">20575.88</td>
<td style="text-align: right;">5957.570</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[14]</td>
<td style="text-align: right;">0.005</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">-0.505</td>
<td style="text-align: right;">0.525</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17541.60</td>
<td style="text-align: right;">5723.524</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[15]</td>
<td style="text-align: right;">-0.215</td>
<td style="text-align: right;">0.318</td>
<td style="text-align: right;">-0.740</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17150.01</td>
<td style="text-align: right;">5412.980</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[16]</td>
<td style="text-align: right;">-0.201</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">-0.722</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17596.06</td>
<td style="text-align: right;">5120.461</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[17]</td>
<td style="text-align: right;">-0.142</td>
<td style="text-align: right;">0.316</td>
<td style="text-align: right;">-0.665</td>
<td style="text-align: right;">0.379</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20718.38</td>
<td style="text-align: right;">6172.910</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[18]</td>
<td style="text-align: right;">-0.860</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-1.384</td>
<td style="text-align: right;">-0.343</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18745.31</td>
<td style="text-align: right;">6126.091</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[19]</td>
<td style="text-align: right;">-0.161</td>
<td style="text-align: right;">0.311</td>
<td style="text-align: right;">-0.666</td>
<td style="text-align: right;">0.343</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18166.25</td>
<td style="text-align: right;">6352.717</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[20]</td>
<td style="text-align: right;">0.380</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">-0.127</td>
<td style="text-align: right;">0.896</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">21072.45</td>
<td style="text-align: right;">5060.363</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">0.997</td>
<td style="text-align: right;">0.054</td>
<td style="text-align: right;">0.912</td>
<td style="text-align: right;">1.092</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">13245.07</td>
<td style="text-align: right;">6385.483</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<ul>
<li>Nótese que versiones más recientes de Stan reportan dos tamaños efectivos de muestra (ESS), uno para cantidades que dependen del centro de la distribución, como la media y mediana (bulk ESS, que es similar a la definición que vimos arriba, pero usando valores normalizados por rango), y otro para cantidades que dependen de las colas, como percentiles extremos (tail ESS, que estima el tamaño de muestra efectivo para los percentiles 5% y 95% ). En este caso, ambos son altos.</li>
</ul>
<p>Finalmente, podemos checar el error montecarlo, que es error de estimación usual</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_1<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"Q"</span>, <span class="st">"sigma"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, q5, q95, rhat, <span class="fu">contains</span>(<span class="st">"ess"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(mean, sd, q5, q95, rhat, ess_bulk, ess_tail), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">!=</span> <span class="st">"lp__"</span>) <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Q[1]</td>
<td style="text-align: right;">0.137</td>
<td style="text-align: right;">0.317</td>
<td style="text-align: right;">-0.396</td>
<td style="text-align: right;">0.672</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">20694.09</td>
<td style="text-align: right;">5373.128</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[2]</td>
<td style="text-align: right;">0.103</td>
<td style="text-align: right;">0.321</td>
<td style="text-align: right;">-0.425</td>
<td style="text-align: right;">0.629</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">20994.93</td>
<td style="text-align: right;">5362.172</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[3]</td>
<td style="text-align: right;">0.271</td>
<td style="text-align: right;">0.318</td>
<td style="text-align: right;">-0.247</td>
<td style="text-align: right;">0.798</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20676.69</td>
<td style="text-align: right;">5913.964</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[4]</td>
<td style="text-align: right;">0.555</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">0.043</td>
<td style="text-align: right;">1.069</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18730.09</td>
<td style="text-align: right;">5575.563</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[5]</td>
<td style="text-align: right;">-0.120</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">-0.636</td>
<td style="text-align: right;">0.390</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">19760.24</td>
<td style="text-align: right;">5848.199</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[6]</td>
<td style="text-align: right;">-0.370</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">-0.880</td>
<td style="text-align: right;">0.145</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">16654.60</td>
<td style="text-align: right;">5972.842</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[7]</td>
<td style="text-align: right;">0.286</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-0.231</td>
<td style="text-align: right;">0.795</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17442.52</td>
<td style="text-align: right;">6084.769</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[8]</td>
<td style="text-align: right;">0.271</td>
<td style="text-align: right;">0.319</td>
<td style="text-align: right;">-0.256</td>
<td style="text-align: right;">0.805</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18199.26</td>
<td style="text-align: right;">5596.789</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[9]</td>
<td style="text-align: right;">0.080</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-0.438</td>
<td style="text-align: right;">0.584</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">19534.73</td>
<td style="text-align: right;">5983.451</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[10]</td>
<td style="text-align: right;">0.118</td>
<td style="text-align: right;">0.308</td>
<td style="text-align: right;">-0.386</td>
<td style="text-align: right;">0.626</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">21143.80</td>
<td style="text-align: right;">5814.923</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[11]</td>
<td style="text-align: right;">-0.010</td>
<td style="text-align: right;">0.321</td>
<td style="text-align: right;">-0.546</td>
<td style="text-align: right;">0.510</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20940.00</td>
<td style="text-align: right;">5531.936</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[12]</td>
<td style="text-align: right;">-0.029</td>
<td style="text-align: right;">0.322</td>
<td style="text-align: right;">-0.560</td>
<td style="text-align: right;">0.500</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">18276.46</td>
<td style="text-align: right;">5849.228</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[13]</td>
<td style="text-align: right;">-0.105</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">-0.609</td>
<td style="text-align: right;">0.414</td>
<td style="text-align: right;">1.003</td>
<td style="text-align: right;">20575.88</td>
<td style="text-align: right;">5957.570</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[14]</td>
<td style="text-align: right;">0.005</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">-0.505</td>
<td style="text-align: right;">0.525</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17541.60</td>
<td style="text-align: right;">5723.524</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[15]</td>
<td style="text-align: right;">-0.215</td>
<td style="text-align: right;">0.318</td>
<td style="text-align: right;">-0.740</td>
<td style="text-align: right;">0.312</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17150.01</td>
<td style="text-align: right;">5412.980</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[16]</td>
<td style="text-align: right;">-0.201</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">-0.722</td>
<td style="text-align: right;">0.315</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">17596.06</td>
<td style="text-align: right;">5120.461</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[17]</td>
<td style="text-align: right;">-0.142</td>
<td style="text-align: right;">0.316</td>
<td style="text-align: right;">-0.665</td>
<td style="text-align: right;">0.379</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">20718.38</td>
<td style="text-align: right;">6172.910</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[18]</td>
<td style="text-align: right;">-0.860</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">-1.384</td>
<td style="text-align: right;">-0.343</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18745.31</td>
<td style="text-align: right;">6126.091</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[19]</td>
<td style="text-align: right;">-0.161</td>
<td style="text-align: right;">0.311</td>
<td style="text-align: right;">-0.666</td>
<td style="text-align: right;">0.343</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">18166.25</td>
<td style="text-align: right;">6352.717</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[20]</td>
<td style="text-align: right;">0.380</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">-0.127</td>
<td style="text-align: right;">0.896</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">21072.45</td>
<td style="text-align: right;">5060.363</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">0.997</td>
<td style="text-align: right;">0.054</td>
<td style="text-align: right;">0.912</td>
<td style="text-align: right;">1.092</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">13245.07</td>
<td style="text-align: right;">6385.483</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</section>
</section>
<section id="extendiendo-el-modelo-de-variable-latente" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="extendiendo-el-modelo-de-variable-latente"><span class="header-section-number">8.4</span> Extendiendo el modelo de variable latente</h2>
<p>Ahora continuamos con nuestro modelo de calidad de vinos. Incluímos el origen del vino (que tiene dos niveles). La idea es que el origen, si vemos en el diagrama original, puede ser una variable de confusión entre calidad y score (pues afecta a calidad y también potencialmente al score). Adicionalmente, el origen no tiene puerta trasera, así que podemos examinar su efecto total sobre el score de los vinos. Estratificamos de la manera más simple, incluyendo origen en nuestra regresión:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>wines_2012 <span class="ot">&lt;-</span> wines_2012 <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">origen_num =</span> <span class="fu">ifelse</span>(wine.amer <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>wines_2012 <span class="sc">|&gt;</span> <span class="fu">select</span>(wine.amer, origen_num) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  wine.amer origen_num
      &lt;dbl&gt;      &lt;dbl&gt;
1         1          1
2         0          2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>n_jueces <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(wines_2012<span class="sc">$</span>juez_num))</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>n_vinos <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(wines_2012<span class="sc">$</span>vino_num))</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>n_origen <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(wines_2012<span class="sc">$</span>origen_num))</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="st">"num_vinos"</span> <span class="ot">=</span> n_vinos, <span class="st">"num_jueces"</span> <span class="ot">=</span> n_jueces, <span class="st">"num_datos"</span> <span class="ot">=</span> <span class="fu">nrow</span>(wines_2012))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num_vinos num_jueces  num_datos 
        20          9        180 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>mod_vinos_2 <span class="ot">&lt;-</span><span class="fu">cmdstan_model</span>(<span class="st">"./src/vinos-2.stan"</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_vinos_2)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N; //número de calificaciones
  int&lt;lower=0&gt; n_vinos; //número de vinos
  int&lt;lower=0&gt; n_jueces; //número de jueces
  int&lt;lower=0&gt; n_origen; //número de jueces
  vector[N]  S;
  array[N]  int juez;
  array[N]  int vino;
  array[N]  int origen;
}

parameters {
  vector[n_vinos] Q;
  vector[n_origen] O;
  real &lt;lower=0&gt; sigma;
}

transformed parameters {
  vector[N] media_score;
  // determinístico dado parámetros
  for (i in 1:N){
    media_score[i] = Q[vino[i]] + O[origen[i]];
  }
}

model {
  // partes no determinísticas
  S ~ normal(media_score, sigma);
  Q ~ std_normal();
  O ~ std_normal();
  sigma ~ exponential(1);
}

generated quantities {
  real dif_origen;
  dif_origen = O[1] - O[2];
}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>datos_lst <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(wines_2012),</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_vinos =</span> n_vinos,</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_jueces =</span> n_jueces,</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_origen =</span> n_origen,</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> wines_2012<span class="sc">$</span>score_est,</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">vino =</span> wines_2012<span class="sc">$</span>vino_num,</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">juez =</span> wines_2012<span class="sc">$</span>juez_num,</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">origen =</span> wines_2012<span class="sc">$</span>origen_num</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_2 <span class="ot">&lt;-</span> mod_vinos_2<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> datos_lst,</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">2000</span>,</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">1000</span>,</span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">step_size =</span> <span class="fl">0.1</span>,</span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 1 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 2 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 2 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 3 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 3 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 4 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 4 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 1 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 2 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 3 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 4 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 1 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 2 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 1 finished in 0.6 seconds.
Chain 2 finished in 0.6 seconds.
Chain 3 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 4 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 3 finished in 0.6 seconds.
Chain 4 finished in 0.6 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.6 seconds.
Total execution time: 0.8 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_2<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"O"</span>, <span class="st">"Q"</span>, <span class="st">"sigma"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, q5, q95, rhat, <span class="fu">contains</span>(<span class="st">"ess"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(mean, sd, q5, q95, rhat, ess_bulk, ess_tail), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">!=</span> <span class="st">"lp__"</span>) <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">O[1]</td>
<td style="text-align: right;">-0.066</td>
<td style="text-align: right;">0.290</td>
<td style="text-align: right;">-0.543</td>
<td style="text-align: right;">0.421</td>
<td style="text-align: right;">1.002</td>
<td style="text-align: right;">2287.306</td>
<td style="text-align: right;">3321.151</td>
</tr>
<tr class="even">
<td style="text-align: left;">O[2]</td>
<td style="text-align: right;">0.106</td>
<td style="text-align: right;">0.351</td>
<td style="text-align: right;">-0.465</td>
<td style="text-align: right;">0.679</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">2484.077</td>
<td style="text-align: right;">3858.430</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[1]</td>
<td style="text-align: right;">0.197</td>
<td style="text-align: right;">0.409</td>
<td style="text-align: right;">-0.471</td>
<td style="text-align: right;">0.878</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3942.153</td>
<td style="text-align: right;">5029.018</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[2]</td>
<td style="text-align: right;">0.007</td>
<td style="text-align: right;">0.447</td>
<td style="text-align: right;">-0.729</td>
<td style="text-align: right;">0.725</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3855.171</td>
<td style="text-align: right;">5170.915</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[3]</td>
<td style="text-align: right;">0.332</td>
<td style="text-align: right;">0.415</td>
<td style="text-align: right;">-0.364</td>
<td style="text-align: right;">1.006</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">4170.358</td>
<td style="text-align: right;">5201.923</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[4]</td>
<td style="text-align: right;">0.458</td>
<td style="text-align: right;">0.447</td>
<td style="text-align: right;">-0.276</td>
<td style="text-align: right;">1.180</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3678.397</td>
<td style="text-align: right;">5085.397</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[5]</td>
<td style="text-align: right;">-0.223</td>
<td style="text-align: right;">0.448</td>
<td style="text-align: right;">-0.952</td>
<td style="text-align: right;">0.514</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3854.360</td>
<td style="text-align: right;">5259.621</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[6]</td>
<td style="text-align: right;">-0.307</td>
<td style="text-align: right;">0.412</td>
<td style="text-align: right;">-0.976</td>
<td style="text-align: right;">0.366</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">4109.770</td>
<td style="text-align: right;">5083.645</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[7]</td>
<td style="text-align: right;">0.198</td>
<td style="text-align: right;">0.446</td>
<td style="text-align: right;">-0.534</td>
<td style="text-align: right;">0.928</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3981.338</td>
<td style="text-align: right;">5487.974</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[8]</td>
<td style="text-align: right;">0.330</td>
<td style="text-align: right;">0.410</td>
<td style="text-align: right;">-0.344</td>
<td style="text-align: right;">1.015</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">4160.583</td>
<td style="text-align: right;">5196.431</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[9]</td>
<td style="text-align: right;">0.140</td>
<td style="text-align: right;">0.411</td>
<td style="text-align: right;">-0.536</td>
<td style="text-align: right;">0.821</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3925.106</td>
<td style="text-align: right;">5383.750</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[10]</td>
<td style="text-align: right;">0.182</td>
<td style="text-align: right;">0.409</td>
<td style="text-align: right;">-0.489</td>
<td style="text-align: right;">0.871</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">4198.558</td>
<td style="text-align: right;">4953.803</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[11]</td>
<td style="text-align: right;">0.051</td>
<td style="text-align: right;">0.409</td>
<td style="text-align: right;">-0.626</td>
<td style="text-align: right;">0.711</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3835.440</td>
<td style="text-align: right;">5195.758</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[12]</td>
<td style="text-align: right;">0.028</td>
<td style="text-align: right;">0.414</td>
<td style="text-align: right;">-0.648</td>
<td style="text-align: right;">0.707</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">4066.563</td>
<td style="text-align: right;">4891.343</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[13]</td>
<td style="text-align: right;">-0.046</td>
<td style="text-align: right;">0.414</td>
<td style="text-align: right;">-0.733</td>
<td style="text-align: right;">0.619</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">3731.818</td>
<td style="text-align: right;">4772.284</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[14]</td>
<td style="text-align: right;">-0.083</td>
<td style="text-align: right;">0.448</td>
<td style="text-align: right;">-0.814</td>
<td style="text-align: right;">0.656</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3660.288</td>
<td style="text-align: right;">4800.175</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[15]</td>
<td style="text-align: right;">-0.315</td>
<td style="text-align: right;">0.448</td>
<td style="text-align: right;">-1.052</td>
<td style="text-align: right;">0.423</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">4042.565</td>
<td style="text-align: right;">5126.763</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[16]</td>
<td style="text-align: right;">-0.139</td>
<td style="text-align: right;">0.416</td>
<td style="text-align: right;">-0.818</td>
<td style="text-align: right;">0.540</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">3953.433</td>
<td style="text-align: right;">5064.421</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[17]</td>
<td style="text-align: right;">-0.083</td>
<td style="text-align: right;">0.414</td>
<td style="text-align: right;">-0.770</td>
<td style="text-align: right;">0.595</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">4124.527</td>
<td style="text-align: right;">5544.165</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[18]</td>
<td style="text-align: right;">-0.799</td>
<td style="text-align: right;">0.409</td>
<td style="text-align: right;">-1.464</td>
<td style="text-align: right;">-0.126</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">4042.865</td>
<td style="text-align: right;">4892.500</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[19]</td>
<td style="text-align: right;">-0.259</td>
<td style="text-align: right;">0.447</td>
<td style="text-align: right;">-0.996</td>
<td style="text-align: right;">0.480</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3741.120</td>
<td style="text-align: right;">5044.906</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[20]</td>
<td style="text-align: right;">0.287</td>
<td style="text-align: right;">0.445</td>
<td style="text-align: right;">-0.439</td>
<td style="text-align: right;">1.027</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3701.595</td>
<td style="text-align: right;">5366.897</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">0.998</td>
<td style="text-align: right;">0.056</td>
<td style="text-align: right;">0.911</td>
<td style="text-align: right;">1.094</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">9688.425</td>
<td style="text-align: right;">6351.040</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>Todo parece bien con los diagnósticos. Podemos graficar las estimaciones (nota: aquí estan intervalos de 50% y 90%):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">color_scheme_set</span>(<span class="st">"red"</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(ajuste_vinos_2<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"Q"</span>, <span class="st">"O"</span>, <span class="st">"sigma"</span>)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Parece no haber mucha diferencia en calidad debida origen del vinos (tienen relativamente poca variabilidad y están traslapadas: aunque podríamos mejor calcular el contraste si queremos examinar esto con más cuidado).</li>
</ul>
<p>Todo parece ir bien, así que podemos expandir el modelo para incluir la forma de calificar de los jueces. Esto no es necesario (los jueces son una causa adicional que afecta el score), pero puede mejorar nuestras estimaciones.</p>
<p>Para estratificar por estas variables, tenemos que separarnos un poco de efectos adivitivos. Una razón importante por la que varían las calificaciones es que hay jueces que son más duros que otros, o que discriminan más qué otros. Esto es usual también cuando pensamos que los jueces son reactivos que las personas contestan: existen reactivos más difíciles que otros, y también discriminan de diferente manera.</p>
<p>En primer lugar, definimos un nivel general <span class="math inline">\(H\)</span> que indica qué tan alto o bajo califica un juez en general. Adicionalmente, incluímos un parámetro de discriminación <span class="math inline">\(D\)</span> de los jueces, que indica qué tanto del rango de la escala usa cada juez El modelo para el valor esperado del <em>Score</em> de un vino <span class="math inline">\(i\)</span> calificado por el juez <span class="math inline">\(j\)</span> es:</p>
<p><span class="math display">\[\mu_{i} = Q_{vino(i)} + O_{origen(i)} - H_{juez(i)}\]</span> Podemos pensar que el valor <span class="math inline">\(H\)</span> de cada juez es qué tan duro es en sus calificaciones. Para cada vino, un juez con valor alto de <span class="math inline">\(H\)</span> tendrá a calificar más bajo un vino de misma calidad y origen que otro juez con un valor más bajo de <span class="math inline">\(H\)</span>. Podemos incluír un parámetro de discriminación <span class="math inline">\(D\)</span> para cada juez, que indica qué tanto del rango de la escala usa cada juez de la siguiente forma:</p>
<p><span class="math display">\[\mu_{i} = (Q_{vino(i)} + O_{origen(i)} - H_{juez(i)})D_{juez(i)}\]</span> Un juez con valor alto de <span class="math inline">\(D\)</span> es más extremo en sus calificaciones: un vino por arriba de su promedio lo califica más alto en la escala, y un vino por debajo de su promedio lo califica más bajo. El extremo es que <span class="math inline">\(D=0\)</span>, que quiere decir que el juez tiende a calificar a todos los vinos con un score.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>mod_vinos_3 <span class="ot">&lt;-</span><span class="fu">cmdstan_model</span>(<span class="st">"./src/vinos-3.stan"</span>)</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_vinos_3)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N; //número de calificaciones
  int&lt;lower=0&gt; n_vinos; //número de vinos
  int&lt;lower=0&gt; n_jueces; //número de jueces
  int&lt;lower=0&gt; n_origen; //número de jueces
  vector[N]  S;
  array[N]  int juez;
  array[N]  int vino;
  array[N]  int origen;
}

parameters {
  vector[n_vinos] Q;
  vector[n_origen] O;
  vector[n_jueces] H;
  vector&lt;lower=0&gt;[n_jueces] D;

  real &lt;lower=0&gt; sigma;
}

transformed parameters {
  vector[N] media_score;
  // determinístico dado parámetros
  for (i in 1:N){
    media_score[i] = (Q[vino[i]] + O[origen[i]] - H[juez[i]]) * D[juez[i]];
  }
}

model {
  // partes no determinísticas
  S ~ normal(media_score, sigma);
  Q ~ std_normal();
  O ~ std_normal();
  H ~ std_normal();
  D ~ std_normal();
  sigma ~ exponential(1);
}

generated quantities {
  real dif_origen;
  dif_origen = O[1] - O[2];
}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>datos_lst <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(wines_2012),</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_vinos =</span> n_vinos,</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_jueces =</span> n_jueces,</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_origen =</span> n_origen,</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> wines_2012<span class="sc">$</span>score_est,</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">vino =</span> wines_2012<span class="sc">$</span>vino_num,</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">juez =</span> wines_2012<span class="sc">$</span>juez_num,</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">origen =</span> wines_2012<span class="sc">$</span>origen_num</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_3 <span class="ot">&lt;-</span> mod_vinos_3<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> datos_lst,</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">2000</span>,</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">1000</span>,</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">step_size =</span> <span class="fl">0.1</span>,</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 3 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 4 Iteration:    1 / 3000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 1 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 2 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 2 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 3 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 3 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 4 Iteration: 1000 / 3000 [ 33%]  (Warmup) 
Chain 4 Iteration: 1001 / 3000 [ 33%]  (Sampling) 
Chain 1 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 2 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 4 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 3 Iteration: 2000 / 3000 [ 66%]  (Sampling) 
Chain 1 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 2 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 4 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 1 finished in 1.5 seconds.
Chain 2 finished in 1.5 seconds.
Chain 4 finished in 1.4 seconds.
Chain 3 Iteration: 3000 / 3000 [100%]  (Sampling) 
Chain 3 finished in 1.5 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.5 seconds.
Total execution time: 1.7 seconds.</code></pre>
</div>
</div>
<p>Checamos diagnósticos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_3<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"O"</span>, <span class="st">"Q"</span>, <span class="st">"H"</span>, <span class="st">"D"</span>, <span class="st">"sigma"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, q5, q95, rhat, <span class="fu">contains</span>(<span class="st">"ess"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(mean, sd, q5, q95, rhat, ess_bulk, ess_tail), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">!=</span> <span class="st">"lp__"</span>) <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">O[1]</td>
<td style="text-align: right;">-0.115</td>
<td style="text-align: right;">0.447</td>
<td style="text-align: right;">-0.859</td>
<td style="text-align: right;">0.629</td>
<td style="text-align: right;">1.002</td>
<td style="text-align: right;">3518.843</td>
<td style="text-align: right;">4790.784</td>
</tr>
<tr class="even">
<td style="text-align: left;">O[2]</td>
<td style="text-align: right;">0.198</td>
<td style="text-align: right;">0.476</td>
<td style="text-align: right;">-0.572</td>
<td style="text-align: right;">0.986</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3963.128</td>
<td style="text-align: right;">5271.349</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[1]</td>
<td style="text-align: right;">0.366</td>
<td style="text-align: right;">0.562</td>
<td style="text-align: right;">-0.543</td>
<td style="text-align: right;">1.315</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">5657.887</td>
<td style="text-align: right;">5719.280</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[2]</td>
<td style="text-align: right;">0.168</td>
<td style="text-align: right;">0.586</td>
<td style="text-align: right;">-0.779</td>
<td style="text-align: right;">1.132</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">5514.261</td>
<td style="text-align: right;">5765.562</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[3]</td>
<td style="text-align: right;">0.508</td>
<td style="text-align: right;">0.537</td>
<td style="text-align: right;">-0.369</td>
<td style="text-align: right;">1.377</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">6854.468</td>
<td style="text-align: right;">5604.398</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[4]</td>
<td style="text-align: right;">0.825</td>
<td style="text-align: right;">0.579</td>
<td style="text-align: right;">-0.111</td>
<td style="text-align: right;">1.800</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">6452.743</td>
<td style="text-align: right;">5446.307</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[5]</td>
<td style="text-align: right;">-0.483</td>
<td style="text-align: right;">0.558</td>
<td style="text-align: right;">-1.385</td>
<td style="text-align: right;">0.451</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">6299.704</td>
<td style="text-align: right;">5695.944</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[6]</td>
<td style="text-align: right;">-0.830</td>
<td style="text-align: right;">0.593</td>
<td style="text-align: right;">-1.783</td>
<td style="text-align: right;">0.171</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">4716.862</td>
<td style="text-align: right;">5114.054</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[7]</td>
<td style="text-align: right;">0.229</td>
<td style="text-align: right;">0.602</td>
<td style="text-align: right;">-0.753</td>
<td style="text-align: right;">1.229</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">4749.244</td>
<td style="text-align: right;">6033.222</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[8]</td>
<td style="text-align: right;">0.618</td>
<td style="text-align: right;">0.553</td>
<td style="text-align: right;">-0.274</td>
<td style="text-align: right;">1.552</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">6631.817</td>
<td style="text-align: right;">5578.857</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[9]</td>
<td style="text-align: right;">0.278</td>
<td style="text-align: right;">0.556</td>
<td style="text-align: right;">-0.642</td>
<td style="text-align: right;">1.179</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">5940.039</td>
<td style="text-align: right;">5748.859</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[10]</td>
<td style="text-align: right;">0.313</td>
<td style="text-align: right;">0.531</td>
<td style="text-align: right;">-0.568</td>
<td style="text-align: right;">1.172</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">6559.060</td>
<td style="text-align: right;">5848.707</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[11]</td>
<td style="text-align: right;">0.183</td>
<td style="text-align: right;">0.535</td>
<td style="text-align: right;">-0.708</td>
<td style="text-align: right;">1.054</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">6569.389</td>
<td style="text-align: right;">6443.012</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[12]</td>
<td style="text-align: right;">-0.079</td>
<td style="text-align: right;">0.537</td>
<td style="text-align: right;">-0.941</td>
<td style="text-align: right;">0.807</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">6281.310</td>
<td style="text-align: right;">5903.469</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[13]</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.549</td>
<td style="text-align: right;">-0.860</td>
<td style="text-align: right;">0.940</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">6563.927</td>
<td style="text-align: right;">5507.827</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[14]</td>
<td style="text-align: right;">-0.158</td>
<td style="text-align: right;">0.558</td>
<td style="text-align: right;">-1.077</td>
<td style="text-align: right;">0.753</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">6874.838</td>
<td style="text-align: right;">5893.450</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[15]</td>
<td style="text-align: right;">-0.521</td>
<td style="text-align: right;">0.584</td>
<td style="text-align: right;">-1.498</td>
<td style="text-align: right;">0.422</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">5853.924</td>
<td style="text-align: right;">5734.059</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[16]</td>
<td style="text-align: right;">-0.121</td>
<td style="text-align: right;">0.565</td>
<td style="text-align: right;">-1.036</td>
<td style="text-align: right;">0.815</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">5233.317</td>
<td style="text-align: right;">5555.469</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[17]</td>
<td style="text-align: right;">0.103</td>
<td style="text-align: right;">0.562</td>
<td style="text-align: right;">-0.845</td>
<td style="text-align: right;">1.007</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">5025.607</td>
<td style="text-align: right;">5096.996</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[18]</td>
<td style="text-align: right;">-1.507</td>
<td style="text-align: right;">0.552</td>
<td style="text-align: right;">-2.424</td>
<td style="text-align: right;">-0.608</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">5907.052</td>
<td style="text-align: right;">5459.271</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Q[19]</td>
<td style="text-align: right;">-0.367</td>
<td style="text-align: right;">0.561</td>
<td style="text-align: right;">-1.292</td>
<td style="text-align: right;">0.545</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">6738.238</td>
<td style="text-align: right;">6061.758</td>
</tr>
<tr class="even">
<td style="text-align: left;">Q[20]</td>
<td style="text-align: right;">0.482</td>
<td style="text-align: right;">0.569</td>
<td style="text-align: right;">-0.445</td>
<td style="text-align: right;">1.408</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">5687.180</td>
<td style="text-align: right;">5521.888</td>
</tr>
<tr class="odd">
<td style="text-align: left;">H[1]</td>
<td style="text-align: right;">0.619</td>
<td style="text-align: right;">0.586</td>
<td style="text-align: right;">-0.269</td>
<td style="text-align: right;">1.601</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">6123.319</td>
<td style="text-align: right;">4979.950</td>
</tr>
<tr class="even">
<td style="text-align: left;">H[2]</td>
<td style="text-align: right;">-0.274</td>
<td style="text-align: right;">0.437</td>
<td style="text-align: right;">-0.998</td>
<td style="text-align: right;">0.424</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">4060.809</td>
<td style="text-align: right;">4583.991</td>
</tr>
<tr class="odd">
<td style="text-align: left;">H[3]</td>
<td style="text-align: right;">-0.469</td>
<td style="text-align: right;">0.734</td>
<td style="text-align: right;">-1.656</td>
<td style="text-align: right;">0.745</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">6648.205</td>
<td style="text-align: right;">5243.692</td>
</tr>
<tr class="even">
<td style="text-align: left;">H[4]</td>
<td style="text-align: right;">1.233</td>
<td style="text-align: right;">0.601</td>
<td style="text-align: right;">0.322</td>
<td style="text-align: right;">2.271</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">5632.281</td>
<td style="text-align: right;">5695.773</td>
</tr>
<tr class="odd">
<td style="text-align: left;">H[5]</td>
<td style="text-align: right;">-1.779</td>
<td style="text-align: right;">0.618</td>
<td style="text-align: right;">-2.853</td>
<td style="text-align: right;">-0.815</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">6082.938</td>
<td style="text-align: right;">5816.825</td>
</tr>
<tr class="even">
<td style="text-align: left;">H[6]</td>
<td style="text-align: right;">-1.169</td>
<td style="text-align: right;">0.649</td>
<td style="text-align: right;">-2.268</td>
<td style="text-align: right;">-0.170</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">6714.764</td>
<td style="text-align: right;">5139.543</td>
</tr>
<tr class="odd">
<td style="text-align: left;">H[7]</td>
<td style="text-align: right;">-0.234</td>
<td style="text-align: right;">0.588</td>
<td style="text-align: right;">-1.195</td>
<td style="text-align: right;">0.672</td>
<td style="text-align: right;">1.002</td>
<td style="text-align: right;">5076.004</td>
<td style="text-align: right;">5060.476</td>
</tr>
<tr class="even">
<td style="text-align: left;">H[8]</td>
<td style="text-align: right;">1.213</td>
<td style="text-align: right;">0.570</td>
<td style="text-align: right;">0.355</td>
<td style="text-align: right;">2.218</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">4389.700</td>
<td style="text-align: right;">5537.353</td>
</tr>
<tr class="odd">
<td style="text-align: left;">H[9]</td>
<td style="text-align: right;">0.823</td>
<td style="text-align: right;">0.824</td>
<td style="text-align: right;">-0.577</td>
<td style="text-align: right;">2.108</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">5338.110</td>
<td style="text-align: right;">4003.320</td>
</tr>
<tr class="even">
<td style="text-align: left;">D[1]</td>
<td style="text-align: right;">0.461</td>
<td style="text-align: right;">0.253</td>
<td style="text-align: right;">0.097</td>
<td style="text-align: right;">0.932</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">2983.543</td>
<td style="text-align: right;">2565.263</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D[2]</td>
<td style="text-align: right;">0.925</td>
<td style="text-align: right;">0.350</td>
<td style="text-align: right;">0.359</td>
<td style="text-align: right;">1.529</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">2810.568</td>
<td style="text-align: right;">3022.820</td>
</tr>
<tr class="even">
<td style="text-align: left;">D[3]</td>
<td style="text-align: right;">0.251</td>
<td style="text-align: right;">0.186</td>
<td style="text-align: right;">0.022</td>
<td style="text-align: right;">0.613</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3483.762</td>
<td style="text-align: right;">2882.873</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D[4]</td>
<td style="text-align: right;">0.446</td>
<td style="text-align: right;">0.198</td>
<td style="text-align: right;">0.169</td>
<td style="text-align: right;">0.804</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">3765.231</td>
<td style="text-align: right;">3179.683</td>
</tr>
<tr class="even">
<td style="text-align: left;">D[5]</td>
<td style="text-align: right;">0.450</td>
<td style="text-align: right;">0.151</td>
<td style="text-align: right;">0.243</td>
<td style="text-align: right;">0.725</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">5896.061</td>
<td style="text-align: right;">5536.056</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D[6]</td>
<td style="text-align: right;">0.342</td>
<td style="text-align: right;">0.167</td>
<td style="text-align: right;">0.104</td>
<td style="text-align: right;">0.641</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3743.613</td>
<td style="text-align: right;">2423.599</td>
</tr>
<tr class="even">
<td style="text-align: left;">D[7]</td>
<td style="text-align: right;">0.573</td>
<td style="text-align: right;">0.411</td>
<td style="text-align: right;">0.044</td>
<td style="text-align: right;">1.324</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">1909.202</td>
<td style="text-align: right;">3066.287</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D[8]</td>
<td style="text-align: right;">0.621</td>
<td style="text-align: right;">0.245</td>
<td style="text-align: right;">0.285</td>
<td style="text-align: right;">1.069</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">3828.092</td>
<td style="text-align: right;">4701.569</td>
</tr>
<tr class="even">
<td style="text-align: left;">D[9]</td>
<td style="text-align: right;">0.196</td>
<td style="text-align: right;">0.143</td>
<td style="text-align: right;">0.016</td>
<td style="text-align: right;">0.463</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">3181.170</td>
<td style="text-align: right;">2733.067</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">0.824</td>
<td style="text-align: right;">0.050</td>
<td style="text-align: right;">0.745</td>
<td style="text-align: right;">0.909</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">5443.715</td>
<td style="text-align: right;">5411.834</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>Y vemos efectivamente que el uso de la escala de los jueces es considerablemente diferente, y que hemos absorbido parte de la variación con los parámetros <span class="math inline">\(H\)</span> y <span class="math inline">\(D\)</span> (<span class="math inline">\(sigma\)</span> es más baja que en los modelos anteriores):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(ajuste_vinos_3<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"H"</span>, <span class="st">"D"</span>, <span class="st">"sigma"</span>)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(ajuste_vinos_3<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"Q"</span>)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(ajuste_vinos_1<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"Q"</span>)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-52-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Con el modelo completo, examinamos ahora el contraste de interés: ¿hay diferencias en las calificaciones de vinos de diferentes orígenes? La respuesta es que no hay mucha evidencia de que haya una diferencia, aunque hay variación considerable en este contraste:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>ajuste_vinos_3<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"dif_origen"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, q5, q95, rhat, <span class="fu">contains</span>(<span class="st">"ess"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(mean, sd, q5, q95, rhat, ess_bulk, ess_tail), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
  variable     mean    sd    q5   q95  rhat ess_bulk ess_tail
  &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 dif_origen -0.312 0.497 -1.12 0.495  1.00    4087.    4952.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_hist</span>(ajuste_vinos_3<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"dif_origen"</span>), <span class="at">binwidth =</span> <span class="fl">0.07</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="transiciones-divergentes" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="transiciones-divergentes"><span class="header-section-number">8.5</span> Transiciones divergentes</h2>
<p>Finalmente, discutiremos otro tipo de diagnósticos de Stan. Cuando una trayectoria tuvo un cambio grande en energía <span class="math inline">\(H\)</span> desde su valor actual a la propuesta final, usualmente del orden de 10^3 por ejemplo, esto implica un rechazo “fuerte” en el nuevo punto de la trayectoria, e implica que la el integrador numérico falló de manera grave.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Transiciones divergentes
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cuando en Stan obtenemos un número considerable de transiciones divergentes, generalmente esto indica que el integrador numérico de Stan no está funcionando bien, y por lo tanto la exploración puede ser deficiente y/o puede estar sesgada al espacio de parámetros donde no ocurren estos rechazos.</p>
</div>
</div>
<p>Esto puede pasar cuando encontramos zonas de alta curvatura en el espacio de parámetros. Que una posterior esté altamente concentrada o más dispersa generalmente no es un problema, pero si la concentración varía fuertemente (curvatura) entonces puede ser difícil encontrar la escala correcta para que el integrador funcione apropiadamente.</p>
<section id="el-embudo-de-neal" class="level3" data-number="8.5.1">
<h3 data-number="8.5.1" class="anchored" data-anchor-id="el-embudo-de-neal"><span class="header-section-number">8.5.1</span> El embudo de Neal</h3>
<p>Para ver un ejemplo, consideremos un ejemplo de una distribución cuya forma aparecerá más tarde en modelos jerárquicos. Primero, la marginal de <span class="math inline">\(y\)</span> es normal con media 0 y desviación estándar 3. La distribución condicional <span class="math inline">\(p(x|y)\)</span> de <span class="math inline">\(x = c(x_1,\ldots, x_9)\)</span> dado <span class="math inline">\(y\)</span> es normal multivariada, todas con media cero y desviación estándar <span class="math inline">\(e^{y/2}\)</span>. Veamos qué pasa si intentamos simular de esta distribución en Stan:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>mod_embudo <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/embudo-neal.stan"</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>ajuste_embudo <span class="ot">&lt;-</span> mod_embudo<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">1</span>,</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">3000</span>,</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 1 chain...

Chain 1 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 1 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 1 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 1 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 1 finished in 0.1 seconds.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 86 of 3000 (3.0%) transitions ended with a divergence.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 1 of 1 chains had an E-BFMI less than 0.3.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
</div>
<p>Y vemos que aparecen algunos problemas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>simulaciones <span class="ot">&lt;-</span> ajuste_embudo<span class="sc">$</span><span class="fu">draws</span>(<span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>diagnosticos <span class="ot">&lt;-</span> ajuste_embudo<span class="sc">$</span><span class="fu">sampler_diagnostics</span>(<span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>sims_diag <span class="ot">&lt;-</span> simulaciones <span class="sc">|&gt;</span> <span class="fu">inner_join</span>(diagnosticos, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">".draw"</span>, <span class="st">".iteration"</span>, <span class="st">".chain"</span>))</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>ajuste_embudo<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, rhat, <span class="fu">contains</span>(<span class="st">"ess"</span>)) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 5
   variable    mean  rhat ess_bulk ess_tail
   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 lp__     -5.55    1.35     2.45    NA   
 2 y         0.189   1.34     2.46     2.23
 3 x[1]      0.208   1.28  2494.     417.  
 4 x[2]     -0.0835  1.25  1208.     346.  
 5 x[3]     -0.0653  1.18   294.     300.  
 6 x[4]     -0.0787  1.28  1015.     288.  
 7 x[5]     -0.0731  1.28  1912.     251.  
 8 x[6]      0.0298  1.34  2737.     266.  
 9 x[7]      0.0539  1.17   452.     248.  
10 x[8]     -0.0301  1.30  2469.     313.  
11 x[9]      0.0600  1.23  1814.     348.  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sims_diag, <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> <span class="st">`</span><span class="at">x[1]</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> sims_diag <span class="sc">|&gt;</span> <span class="fu">filter</span>(divergent__ <span class="sc">==</span> <span class="dv">1</span>), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fl">2.5</span>, <span class="at">linetype =</span> <span class="dv">2</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Y vemos que hay transiciones divergentes. Cuando el muestreador entra en el cuello del embudo, es muy fácil que se “despeñe” en probabilidad y que no pueda explorar correctamente la forma del cuello. Esto lo podemos ver, por ejemplo, si hacemos más simulaciones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>mod_embudo <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/embudo-neal.stan"</span>)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_embudo)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parameters {
  real y;
  vector[9] x;
}
model {
  y ~ normal(0, 3);
  x ~ normal(0, exp(y/2));
}</code></pre>
</div>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>ajuste_embudo <span class="ot">&lt;-</span> mod_embudo<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">1</span>,</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">30000</span>,</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">10000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 1 chain...

Chain 1 Iteration:     1 / 31000 [  0%]  (Warmup) 
Chain 1 Iteration:  1001 / 31000 [  3%]  (Sampling) 
Chain 1 Iteration: 11000 / 31000 [ 35%]  (Sampling) 
Chain 1 Iteration: 21000 / 31000 [ 67%]  (Sampling) 
Chain 1 Iteration: 31000 / 31000 [100%]  (Sampling) 
Chain 1 finished in 0.8 seconds.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 1200 of 30000 (4.0%) transitions ended with a divergence.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 16 of 30000 (0.0%) transitions hit the maximum treedepth limit of 10.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 1 of 1 chains had an E-BFMI less than 0.3.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>ajuste_embudo<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, rhat, <span class="fu">contains</span>(<span class="st">"ess"</span>)) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 5
   variable      mean  rhat ess_bulk ess_tail
   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 lp__     -14.2      1.01     55.4     13.7
 2 y          2.08     1.01     57.6     27.2
 3 x[1]       0.227    1.00  13728.    2727. 
 4 x[2]       0.175    1.00  10467.    2770. 
 5 x[3]      -0.0281   1.01   6702.    2551. 
 6 x[4]      -0.112    1.01   7941.    2514. 
 7 x[5]      -0.0890   1.01   6287.    2346. 
 8 x[6]       0.0658   1.00  10519.    2765. 
 9 x[7]      -0.121    1.00  12467.    2538. 
10 x[8]      -0.107    1.00   7124.    2443. 
11 x[9]       0.00905  1.00   2954.    2351. </code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>simulaciones <span class="ot">&lt;-</span> ajuste_embudo<span class="sc">$</span><span class="fu">draws</span>(<span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>diagnosticos <span class="ot">&lt;-</span> ajuste_embudo<span class="sc">$</span><span class="fu">sampler_diagnostics</span>(<span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>sims_diag <span class="ot">&lt;-</span> simulaciones <span class="sc">|&gt;</span> <span class="fu">inner_join</span>(diagnosticos, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">".draw"</span>, <span class="st">".iteration"</span>, <span class="st">".chain"</span>))</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sims_diag, <span class="fu">aes</span>(<span class="at">y =</span> y, <span class="at">x =</span> <span class="st">`</span><span class="at">x[1]</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> sims_diag <span class="sc">|&gt;</span> <span class="fu">filter</span>(divergent__ <span class="sc">==</span> <span class="dv">1</span>), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fl">2.5</span>, <span class="at">linetype =</span> <span class="dv">2</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-mcmc_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Y vemos que ahora que en el primer ejemplo estábamos probablemente sobreestimando la media de <span class="math inline">\(y\)</span>. Las divergencias indican que esto puede estar ocurriendo. En este ejemplo particular, también vemos que las R-hat y los tamaños efectivos de muestra son bajos.</p>
<p>Este es un ejemplo extremo. Sin embargo, podemos <em>reparametrizar</em> para hacer las cosas más fáciles para el muestreador. Podemos simular <span class="math inline">\(y\)</span>, y después, simular <span class="math inline">\(x\)</span> como <span class="math inline">\(x \sim e^{y/2} z\)</span> donde <span class="math inline">\(z\)</span> es normal estándar.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>mod_embudo_reparam <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/embudo-neal-reparam.stan"</span>)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_embudo_reparam)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parameters {
  real y;
  vector[9] z;
}

transformed parameters {
  vector[9] x;

  x = exp(y/2) * z;

}

model {
  y ~ normal(0, 3);
  z ~ std_normal();
}</code></pre>
</div>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>ajuste_embudo <span class="ot">&lt;-</span> mod_embudo_reparam<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">10000</span>,</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:     1 / 11000 [  0%]  (Warmup) 
Chain 1 Iteration:  1000 / 11000 [  9%]  (Warmup) 
Chain 1 Iteration:  1001 / 11000 [  9%]  (Sampling) 
Chain 1 Iteration:  2000 / 11000 [ 18%]  (Sampling) 
Chain 1 Iteration:  3000 / 11000 [ 27%]  (Sampling) 
Chain 1 Iteration:  4000 / 11000 [ 36%]  (Sampling) 
Chain 1 Iteration:  5000 / 11000 [ 45%]  (Sampling) 
Chain 1 Iteration:  6000 / 11000 [ 54%]  (Sampling) 
Chain 1 Iteration:  7000 / 11000 [ 63%]  (Sampling) 
Chain 1 Iteration:  8000 / 11000 [ 72%]  (Sampling) 
Chain 1 Iteration:  9000 / 11000 [ 81%]  (Sampling) 
Chain 1 Iteration: 10000 / 11000 [ 90%]  (Sampling) 
Chain 1 Iteration: 11000 / 11000 [100%]  (Sampling) 
Chain 1 finished in 0.2 seconds.
Chain 2 Iteration:     1 / 11000 [  0%]  (Warmup) 
Chain 2 Iteration:  1000 / 11000 [  9%]  (Warmup) 
Chain 2 Iteration:  1001 / 11000 [  9%]  (Sampling) 
Chain 2 Iteration:  2000 / 11000 [ 18%]  (Sampling) 
Chain 2 Iteration:  3000 / 11000 [ 27%]  (Sampling) 
Chain 2 Iteration:  4000 / 11000 [ 36%]  (Sampling) 
Chain 2 Iteration:  5000 / 11000 [ 45%]  (Sampling) 
Chain 2 Iteration:  6000 / 11000 [ 54%]  (Sampling) 
Chain 2 Iteration:  7000 / 11000 [ 63%]  (Sampling) 
Chain 2 Iteration:  8000 / 11000 [ 72%]  (Sampling) 
Chain 2 Iteration:  9000 / 11000 [ 81%]  (Sampling) 
Chain 2 Iteration: 10000 / 11000 [ 90%]  (Sampling) 
Chain 2 Iteration: 11000 / 11000 [100%]  (Sampling) 
Chain 2 finished in 0.2 seconds.
Chain 3 Iteration:     1 / 11000 [  0%]  (Warmup) 
Chain 3 Iteration:  1000 / 11000 [  9%]  (Warmup) 
Chain 3 Iteration:  1001 / 11000 [  9%]  (Sampling) 
Chain 3 Iteration:  2000 / 11000 [ 18%]  (Sampling) 
Chain 3 Iteration:  3000 / 11000 [ 27%]  (Sampling) 
Chain 3 Iteration:  4000 / 11000 [ 36%]  (Sampling) 
Chain 3 Iteration:  5000 / 11000 [ 45%]  (Sampling) 
Chain 3 Iteration:  6000 / 11000 [ 54%]  (Sampling) 
Chain 3 Iteration:  7000 / 11000 [ 63%]  (Sampling) 
Chain 3 Iteration:  8000 / 11000 [ 72%]  (Sampling) 
Chain 3 Iteration:  9000 / 11000 [ 81%]  (Sampling) 
Chain 3 Iteration: 10000 / 11000 [ 90%]  (Sampling) 
Chain 3 Iteration: 11000 / 11000 [100%]  (Sampling) 
Chain 3 finished in 0.2 seconds.
Chain 4 Iteration:     1 / 11000 [  0%]  (Warmup) 
Chain 4 Iteration:  1000 / 11000 [  9%]  (Warmup) 
Chain 4 Iteration:  1001 / 11000 [  9%]  (Sampling) 
Chain 4 Iteration:  2000 / 11000 [ 18%]  (Sampling) 
Chain 4 Iteration:  3000 / 11000 [ 27%]  (Sampling) 
Chain 4 Iteration:  4000 / 11000 [ 36%]  (Sampling) 
Chain 4 Iteration:  5000 / 11000 [ 45%]  (Sampling) 
Chain 4 Iteration:  6000 / 11000 [ 54%]  (Sampling) 
Chain 4 Iteration:  7000 / 11000 [ 63%]  (Sampling) 
Chain 4 Iteration:  8000 / 11000 [ 72%]  (Sampling) 
Chain 4 Iteration:  9000 / 11000 [ 81%]  (Sampling) 
Chain 4 Iteration: 10000 / 11000 [ 90%]  (Sampling) 
Chain 4 Iteration: 11000 / 11000 [100%]  (Sampling) 
Chain 4 finished in 0.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.2 seconds.
Total execution time: 0.9 seconds.</code></pre>
</div>
</div>
<p>Y con este truco de reparametrización el muestreador funciona correctamente (observa que la media de <span class="math inline">\(y\)</span> está estimada correctamente, y no hay divergencias).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>ajuste_embudo<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, rhat, <span class="fu">contains</span>(<span class="st">"ess"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(mean, rhat, ess_bulk, ess_tail), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 5
   variable   mean  rhat ess_bulk ess_tail
   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 lp__     -5.00      1   16285.   24865.
 2 y         0.002     1   74705.   28688.
 3 z[1]     -0.001     1   85160.   29570.
 4 z[2]     -0.002     1   84329.   30159.
 5 z[3]     -0.006     1   83548.   29967.
 6 z[4]      0.002     1   81672.   29573.
 7 z[5]      0         1   81966.   31008.
 8 z[6]     -0.004     1   85319.   29486.
 9 z[7]      0.001     1   85417.   28666.
10 z[8]      0         1   83917.   28876.
11 z[9]      0.004     1   83128.   30034.
12 x[1]     -0.022     1   41969.   31013.
13 x[2]     -0.036     1   39866.   29902.
14 x[3]     -0.133     1   40322.   30635.
15 x[4]      0.023     1   41022.   29315.
16 x[5]     -0.008     1   41923.   31293.
17 x[6]     -0.116     1   41851.   29370.
18 x[7]      0.005     1   42307.   30895.
19 x[8]     -0.043     1   40895.   29853.
20 x[9]     -0.021     1   39208.   28808.</code></pre>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-handbookmc" class="csl-entry" role="listitem">
Brooks, Steve, Andrew Gelman, Galin Jones, y Xiao-Li Meng. 2011. <em>Handbook of Markov Chain Monte Carlo</em>. CRC press.
</div>
<div id="ref-rethinking" class="csl-entry" role="listitem">
McElreath, R. 2020. <em>Statistical Rethinking: A Bayesian Course with Examples in R and Stan</em>. A Chapman &amp; Hall libro. CRC Press. <a href="https://books.google.com.mx/books?id=Ie2vxQEACAAJ">https://books.google.com.mx/books?id=Ie2vxQEACAAJ</a>.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./07-buenos-malos-controles.html" class="pagination-link" aria-label="Buenos y malos controles">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Buenos y malos controles</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./09-modelos-jerarquicos.html" class="pagination-link" aria-label="Modelos jerárquicos">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Modelos jerárquicos</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>
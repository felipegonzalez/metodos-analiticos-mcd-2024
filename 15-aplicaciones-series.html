<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Métodos analíticos - 12&nbsp; Aplicaciones de modelos de espacio de estados</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./14-series-de-tiempo.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Buscar"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./15-aplicaciones-series.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Aplicaciones de modelos de espacio de estados</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Métodos analíticos</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Buscar"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Temario y referencias</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduccion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-flujo-basico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Flujo de trabajo básico: motivación</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-flujo-basico-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Flujo de trabajo básico: refinando el modelo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-modelos-genericos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Componentes de modelación 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-dags.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Modelos gráficos y causalidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-calculo-do.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Identificación y cálculo-do</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-buenos-malos-controles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Buenos y malos controles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-mcmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-modelos-jerarquicos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Modelos jerárquicos</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-exp-naturales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Otros métodos para inferencia causal</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-series-de-tiempo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modelos de espacio de estados</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-aplicaciones-series.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Aplicaciones de modelos de espacio de estados</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#pronósticos" id="toc-pronósticos" class="nav-link active" data-scroll-target="#pronósticos"><span class="header-section-number">12.1</span> Pronósticos</a></li>
  <li><a href="#análisis-de-datos-diarios" id="toc-análisis-de-datos-diarios" class="nav-link" data-scroll-target="#análisis-de-datos-diarios"><span class="header-section-number">12.2</span> Análisis de datos diarios</a>
  <ul class="collapse">
  <li><a href="#estacionalidad-trigonométrica" id="toc-estacionalidad-trigonométrica" class="nav-link" data-scroll-target="#estacionalidad-trigonométrica">Estacionalidad trigonométrica</a></li>
  <li><a href="#días-de-asueto" id="toc-días-de-asueto" class="nav-link" data-scroll-target="#días-de-asueto"><span class="header-section-number">12.2.1</span> Días de asueto</a></li>
  </ul></li>
  <li><a href="#nowcasting-y-uso-de-covariables" id="toc-nowcasting-y-uso-de-covariables" class="nav-link" data-scroll-target="#nowcasting-y-uso-de-covariables"><span class="header-section-number">12.3</span> Nowcasting y uso de covariables</a></li>
  <li><a href="#agregación-de-encuestas" id="toc-agregación-de-encuestas" class="nav-link" data-scroll-target="#agregación-de-encuestas"><span class="header-section-number">12.4</span> Agregación de encuestas</a></li>
  <li><a href="#contrafactuales-de-impacto-causal" id="toc-contrafactuales-de-impacto-causal" class="nav-link" data-scroll-target="#contrafactuales-de-impacto-causal"><span class="header-section-number">12.5</span> Contrafactuales de impacto causal</a>
  <ul class="collapse">
  <li><a href="#modelos-predictivos-del-contrafactual" id="toc-modelos-predictivos-del-contrafactual" class="nav-link" data-scroll-target="#modelos-predictivos-del-contrafactual"><span class="header-section-number">12.5.1</span> Modelos predictivos del contrafactual</a></li>
  <li><a href="#ejemplo-1" id="toc-ejemplo-1" class="nav-link" data-scroll-target="#ejemplo-1"><span class="header-section-number">12.5.2</span> Ejemplo 1</a></li>
  <li><a href="#ejemplo" id="toc-ejemplo" class="nav-link" data-scroll-target="#ejemplo">Ejemplo</a></li>
  <li><a href="#ejemplo-2" id="toc-ejemplo-2" class="nav-link" data-scroll-target="#ejemplo-2">Ejemplo 2</a></li>
  </ul></li>
  <li><a href="#ejemplo-cinturones-de-seguridad" id="toc-ejemplo-cinturones-de-seguridad" class="nav-link" data-scroll-target="#ejemplo-cinturones-de-seguridad"><span class="header-section-number">12.6</span> Ejemplo: cinturones de seguridad</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Aplicaciones de modelos de espacio de estados</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DiagrammeR)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CausalImpact)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>locale <span class="ot">&lt;-</span> <span class="fu">Sys.setlocale</span>(<span class="st">"LC_TIME"</span>, <span class="st">"es_ES.UTF-8"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tsibble)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(feasts)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">theme_set</span>(ggplot2<span class="sc">::</span><span class="fu">theme_light</span>())</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="pronósticos" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="pronósticos"><span class="header-section-number">12.1</span> Pronósticos</h2>
<p>Consideramos un ejemplo de <span class="citation" data-cites="hyndman2014">Hyndman y Athanasopoulos (<a href="#ref-hyndman2014" role="doc-biblioref">2014</a>)</span> <a href="https://otexts.com/fpp3/seasonal-arima.html">en la esta sección</a>, donde buscamos hacer pronósticos de empleo en Estados Unidos. Consideramos los datos de entretenimiento y hospitalidad:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../datos/us_employment.rda"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ent_hosp_tbl <span class="ot">&lt;-</span> <span class="fu">filter</span>(us_employment, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  Title <span class="sc">==</span> <span class="st">"Leisure and Hospitality"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter_index</span>(<span class="st">"2000-01"</span> <span class="sc">~</span> . )</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>ent_hosp_ts <span class="ot">&lt;-</span> ent_hosp_tbl <span class="sc">|&gt;</span> <span class="fu">as.ts</span>(Employed)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#ent_hosp_ts &lt;- log(ent_hosp_ts)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(ent_hosp_tbl, Employed)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Intentaremos usar varios modelos, incluso algunos que claramente no son correctos:</p>
<ol type="1">
<li>Nivel local</li>
<li>Nivel local y tendencia</li>
<li>Nivel local con estacionalidad (12 meses)</li>
<li>Nivel local con tendencia y estacionalidad (12 meses)</li>
<li>Nivel semilocal con tendencia y estacionalidad</li>
<li>Nivel semilocal con tendencia, estacionalidad, y una componente autoregresiva.</li>
</ol>
<p>En este ejemplo usaremos el paquete <em>bsts</em> que implementa modelos de espacio de estados usuales de manera relativamente fácil y rápida (aunque es necesario hacer diagnósticos aparte), y tiene algunas funciones convenientes para evaluar pronósticos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bsts)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">998</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#inicial_nivel &lt;- NormalPrior(11000, 1500, initial.value = 11000)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>mod_spec_1 <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>mod_spec_2 <span class="ot">&lt;-</span> <span class="fu">AddLocalLinearTrend</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>mod_spec_3 <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts) <span class="sc">|&gt;</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">12</span>, <span class="at">y =</span> ent_hosp_ts)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>mod_spec_4 <span class="ot">&lt;-</span> <span class="fu">AddLocalLinearTrend</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts) <span class="sc">|&gt;</span> </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">12</span>, <span class="at">y =</span> ent_hosp_ts) </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>mod_spec_5 <span class="ot">&lt;-</span> <span class="fu">AddSemilocalLinearTrend</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts) <span class="sc">|&gt;</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">12</span>, <span class="at">y =</span> ent_hosp_ts) </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>mod_spec_6 <span class="ot">&lt;-</span> <span class="fu">AddSemilocalLinearTrend</span>(<span class="fu">list</span>(), <span class="at">y =</span> ent_hosp_ts) <span class="sc">|&gt;</span> </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">12</span>, <span class="at">y =</span> ent_hosp_ts) <span class="sc">|&gt;</span> </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddAr</span>(<span class="at">lags =</span> <span class="dv">2</span>, <span class="at">y =</span> ent_hosp_ts)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>specs <span class="ot">&lt;-</span> <span class="fu">list</span>(mod_spec_1, mod_spec_2, mod_spec_3, mod_spec_4, mod_spec_5, mod_spec_6)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>ajustes <span class="ot">&lt;-</span> <span class="fu">map</span>(specs, <span class="cf">function</span>(spec){</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bsts</span>(ent_hosp_ts, spec, <span class="at">niter =</span> <span class="dv">40000</span>, <span class="at">ping =</span> <span class="dv">10000</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Wed May 15 00:31:01 2024 =-=-=-=-=
=-=-=-=-= Iteration 10000 Wed May 15 00:31:10 2024 =-=-=-=-=
=-=-=-=-= Iteration 20000 Wed May 15 00:31:19 2024 =-=-=-=-=
=-=-=-=-= Iteration 30000 Wed May 15 00:31:28 2024 =-=-=-=-=
=-=-=-=-= Iteration 0 Wed May 15 00:31:37 2024 =-=-=-=-=
=-=-=-=-= Iteration 10000 Wed May 15 00:31:49 2024 =-=-=-=-=
=-=-=-=-= Iteration 20000 Wed May 15 00:32:00 2024 =-=-=-=-=
=-=-=-=-= Iteration 30000 Wed May 15 00:32:12 2024 =-=-=-=-=
=-=-=-=-= Iteration 0 Wed May 15 00:32:23 2024 =-=-=-=-=
=-=-=-=-= Iteration 10000 Wed May 15 00:32:49 2024 =-=-=-=-=
=-=-=-=-= Iteration 20000 Wed May 15 00:33:15 2024 =-=-=-=-=
=-=-=-=-= Iteration 30000 Wed May 15 00:33:41 2024 =-=-=-=-=
=-=-=-=-= Iteration 0 Wed May 15 00:34:07 2024 =-=-=-=-=
=-=-=-=-= Iteration 10000 Wed May 15 00:34:39 2024 =-=-=-=-=
=-=-=-=-= Iteration 20000 Wed May 15 00:35:11 2024 =-=-=-=-=
=-=-=-=-= Iteration 30000 Wed May 15 00:35:43 2024 =-=-=-=-=
=-=-=-=-= Iteration 0 Wed May 15 00:36:15 2024 =-=-=-=-=
=-=-=-=-= Iteration 10000 Wed May 15 00:36:47 2024 =-=-=-=-=
=-=-=-=-= Iteration 20000 Wed May 15 00:37:20 2024 =-=-=-=-=
=-=-=-=-= Iteration 30000 Wed May 15 00:37:52 2024 =-=-=-=-=
=-=-=-=-= Iteration 0 Wed May 15 00:38:24 2024 =-=-=-=-=
=-=-=-=-= Iteration 10000 Wed May 15 00:39:09 2024 =-=-=-=-=
=-=-=-=-= Iteration 20000 Wed May 15 00:39:54 2024 =-=-=-=-=
=-=-=-=-= Iteration 30000 Wed May 15 00:40:40 2024 =-=-=-=-=</code></pre>
</div>
</div>
<p>En primer lugar, podemos comparar las predicciones a un paso de cada modelo. En este caso, los modelos 3 y 4 son claramente superiores a 1 y 2 en desempeño a un paso. El mejor modelo en desempeño a un paso es el modelo 4, por la tendencia lineal de la serie.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CompareBstsModels</span>(ajustes, <span class="at">burn =</span> <span class="dv">20000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> ajustes[[<span class="dv">6</span>]]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ajuste, <span class="st">"components"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pred_errors_tbl <span class="ot">&lt;-</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bsts.prediction.errors</span>(ajuste, <span class="at">burn =</span> <span class="dv">20000</span>)<span class="sc">$</span>in.sample <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">t =</span> <span class="dv">1</span><span class="sc">:</span> <span class="fu">length</span>(ent_hosp_ts)) <span class="sc">|&gt;</span> </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(t), <span class="at">names_to =</span> <span class="st">"sim"</span>, <span class="at">values_to =</span> <span class="st">"valor"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(t) <span class="sc">|&gt;</span> </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">valor =</span> <span class="fu">mean</span>(valor)) <span class="sc">|&gt;</span> </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> t)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `x` argument of `as_tibble.matrix()` must have unique column names if
`.name_repair` is omitted as of tibble 2.0.0.
ℹ Using compatibility `.name_repair`.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filtramos a partir de 12 meses (mínimo requerido para</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># estimar estacionalidad):</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ACF</span>(pred_errors_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(t <span class="sc">&gt;</span> <span class="dv">12</span>), valor, <span class="at">lag_max =</span> <span class="dv">20</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Ahora podemos hacer pronósticos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> ajustes[[<span class="dv">6</span>]]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste, <span class="at">horizon =</span> <span class="dv">36</span>, <span class="at">burn =</span> <span class="dv">30000</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(pred)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Podemos hacer también pronósticos agregados. Como tenemos simulaciones de los pronósticos, esto es fácil, incluyendo intervalos predictivos. En el siguiente ejemplo, hacemos un intervalo para la suma de los 36 meses que pronosticamos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>pred<span class="sc">$</span>distribution <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10000    36</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(pred<span class="sc">$</span>distribution, <span class="dv">1</span>, sum) <span class="sc">|&gt;</span> <span class="fu">qplot</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `qplot()` was deprecated in ggplot2 3.4.0.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="384"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Intervalo de 90% para el agregado:"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Intervalo de 90% para el agregado:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(pred<span class="sc">$</span>distribution, <span class="dv">1</span>, sum) <span class="sc">|&gt;</span> <span class="fu">quantile</span>(<span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.50</span>, <span class="fl">0.95</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      5%      50%      95% 
599633.6 617666.4 635369.1 </code></pre>
</div>
</div>
</section>
<section id="análisis-de-datos-diarios" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="análisis-de-datos-diarios"><span class="header-section-number">12.2</span> Análisis de datos diarios</h2>
<p>Consideremos por ejemplo la siguiente serie de nacimientos por día en México (ver la sección de introducción de series de tiempo):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>natalidad_tbl <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"../datos/natalidad.rds"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(fecha) <span class="sc">|&gt;</span> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(fecha <span class="sc">&gt;=</span> <span class="fu">ymd</span>(<span class="st">"2008-01-01"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nacimientos =</span> <span class="fu">log</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>fecha_str, <span class="sc">-</span>n) <span class="sc">|&gt;</span> </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> fecha)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> natalidad_tbl <span class="sc">|&gt;</span> <span class="fu">as.ts</span>(<span class="at">frequency =</span> <span class="fl">365.25</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">zoo</span>(natalidad_tbl<span class="sc">$</span>nacimientos, natalidad_tbl<span class="sc">$</span>fecha)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>natalidad_tbl <span class="ot">&lt;-</span> natalidad_tbl <span class="sc">|&gt;</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feb_29 =</span> <span class="fu">as.numeric</span>(<span class="fu">month</span>(fecha)<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> <span class="fu">day</span>(fecha) <span class="sc">==</span> <span class="dv">29</span>))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>feb_29 <span class="ot">&lt;-</span> natalidad_tbl<span class="sc">$</span>feb_29</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>mar_1_feb_29 <span class="ot">&lt;-</span> <span class="fu">lag</span>(feb_29, <span class="at">default =</span> <span class="dv">0</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En este caso, es necesario:</p>
<ul>
<li>Agregar estacionalidad con periodo de 7 días</li>
<li>Agregar estacionalidad con periodo de 1 año</li>
<li>Agregar efectos de días de asueto, incluyendo posibles efectos que no ocurren solamente el día en cuestión, sino en los “hombros” del día (unos días antes o después).</li>
</ul>
<p>La estacionalidad anual la modelamos con armónicos de periodo 365.25, es decir, con <span class="math inline">\(\lambda_j = 2\pi j /365.25\)</span>. Cada armónico agrega dos coeficientes al espacio de estados.</p>
<section id="estacionalidad-trigonométrica" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="estacionalidad-trigonométrica">Estacionalidad trigonométrica</h3>
<p>Supongamos que queremos modelar estacionalidad anual para datos mensuales usando armónicos. El primer armónico tiene un ciclo de 12 meses, así que ponemos <span class="math display">\[\lambda_1 = 2\pi /12 = \pi/6\]</span> Consideramos las funciones</p>
<p><span class="math display">\[f_1(t) = a\cos(\lambda_1 t) + b \sin(\lambda_1 t)\]</span></p>
<p>Con el tamaño de a y b se define la amplitud, y la fase depende de los tamaños relativos de <span class="math inline">\(a\)</span> y <span class="math inline">\(b\)</span>. Esto lo podemos ver, por ejemplo, notando que <span class="math inline">\(a\sin x + b\cos x = \sqrt{a^2 + b^2}\sin(x + \alpha)\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>arm_1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">t=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">f_1 =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">cos</span>(t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>) <span class="sc">+</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fu">sin</span>(t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">t=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">f_1 =</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">cos</span>(t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>) <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">*</span> <span class="fu">sin</span>(t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">2</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(arm_1, <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> f_1, <span class="at">colour =</span> <span class="fu">factor</span>(n))) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">13</span>, <span class="dv">25</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Podemos considerar armónicos más altos. El siguiente es</p>
<p><span class="math display">\[f_2(t) = f_1(t) + a_2\cos(2\lambda_1 t) + b_2 \sin(2\lambda_1 t)\]</span> para obtener una funciones como las que siguen:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>arm_2 <span class="ot">&lt;-</span> arm_1 <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">f_2 =</span> f_1 <span class="sc">+</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">*</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>) <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> t <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">6</span>))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(arm_2, <span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> f_2, <span class="at">colour =</span> <span class="fu">factor</span>(n))) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">13</span>, <span class="dv">25</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Y así sucesivamente. Cualquier función periodica puede aproximarse bien mediante una suma de cosenos y senos, siempre y cuando utilicemos suficientes armónicos.</p>
<p>Nota que en los ejemplos de arriba necesitamos dos coeficientes para cada armónico. La componente estacional del modelo podemos escribirla como (para estacionalidad constante):</p>
<p><span class="math display">\[\gamma_t = \sum_{j=1}^L (a_j \cos(\lambda_j t) + a^*_j \sin(\lambda_jt)).\]</span> Y hacemos estocásticas estas componentes sustituyendo <span class="math display">\[a_{j,t+1} = a_{j,t} + \omega_{j,t},  a^*_{j,t+1} = a^*_{j,t} + \omega^*_{j,t}\]</span> donde las <span class="math inline">\(\omega,\omega^*\)</span> son normales independientes con varianza <span class="math inline">\(\sigma_\omega^2\)</span>.</p>
<p>Esta es la forma más simple de agregar estacionalidad trigonométrica, pero tiene la desventaja de que los errores que agregamos se multiplican después por senos y cosenos, lo cual quiere decir que su efecto no es igual en diferentes partes del periodo. La otra forma más usual puedes verla en la ayuda de <em>AddTrig</em> de bsts o en la sección 3.2.1 de <span class="citation" data-cites="durbinkoopman">Durbin y Koopman (<a href="#ref-durbinkoopman" role="doc-biblioref">2001</a>)</span>.</p>
<hr>
<p>Nuestra primera parte del modelo es entonces (donde podemos ajustar el número de frecuencias o armónicos que incluímos comparando los modelos producidos):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>modelo_natalidad_1 <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(), <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">7</span>, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddTrig</span>(<span class="at">period =</span> <span class="fl">365.25</span>, <span class="at">frequencies =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y =</span> y) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="días-de-asueto" class="level3" data-number="12.2.1">
<h3 data-number="12.2.1" class="anchored" data-anchor-id="días-de-asueto"><span class="header-section-number">12.2.1</span> Días de asueto</h3>
<p>Definiremos componentes para algunos de los días de asueto/especiales más importantes, considerando que su efecto puede ir más allá del día particular. En la versión estática, tenemos un coeficiente distinto para cada uno de esos días en la ventana que hayamos elegido:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>año_nuevo <span class="ot">&lt;-</span> <span class="fu">NamedHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"NewYearsDay"</span>, <span class="at">days.before =</span> <span class="dv">4</span>,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">days.after =</span> <span class="dv">4</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>navidad <span class="ot">&lt;-</span> <span class="fu">NamedHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"Christmas"</span>, <span class="at">days.before =</span> <span class="dv">4</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">days.after =</span> <span class="dv">4</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>pascua <span class="ot">&lt;-</span> <span class="fu">NamedHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"EasterSunday"</span>, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">days.after =</span> <span class="dv">5</span>, <span class="at">days.before =</span> <span class="dv">5</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>feb_14 <span class="ot">&lt;-</span> <span class="fu">NamedHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"ValentinesDay"</span>, </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">days.after =</span> <span class="dv">3</span>, <span class="at">days.before =</span> <span class="dv">3</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>halloween <span class="ot">&lt;-</span> <span class="fu">NamedHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"Halloween"</span>, </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">days.after =</span> <span class="dv">5</span>, <span class="at">days.before =</span> <span class="dv">5</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>sept_16 <span class="ot">&lt;-</span> <span class="fu">FixedDateHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"Independencia"</span>, </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>                        <span class="at">month =</span> <span class="st">"September"</span>, <span class="at">day =</span> <span class="dv">16</span>, <span class="at">days.before =</span> <span class="dv">2</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">days.after =</span> <span class="dv">2</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>mayo_1 <span class="ot">&lt;-</span> <span class="fu">FixedDateHoliday</span>(<span class="at">holiday.name =</span> <span class="st">"Trabajo"</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">month =</span> <span class="st">"May"</span>, <span class="at">day =</span> <span class="dv">1</span>, <span class="at">days.before =</span> <span class="dv">2</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">days.after =</span> <span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Y nuestro modelo es entonces, agregando también un coeficiente para febrero 29 y marzo 1 cuando sigue de 29 de febrero:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>modelo_natalidad <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(), <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">7</span>, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddTrig</span>(<span class="at">period =</span> <span class="fl">365.25</span>, <span class="at">frequencies =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> año_nuevo, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> navidad, <span class="at">y =</span> y,) <span class="sc">|&gt;</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> pascua, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> feb_14, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> halloween, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> sept_16, <span class="at">y =</span> y) <span class="sc">|&gt;</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddRandomWalkHoliday</span>(<span class="at">holiday =</span> mayo_1, <span class="at">y =</span> y) <span class="sc">|&gt;</span> </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddDynamicRegression</span>(y <span class="sc">~</span> feb_29 <span class="sc">+</span> mar_1_feb_29)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ajuste_nat &lt;- bsts(y, modelo_natalidad, niter = 1000)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>ajuste_nat <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"cache/ajuste_nat.rds"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>mean_contrib <span class="ot">&lt;-</span> ajuste_nat<span class="sc">$</span>state.contributions <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), mean)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>mean_contrib_tbl <span class="ot">&lt;-</span> mean_contrib <span class="sc">|&gt;</span> <span class="fu">t</span>() <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fecha =</span> natalidad_tbl<span class="sc">$</span>fecha) <span class="sc">|&gt;</span> </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trend_c =</span> trend <span class="sc">-</span> <span class="fu">mean</span>(trend)) <span class="sc">|&gt;</span> </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>trend) <span class="sc">|&gt;</span> </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(seasonal.<span class="fl">7.1</span><span class="sc">:</span>dynamic, trend_c),</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"componente"</span>, <span class="at">values_to =</span> <span class="st">"valor"</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mean_contrib_tbl, <span class="fu">aes</span>(<span class="at">x =</span> fecha, <span class="at">y =</span> valor)) <span class="sc">+</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> componente) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Podemos ver con más detalle cómo es el efecto de los días de asueto y sus “hombros”, tomando por ejemplo una parte 2008-2009 vemos la estructura:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mean_contrib_tbl <span class="sc">|&gt;</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>         <span class="fu">filter</span>(<span class="fu">year</span>(fecha) <span class="sc">==</span> <span class="dv">2009</span> <span class="sc">&amp;</span> <span class="fu">month</span>(fecha) <span class="sc">&lt;</span> <span class="dv">5</span> <span class="sc">|</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">year</span>(fecha) <span class="sc">==</span> <span class="dv">2008</span> <span class="sc">&amp;</span> <span class="fu">month</span>(fecha) <span class="sc">&gt;=</span> <span class="dv">12</span>), </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> fecha, <span class="at">y =</span> valor)) <span class="sc">+</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> componente) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Nota</strong>: este modelo todavía requiere considerar qué otros efectos adicionales están actuando. La distribución de errores a un paso tiene colas largas, y todavía hay cierta información que podríamos usar para mejorar las predicción si consideramos la ACF de las innovaciones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>error <span class="ot">&lt;-</span> ajuste_nat<span class="sc">$</span>one.step.prediction.errors <span class="sc">|&gt;</span> <span class="fu">apply</span>(<span class="dv">2</span>, mean)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>error_sin_2008 <span class="ot">&lt;-</span> error[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">365</span>)]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(error_sin_2008)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(error_sin_2008)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>natalidad_tbl<span class="sc">$</span>error <span class="ot">&lt;-</span> error</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ACF</span>(natalidad_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">year</span>(fecha) <span class="sc">&gt;</span> <span class="dv">2008</span>), </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    error) <span class="sc">|&gt;</span> <span class="fu">autoplot</span>() <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>natalidad_tbl <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(fecha) <span class="sc">&gt;</span> <span class="dv">2008</span>) <span class="sc">|&gt;</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(error))) <span class="sc">|&gt;</span> </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dia_sem =</span> <span class="fu">weekdays</span>(fecha)) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Current temporal ordering may yield unexpected results.
ℹ Suggest to sort by ``, `fecha` first.
Current temporal ordering may yield unexpected results.
ℹ Suggest to sort by ``, `fecha` first.
Current temporal ordering may yield unexpected results.
ℹ Suggest to sort by ``, `fecha` first.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 2,922 x 5 [1D]
   fecha      nacimientos feb_29  error dia_sem
   &lt;date&gt;           &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  
 1 2013-01-01        8.45      0 -0.202 martes 
 2 2009-11-02        8.64      0 -0.184 lunes  
 3 2012-12-25        8.47      0 -0.181 martes 
 4 2012-09-16        8.66      0  0.174 domingo
 5 2016-11-21        8.49      0 -0.172 lunes  
 6 2016-12-25        8.15      0  0.166 domingo
 7 2015-11-16        8.56      0 -0.157 lunes  
 8 2012-11-19        8.66      0 -0.150 lunes  
 9 2014-03-17        8.55      0 -0.148 lunes  
10 2011-11-21        8.69      0 -0.147 lunes  
# ℹ 2,912 more rows</code></pre>
</div>
</div>
<ul>
<li>En la tabla de arriba vemos que falta incluir algunos otros días de asueto, los que feriados que se mueven a los lunes.</li>
<li>También días feriados con fecha fija que caen en Domingo tienen un efecto distinto (es posible construir manualmente la serie de días de asueto excluyendo los feriados que caen en domingo, por ejemplo).</li>
</ul>
</section>
</section>
<section id="nowcasting-y-uso-de-covariables" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="nowcasting-y-uso-de-covariables"><span class="header-section-number">12.3</span> Nowcasting y uso de covariables</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Nowcasting
</div>
</div>
<div class="callout-body-container callout-body">
<p>En nowcasting buscamos predecir los valores contemporáneos de una serie de tiempo que, por retrasos en reporte, no tenemos disponibles. Usualmente utilizamos variables asociadas contemporáneas que sí están disponibles, y se trata de pronósticos a corto plazo</p>
</div>
</div>
<p>Un ejemplo es el indicador oportuno de actividad económica que se publica mensualmente. Este indicador busca estimar el IGAE (indicador global de actividad económica), y utiliza variables económicas, financieras y otras, disponibles al momento (mientras que el IGAE se publica con unos dos meses de retraso). Ver aquí: https://www.inegi.org.mx/investigacion/ioae/.</p>
<p>Una estrategia puede ser incluír variables relevantes cómo en regresión dinámica. Sin embargo, si estamos buscando entre una cantidad relativamente grande de predictores, es posible obtener mejores resultados haciendo selección de variables. En el caso de <em>bsts</em> se utiliza una inicial de <em>spike-slab</em>, que es una mezcla de una masa de probabilidad mayor a 0 para un valor del coeficiente igual a 0 (es decir, la variable está excluída del modelo), y una distribución normal centrada en 0 (el coeficiente puede tomar un valor positivo o negativo).</p>
<p>En este ejemplo consideraremos (<span class="citation" data-cites="scottvarian2015">Scott y Varian (<a href="#ref-scottvarian2015" role="doc-biblioref">2015</a>)</span>) el pronóstico oportuno de los números semanales reclamaciones pagos de seguro de desempleo en Estados Unidos, que se reportan varios días después de que cierra cada semana. En el artículo citado, utilizan medidas relativa de popularidad de búsquedas relacionadas con desempleo en Google, que se pueden tener de manera completa en cuanto la semana cierra. Ver también <a href="https://www.nber.org/system/files/working_papers/w19567/w19567.pdf">aquí</a> o <a href="https://www.unofficialgoogledatascience.com/2017/07/fitting-bayesian-structural-time-series.html">aquí</a>.</p>
<p>Este código está adaptado de <a href="https://www.unofficialgoogledatascience.com/2017/07/fitting-bayesian-structural-time-series.html">aqui</a>, ver también <a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/41335.pdf">este reporte</a>.</p>
<p>Primero construiremos un modelo con tendencia lineal y estacionalidad. En este caso, como consideramos una serie relativamente corta (no más de 10 años), y la estacionalidad es dinámica, podemos usar un periodo de 52 semanas, aún cuando sabemos que algunos años tienen 53 semanas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(iclaims)     </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>original.claims <span class="ot">&lt;-</span> initial.claims</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>initial.claims <span class="ot">&lt;-</span> original.claims[<span class="dv">1</span><span class="sc">:</span><span class="dv">436</span>, ]</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>new.data <span class="ot">&lt;-</span> original.claims[<span class="dv">437</span><span class="sc">:</span><span class="dv">456</span>, ]</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">AddLocalLinearTrend</span>(<span class="fu">list</span>(), initial.claims<span class="sc">$</span>iclaimsNSA)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">AddSeasonal</span>(ss, initial.claims<span class="sc">$</span>iclaimsNSA, <span class="at">nseasons =</span> <span class="dv">52</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(initial.claims<span class="sc">$</span>iclaimsNSA,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">state.specification =</span> ss,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">niter =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Wed May 15 00:41:35 2024 =-=-=-=-=
=-=-=-=-= Iteration 100 Wed May 15 00:41:39 2024 =-=-=-=-=
=-=-=-=-= Iteration 200 Wed May 15 00:41:43 2024 =-=-=-=-=
=-=-=-=-= Iteration 300 Wed May 15 00:41:46 2024 =-=-=-=-=
=-=-=-=-= Iteration 400 Wed May 15 00:41:50 2024 =-=-=-=-=
=-=-=-=-= Iteration 500 Wed May 15 00:41:54 2024 =-=-=-=-=
=-=-=-=-= Iteration 600 Wed May 15 00:41:57 2024 =-=-=-=-=
=-=-=-=-= Iteration 700 Wed May 15 00:42:01 2024 =-=-=-=-=
=-=-=-=-= Iteration 800 Wed May 15 00:42:05 2024 =-=-=-=-=
=-=-=-=-= Iteration 900 Wed May 15 00:42:08 2024 =-=-=-=-=</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model1)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model1, <span class="st">"components"</span>)  </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-22-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Y podemos construir predicciones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>pred1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(model1, <span class="at">horizon =</span> <span class="dv">12</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred1, <span class="at">plot.original =</span> <span class="dv">156</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Entre las variables de términos de búsqueda están</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(initial.claims)[<span class="sc">-</span><span class="dv">1</span>]</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "michigan.unemployment"      "idaho.unemployment"        
 [3] "pennsylvania.unemployment"  "unemployment.filing"       
 [5] "new.jersey.unemployment"    "department.of.unemployment"
 [7] "illinois.unemployment"      "rhode.island.unemployment" 
 [9] "unemployment.office"        "filing.unemployment"       </code></pre>
</div>
</div>
<p>Seleccionamos una inicial para el tamaño esperado del modelo (y después seleccionamos según desempeño predictivo):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(iclaimsNSA <span class="sc">~</span> .,</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">state.specification =</span> ss,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">niter =</span> <span class="dv">1000</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> initial.claims, </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">expected.model.size =</span> <span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Wed May 15 00:42:13 2024 =-=-=-=-=
=-=-=-=-= Iteration 100 Wed May 15 00:42:17 2024 =-=-=-=-=
=-=-=-=-= Iteration 200 Wed May 15 00:42:20 2024 =-=-=-=-=
=-=-=-=-= Iteration 300 Wed May 15 00:42:24 2024 =-=-=-=-=
=-=-=-=-= Iteration 400 Wed May 15 00:42:28 2024 =-=-=-=-=
=-=-=-=-= Iteration 500 Wed May 15 00:42:31 2024 =-=-=-=-=
=-=-=-=-= Iteration 600 Wed May 15 00:42:35 2024 =-=-=-=-=
=-=-=-=-= Iteration 700 Wed May 15 00:42:39 2024 =-=-=-=-=
=-=-=-=-= Iteration 800 Wed May 15 00:42:42 2024 =-=-=-=-=
=-=-=-=-= Iteration 900 Wed May 15 00:42:46 2024 =-=-=-=-=</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(iclaimsNSA <span class="sc">~</span> .,</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">state.specification =</span> ss,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">niter =</span> <span class="dv">1000</span>,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> initial.claims,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">expected.model.size =</span> <span class="dv">6</span>)  <span class="co"># Passed to SpikeSlabPrior.</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Wed May 15 00:42:50 2024 =-=-=-=-=
=-=-=-=-= Iteration 100 Wed May 15 00:42:53 2024 =-=-=-=-=
=-=-=-=-= Iteration 200 Wed May 15 00:42:57 2024 =-=-=-=-=
=-=-=-=-= Iteration 300 Wed May 15 00:43:01 2024 =-=-=-=-=
=-=-=-=-= Iteration 400 Wed May 15 00:43:05 2024 =-=-=-=-=
=-=-=-=-= Iteration 500 Wed May 15 00:43:08 2024 =-=-=-=-=
=-=-=-=-= Iteration 600 Wed May 15 00:43:12 2024 =-=-=-=-=
=-=-=-=-= Iteration 700 Wed May 15 00:43:16 2024 =-=-=-=-=
=-=-=-=-= Iteration 800 Wed May 15 00:43:19 2024 =-=-=-=-=
=-=-=-=-= Iteration 900 Wed May 15 00:43:23 2024 =-=-=-=-=</code></pre>
</div>
</div>
<p>Comparamos los modelos con el error de pronóstico a un paso, y el modelo 2 es el de mejor desempeño:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CompareBstsModels</span>(<span class="fu">list</span>(<span class="st">"Modelo s.vars"</span> <span class="ot">=</span> model1,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Modelo esp2"</span> <span class="ot">=</span> model2,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Modelo esp6"</span> <span class="ot">=</span> model3),</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>pred2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(model2, <span class="at">horizon =</span> <span class="dv">12</span>, <span class="at">newdata =</span> new.data[<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, ])</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred2, <span class="at">plot.original =</span> <span class="dv">156</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Podemos ver qué variables fueron seleccionadas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model2, <span class="st">"coefficients"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="agregación-de-encuestas" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="agregación-de-encuestas"><span class="header-section-number">12.4</span> Agregación de encuestas</h2>
<p>Para cada elección, se publica en México un gran número de encuestas sobre las preferencias partidistas. Con el fin de obtener una estimación de las preferencias subyacentes, las encuestas pueden combinarse en una encuesta de encuestas. Mostramos un modelo dinámico bayesiano para combinar encuestas y producir una única estimación.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>mex_2018_tbl <span class="ot">&lt;-</span> </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(<span class="st">"../datos/wiki_encuestas_2018_en_campana.csv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id_encuesta =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id_encuesta, <span class="fu">everything</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Muestra =</span> <span class="fu">as.numeric</span>(Muestra)) <span class="sc">|&gt;</span> </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">margen_error =</span> <span class="fu">str_remove</span>(<span class="st">`</span><span class="at">Margen de error</span><span class="st">`</span>, <span class="st">"±"</span> )) <span class="sc">|&gt;</span> </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">margen_error =</span> <span class="fu">as.numeric</span>(margen_error)) <span class="sc">|&gt;</span> </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">no_contesto =</span> </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="st">`</span><span class="at">Ninguno Nulo/Blanco</span><span class="st">`</span>, <span class="st">`</span><span class="at">NC/NS</span><span class="st">`</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">`</span><span class="at">Margen de error</span><span class="st">`</span>, <span class="st">`</span><span class="at">Ninguno Nulo/Blanco</span><span class="st">`</span>, <span class="st">`</span><span class="at">NC/NS</span><span class="st">`</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Zavala =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(Zavala), <span class="dv">0</span>, Zavala)) <span class="sc">|&gt;</span> </span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(Rodríguez <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(Rodríguez ), <span class="dv">0</span>, Rodríguez )) <span class="sc">|&gt;</span> </span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Otros =</span> Zavala <span class="sc">+</span> Rodríguez) <span class="sc">|&gt;</span> </span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">publicacion =</span> <span class="fu">dmy</span>(<span class="fu">paste</span>(<span class="st">`</span><span class="at">Publicación (2018)</span><span class="st">`</span>, <span class="dv">2018</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id_encuesta, Encuestadora, publicacion, Muestra, </span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>         Obrador<span class="sc">:</span>Meade, Otros, no_contesto, margen_error)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Generalmente las casas encuestadores usan una fórmula simple para el error, como si fuera muestreo aleatorio simple, que rara vez se usa en la práctica (para encuestas casa por casa, por ejemplo), y no toma el cuenta de que muchas veces se usan reponderaciones de los datos. Ambas cosas generalmente producen varianzas considerablemente más altas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mex_2018_tbl, <span class="fu">aes</span>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> margen_error, <span class="at">y =</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">/</span> <span class="fu">sqrt</span>(Muestra),<span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_abline</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 11 rows containing missing values or values outside the scale range
(`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Supondremos margen de error de 6 para aquellos que no reportan tamaño de muestra o error, y usamos un factor de diseño igual a 2. Adicionalmente, como buscamos preferencias efectivas, descontamos aquellos que no reportaron preferencia:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># suponemos margen de error 6 para las que no reportan</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co"># generalmente se reporta el error para un porcentaje de 50%</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># como si fuera muestreo aleatorio simple</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Usamos un factor de diseño igual a 2</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>mex_2018_tbl <span class="ot">&lt;-</span> mex_2018_tbl <span class="sc">|&gt;</span> </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">margen_error =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(margen_error), <span class="dv">6</span>, margen_error)) <span class="sc">|&gt;</span> </span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_inf =</span> (<span class="dv">100</span> <span class="sc">/</span> (<span class="fu">sqrt</span>(<span class="dv">2</span>) <span class="sc">*</span> margen_error))<span class="sc">^</span><span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_efectiva =</span> n_inf <span class="sc">*</span> (Obrador <span class="sc">+</span> Anaya <span class="sc">+</span> Meade <span class="sc">+</span> Otros)<span class="sc">/</span><span class="dv">100</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finalmente, normalizamos a preferencia efectiva:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>pref_tbl <span class="ot">&lt;-</span> mex_2018_tbl <span class="sc">|&gt;</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(Obrador<span class="sc">:</span>Otros, <span class="at">names_to =</span> <span class="st">"candidato"</span>, </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"pref_cruda"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_encuesta) <span class="sc">|&gt;</span> </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> pref_cruda <span class="sc">/</span> <span class="fu">sum</span>(pref_cruda)) <span class="sc">|&gt;</span> </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_cand =</span> p <span class="sc">*</span> n_efectiva) <span class="sc">|&gt;</span> </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(p, pref_cruda)) <span class="sc">|&gt;</span> </span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> candidato, <span class="at">values_from =</span> n_cand) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ahora consideramos el <strong>modelo de observaciones</strong> que utilizaremos. En primer lugar, las observaciones son conteos, que suponemos multinomiales:</p>
<p><span class="math display">\[n_i \sim \textrm{Multinom}(\pi_i, N_{i}^{eff})\]</span> donde <span class="math inline">\(n_i\)</span> es el vector de conteos observado, <span class="math inline">\(N_i^{eff}\)</span> es la muestra efectiva, y <span class="math inline">\(\pi_i\)</span> es el vector de preferencias de los candidatos para la encuesta <span class="math inline">\(i\)</span>. Ahora definimos <span class="math inline">\(\mu_i\)</span> tal que <span class="math display">\[\textrm{softmax}(\mu_i) = \pi_i\]</span> Ahora consideramos <span class="math inline">\(\mu_i\)</span> para cada encuesta. Esta cantidad dependerá de:</p>
<ul>
<li>La preferencia subyacente <span class="math inline">\(p(t_i)\)</span> de los votantes al tiempo <span class="math inline">\(t_i\)</span> que se tomó la encuesta <span class="math inline">\(i\)</span>.</li>
<li>Sesgos propios de la casa encuestadora <span class="math inline">\(c(i)\)</span>, que hizo la encuesta <span class="math inline">\(i\)</span>, que denotamos como <span class="math inline">\(d_{c(i)}\)</span>. Estos ocurren porque diversas metodologías alcanzan a distintos sectores de posibles votantes, o consideran diferentes poblaciones objetivo. Suponemos que en promedio sobre las casas encuestadores, este valor es cercano a cero.</li>
<li>Sesgos general <span class="math inline">\(b\)</span> en el que incurren todas las casas encuestadoras. Este error sistemático ocurre por ejemplo, cuando un sector particular no responde a encuestas, y también tiene preferencias distintas a las de la población general.</li>
</ul>
<p>El modelo entonces es</p>
<p><span class="math display">\[\mu_i = \alpha(t_i) +  b + d_{c(i)}\]</span> Nuestro interés es estimar <span class="math inline">\(\alpha(t)\)</span> para cada <span class="math inline">\(t\)</span>, y en consecuencia nuestra estimación de la preferencia será</p>
<p><span class="math display">\[p (t) = \textrm{softmax}(\alpha(t)),\]</span> es decir, la preferencia quitando el sesgo de casa encuestadora y el sesgo general de todas las encuestas. Buscaremos hacer una proyección <span class="math inline">\(p(T)\)</span> si <span class="math inline">\(T\)</span> es el día de la elección.</p>
<p>Ahora construímos la parte dinámica del modelo. Supondremos los sesgos generales y por casas encuestadoras como fijos en el tiempo (esto puede cambiarse si existen cambios de metodología en el tiempo por ejemplo).</p>
<p>En este ejemplo usaremos el modelo más simple de nivel local, como en <a href="https://www.sowi.uni-mannheim.de/media/Lehrstuehle/sowi/Gschwend/Articel/forecasting_elections_in_multiparty_systems_a_bayesian_approach_combining_polls_and_fundamentals.pdf">en este modelo de elecciones en Alemania</a>, o <a href="https://github.com/TheEconomist/us-potus-model">el modelo del Economist para la elección presidencial de 2020</a>:</p>
<ul>
<li>Modelo de nivel local, donde los choques ocurren cada día y cambian las preferencias. Las predicciones al día de la elección son las últimas estimaciones junto con la incertidumbre asociada a la evolución de las preferencias.</li>
<li>Otra alternativa es también modelar tendencia (usual o autorregresiva), si consideramos que el “momento” de los candidatos es importante. Las predicciones al día de elección incluyen esa tendencia.</li>
</ul>
<p>En este caso, tenemos usaremos (recuerda que la longitud de <span class="math inline">\(p\)</span> es el número de candidatos). En primer lugar, ponemos</p>
<p><span class="math display">\[\alpha(t+1) = \alpha(t) + \epsilon(t)\]</span> con <span class="math inline">\(\epsilon(t) \sim NMV(0, W)\)</span>, donde <span class="math inline">\(W\)</span> es una matriz de varianzas y covarianzas para los choques, que pueden tener patrones de correlación entre candidatos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>primer_dia <span class="ot">&lt;-</span> pref_tbl<span class="sc">$</span>publicacion <span class="sc">|&gt;</span> <span class="fu">min</span>()</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>ultimo_dia <span class="ot">&lt;-</span> pref_tbl<span class="sc">$</span>publicacion <span class="sc">|&gt;</span> <span class="fu">max</span>()</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>fecha_eleccion <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">ymd</span>(<span class="st">"2018-07-01"</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co">#dias_tbl &lt;- tibble(dia = seq(primer_dia, fecha_eleccion, by = "day")) |&gt; </span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  mutate(id_dia = row_number())</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>dias_tbl <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../datos/dias.csv"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 92 Columns: 2
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl  (1): id_dia
date (1): dia

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># identificar dias</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>pref_tbl <span class="ot">&lt;-</span> pref_tbl <span class="sc">|&gt;</span> </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dias_tbl <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">publicacion =</span> dia)) <span class="sc">|&gt;</span> </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(publicacion)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># numerar casas</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>pref_tbl <span class="ot">&lt;-</span> pref_tbl <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id_casa =</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(Encuestadora)))</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>cands_tbl <span class="ot">&lt;-</span> pref_tbl <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(Obrador<span class="sc">:</span>Otros, <span class="at">names_to =</span> <span class="st">"candidato"</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">values_to =</span> <span class="st">"n_pref"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_encuesta) <span class="sc">|&gt;</span> </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">porcentaje_pref =</span> <span class="dv">100</span> <span class="sc">*</span> n_pref <span class="sc">/</span> <span class="fu">sum</span>(n_pref))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Y podemos usar un modelo como el que sigue:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>mod_elecciones <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/series-de-tiempo/modelo-eleccion.stan"</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_elecciones)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N; //num encuestas
  int&lt;lower=0&gt; T; //num dias
  int&lt;lower=0&gt; K; //num candidatos
  int&lt;lower=0&gt; S; //num casas
  array[N, K] int n_obs;   //preferencias
  array[N] int num_casa_enc;
  array[N] int dia_enc;
}

parameters {

  cholesky_factor_corr[K] L_Omega;
  vector&lt;lower=0&gt;[K] sigma;
  array[T] vector[K] eta;
  vector[K] alpha_1;
  array[S] vector[K] d_casa;
  vector[K] b;

}

transformed parameters {
  array[N] simplex[K] mu;
  array[T] vector[K] alpha;
  array[S] vector[K] d_casa_c;

  alpha[1] = alpha_1;
  // nivel local
  for(t in 2:T){
    alpha[t] = alpha[t-1] +  diag_pre_multiply(sigma, L_Omega) *  eta[t];
  }
  // modelo para la media
  for(s in 1:S){
    d_casa_c[s] = d_casa[s] - mean(d_casa[s]);
  }
  for(i in 1:N){
    mu[i] = softmax(alpha[dia_enc[i]] + d_casa_c[num_casa_enc[i]] + b);
  }
}

model {
  for(i in 1:N){
    n_obs[i] ~ multinomial(mu[i]);
  }

  alpha_1 ~ normal(0, 2);
  for(t in 1:T) {
    eta[t] ~ std_normal();
  }
  b ~ normal(0, 0.07);
  for(s in 1:S){
    d_casa[s] ~ normal(0, 0.25);
  }
  L_Omega ~ lkj_corr_cholesky(2);
  sigma ~ normal(0, 0.05);
}

generated quantities{
  corr_matrix[K] Omega;

  Omega = multiply_lower_tri_self_transpose(L_Omega);

}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>n_obs <span class="ot">&lt;-</span> pref_tbl <span class="sc">|&gt;</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Obrador<span class="sc">:</span>Otros) <span class="sc">|&gt;</span> </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span> </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), as.integer)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>casas <span class="ot">&lt;-</span> pref_tbl<span class="sc">$</span>id_casa</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>dia_enc <span class="ot">&lt;-</span> pref_tbl<span class="sc">$</span>id_dia</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>datos_lst <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">K =</span> <span class="fu">ncol</span>(n_obs), <span class="at">N =</span> <span class="fu">nrow</span>(n_obs), <span class="at">n_obs =</span> n_obs <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">S =</span> <span class="fu">max</span>(casas), <span class="at">num_casa_enc =</span> casas,</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dia_enc =</span> dia_enc, <span class="at">T =</span> <span class="fu">max</span>(dias_tbl<span class="sc">$</span>id_dia))</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>ajuste <span class="ot">&lt;-</span> mod_elecciones<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lst, </span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">max_treedepth =</span> <span class="dv">12</span>, <span class="at">init =</span> <span class="fl">0.01</span>,</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">step_size =</span> <span class="fl">0.01</span>, <span class="at">refresh =</span> <span class="dv">1000</span>,</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">500</span>, <span class="at">iter_warmup =</span> <span class="dv">500</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:   1 / 1000 [  0%]  (Warmup) 
Chain 2 Iteration:   1 / 1000 [  0%]  (Warmup) 
Chain 3 Iteration:   1 / 1000 [  0%]  (Warmup) 
Chain 4 Iteration:   1 / 1000 [  0%]  (Warmup) 
Chain 4 Iteration: 501 / 1000 [ 50%]  (Sampling) 
Chain 2 Iteration: 501 / 1000 [ 50%]  (Sampling) 
Chain 3 Iteration: 501 / 1000 [ 50%]  (Sampling) 
Chain 1 Iteration: 501 / 1000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 1000 [100%]  (Sampling) 
Chain 4 finished in 199.9 seconds.
Chain 2 Iteration: 1000 / 1000 [100%]  (Sampling) 
Chain 2 finished in 206.9 seconds.
Chain 3 Iteration: 1000 / 1000 [100%]  (Sampling) 
Chain 3 finished in 211.1 seconds.
Chain 1 Iteration: 1000 / 1000 [100%]  (Sampling) 
Chain 1 finished in 213.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 207.7 seconds.
Total execution time: 213.3 seconds.</code></pre>
</div>
</div>
<p>Extraemos la componente de interés, la resumimos y la transformamos a porcentaje de preferencia:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>alpha_tbl <span class="ot">&lt;-</span> ajuste<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"alpha"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">contains</span>(<span class="st">"alpha"</span>), </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"valor"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"var"</span>, <span class="st">"id_dia"</span>, <span class="st">"cand"</span>), </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">convert =</span> <span class="cn">TRUE</span>, <span class="at">extra =</span> <span class="st">"drop"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>prop_tbl <span class="ot">&lt;-</span> alpha_tbl <span class="sc">|&gt;</span> <span class="fu">group_by</span>(.draw, id_dia) <span class="sc">|&gt;</span> </span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">valor =</span> <span class="fu">exp</span>(valor)<span class="sc">/</span><span class="fu">sum</span>(<span class="fu">exp</span>(valor))) <span class="sc">|&gt;</span> </span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_dia, cand) <span class="sc">|&gt;</span> </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(valor), <span class="at">q5 =</span> <span class="fu">quantile</span>(valor, <span class="fl">0.05</span>),</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">q95 =</span> <span class="fu">quantile</span>(valor, <span class="fl">0.95</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Y podemos var ahora las estimaciones suavizadas y los pronósticos desde el momento que terminaron las encuestas hasta el día de la elección:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>cands_tbl <span class="ot">&lt;-</span> cands_tbl <span class="sc">|&gt;</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">tibble</span>(<span class="at">cand =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">candidato =</span> <span class="fu">colnames</span>(n_obs)))</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>prop_tbl <span class="ot">&lt;-</span> prop_tbl <span class="sc">|&gt;</span> </span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dias_tbl)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(prop_tbl, <span class="fu">aes</span>( <span class="at">y =</span> <span class="dv">100</span> <span class="sc">*</span> media, <span class="at">group =</span> <span class="fu">factor</span>(cand),</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">colour =</span> <span class="fu">factor</span>(cand))) <span class="sc">+</span> </span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> dia)) <span class="sc">+</span> </span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> dia,<span class="at">ymax =</span> <span class="dv">100</span> <span class="sc">*</span> q95, <span class="at">ymin =</span> <span class="dv">100</span> <span class="sc">*</span> q5, <span class="at">fill =</span> <span class="fu">factor</span>(cand)), </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">colour =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> cands_tbl, <span class="fu">aes</span>(<span class="at">x =</span> publicacion, <span class="at">y =</span> porcentaje_pref), <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Preferencia"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Por ejemplo la matriz de correlaciones estimada (para los choque del nivel) es:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>ajuste<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"Omega"</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(variable, median, sd) <span class="sc">|&gt;</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">round</span>(.x, <span class="dv">3</span>)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 3
   variable   median    sd
   &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;
 1 Omega[1,1]  1     0    
 2 Omega[2,1]  0.033 0.352
 3 Omega[3,1]  0.125 0.404
 4 Omega[4,1] -0.231 0.339
 5 Omega[1,2]  0.033 0.352
 6 Omega[2,2]  1     0    
 7 Omega[3,2]  0.001 0.363
 8 Omega[4,2] -0.18  0.243
 9 Omega[1,3]  0.125 0.404
10 Omega[2,3]  0.001 0.363
11 Omega[3,3]  1     0    
12 Omega[4,3]  0.166 0.363
13 Omega[1,4] -0.231 0.339
14 Omega[2,4] -0.18  0.243
15 Omega[3,4]  0.166 0.363
16 Omega[4,4]  1     0    </code></pre>
</div>
</div>
<p>Este modelo tiene varias ventajas sobre hacer promedios simples o suavizamientos locales (como loess), por ejemplo:</p>
<ul>
<li>Considera el error de estimación de cada encuesta.</li>
<li>Cuando distintas casas publican a frecuencias distintas, es importante considerar que esos datos informan tanto la preferencia como <em>el sesgo de la casa encuestadora</em>. Esto implica, por ejemplo, que los encuestadores con encuestas más grandes o con más encuestas no dominan la estimación.</li>
<li>Contiene parámetros más apropiados para calibrar las predicciones contra datos de elecciones anteriores (los intervalos deben ser consistentes con los resultados finales de la elección), incluyendo efectos de casa, sesgos generales, y rapidez en la evolución del sistema.</li>
</ul>
</section>
<section id="contrafactuales-de-impacto-causal" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="contrafactuales-de-impacto-causal"><span class="header-section-number">12.5</span> Contrafactuales de impacto causal</h2>
<p>Los modelos de espacio de estados también presentan una herramienta útil para hacer inferencia causal, específicamente cuando nos interesa el efecto de una intervención en una métrica que se mide en el tiempo.</p>
<p>En un ejemplo anterior, vimos cómo utilizar estos modelos, y variables dummy, para hacer análisis de efecto de intervenciones (efecto de ley de cinturones de seguridad). La hipótesis básica es que no existen puertas traseras una vez que condicionamos a las covariables incluidas. Esto sucedería si alguna variable <span class="math inline">\(U_t\)</span> afecta a la variable de intervención <span class="math inline">\(X_t\)</span> al mismo tiempo que afecta el estado del sistema <span class="math inline">\(\theta_t\)</span> o sus valores futuros. En este caso, el coeficiente de la variable <span class="math inline">\(X_t\)</span> puede estar contaminado con una correlación no causal. Por ejemplo, un camino de puerta trasera podría ser que hay una decisión de implica poner la ley de cinturones y un reglamento de velocidad máxima en autopistas en fechas cercanas.</p>
<p>Igualmente, el conjunto al que condicionamos no debe contener colisionadores que formen una ruta no causal entre la variable intervenida <span class="math inline">\(X_t\)</span> y el estado del sistema <span class="math inline">\(\theta_t\)</span>. En el caso de los cinturones, por ejemplo, usar como control <span class="math inline">\(R_t\)</span>, el número de personas con heridas menores por accidentes es mala idea, pues es afectado tanto por la ley como por el estado del sistema (o un antecesor del estado).</p>
<p>En ese ejemplo, recaemos en nuestros supuestos de que no existes puertas traseras y en la forma funcional del modelo para hacer la estimación del contrafactual.</p>
<section id="modelos-predictivos-del-contrafactual" class="level3" data-number="12.5.1">
<h3 data-number="12.5.1" class="anchored" data-anchor-id="modelos-predictivos-del-contrafactual"><span class="header-section-number">12.5.1</span> Modelos predictivos del contrafactual</h3>
<p>Otra forma de abordar el problema es el siguiente (<span class="citation" data-cites="causalimpact">Brodersen et&nbsp;al. (<a href="#ref-causalimpact" role="doc-biblioref">2015</a>)</span>) , ver también <a href="https://google.github.io/CausalImpact/">Google Causal Impact</a>):</p>
<ul>
<li>Construimos un modelo predictivo para la serie que vamos a intervenir, utilizando solamente variables que <strong>sabemos que no serán afectadas por la intervención</strong>.</li>
<li>Para constrruir este modelo sólo usamos los <strong>datos anteriores a la intervención</strong> que estamos considerando.</li>
<li>Una alternativa es utilizar <strong>modelos de espacio de estados</strong>, lo cual más adelante nos permite estimar adecuadamente errores de estimación en efectos causales (toman en cuenta la autocorrelación, y la incertidumbre que aumenta conforme el tiempo pasa después de la intervención).</li>
<li>Usando este modelo pronosticamos los valores de la serie de interés después de que ocurre la intervención con nuestro modelo pre-intervención. Estos pronósticos, por el supuesto en el primer inciso, constituyen nuestro <strong>contrafactual</strong> si la intervención no se hubiera aplicado.</li>
<li><strong>Comparamos</strong> los valores observados de la serie de interés, después de la intervención, con los pronósticos para estimar el efecto causal de la intervención.</li>
</ul>
<p>Nótese que no es necesario suponer una forma parámétrica para la intervención, podemos estimarla como la diferencia señalada arriba (individualmente en cada periodo o de forma agregada sobre cierto tiempo después de la intervención), y es posible estimar efectos rezagados de la intervención.</p>
</section>
<section id="ejemplo-1" class="level3" data-number="12.5.2">
<h3 data-number="12.5.2" class="anchored" data-anchor-id="ejemplo-1"><span class="header-section-number">12.5.2</span> Ejemplo 1</h3>
<p>Tomamos el siguiente ejemplo del paquete <em>CausalImpact</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CausalImpact)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bsts)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1241</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">+</span> <span class="fu">arima.sim</span>(<span class="at">model =</span> <span class="fu">list</span>(<span class="at">ar =</span> <span class="fl">0.999</span>), <span class="at">n =</span> <span class="dv">100</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>x_int <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fl">1.2</span> <span class="sc">*</span> x <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">100</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Suponemos que la intervencion se hace en el tiempo <span class="math inline">\(t=71\)</span>, y que tiene el efecto de aumentar la <span class="math inline">\(y\)</span> en 10 unidades:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">71</span><span class="sc">:</span><span class="dv">100</span>] <span class="ot">&lt;-</span> y[<span class="dv">71</span><span class="sc">:</span><span class="dv">100</span>] <span class="sc">+</span> <span class="dv">10</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>x_int[<span class="dv">71</span><span class="sc">:</span><span class="dv">100</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>datos_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(y, x, x_int)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Los dos series, antes de la intervención, muestra correlación. Construiremos un</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>datos_tbl <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">t =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(t <span class="sc">&lt;</span> <span class="dv">71</span>) <span class="sc">|&gt;</span> </span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t)) <span class="sc">+</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> x), <span class="at">colour =</span> <span class="st">"red"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Si sabemos que la serie <span class="math inline">\(x\)</span> roja no puede ser afectada por nuestra intervención sobre <span class="math inline">\(y\)</span>, y suponemos que la relación entre <span class="math inline">\(y\)</span> y <span class="math inline">\(x\)</span> se mantendría después del tiempo de la intervención, entonces podemos contruir un modelo predictivo de <span class="math inline">\(y\)</span> en función de <span class="math inline">\(x\)</span> para construir contrafactuales.</li>
</ul>
<p>Un ejemplo es: si imaginamos que una promoción se hace exclusivamente en una región <span class="math inline">\(A\)</span> del país, podemos usar otras regiones del país como predictores de las ventas en la región <span class="math inline">\(A\)</span>. Muchas veces estos modelos tienden a ser más precisos y simples pues no es necesario incluir factores como estacionalidad, pues están sujetos a fuentes de variación similares.</p>
<hr>
<p>En términos de contrafactuales: una vez que construimos este modelo, hacemos pronósticos con nuestro modelo para <span class="math inline">\(t&gt;t_{int}\)</span>, después de la intervención, que denotamos como <span class="math inline">\(\hat{y}_t^0\)</span>, que son estimaciones de <span class="math inline">\(y_t^0\)</span> (el contrafactual sin la intervención). Después de la intervención observamos <span class="math inline">\(y_t^1\)</span>, así que calculamos, para cada <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[y_t^1 - \hat{y}_t^0\]</span> Esta cantidad tiene una distribución posterior, que representa lo que sabemos del efecto causal individual sobre la región tratada <span class="math inline">\(A\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Método de Impacto causal
</div>
</div>
<div class="callout-body-container callout-body">
<p>Requerimos los siguientes supuestos fuertes:</p>
<ul>
<li>La serie de interés <span class="math inline">\(y\)</span> puede ser explicada en términos de otras series de tiempo que <strong>no son afectadas</strong> por la intervención.</li>
<li>La relación entre la serie de interés <span class="math inline">\(y\)</span> y la serie de control se supone <strong>estable</strong> durante el periodo post-intervención.</li>
</ul>
</div>
</div>
</section>
<section id="ejemplo" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo">Ejemplo</h3>
<p>Usamos la idea de construir un contrafactual con el método de impacto causal:</p>
<p>En primer lugar, excluímos los datos post-tratamiento:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>post_periodo <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">71</span>, <span class="dv">100</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>y_mod <span class="ot">&lt;-</span> y</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>post_y <span class="ot">&lt;-</span> y[post_periodo[<span class="dv">1</span>] <span class="sc">:</span> post_periodo[<span class="dv">2</span>]]</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>y_mod[post_periodo[<span class="dv">1</span>] <span class="sc">:</span> post_periodo[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="cn">NA</span></span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Construimos un modelo. En este caso usamos regresión estática pero agregamos una componente de nivel local:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">886</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>mod_esp_1 <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(), y_mod)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>mod_esp_2 <span class="ot">&lt;-</span> <span class="fu">AddLocalLinearTrend</span>(<span class="fu">list</span>(), y_mod)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>ajuste_pre_1 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(y_mod <span class="sc">~</span> x, mod_esp_1, <span class="at">niter =</span> <span class="dv">25000</span>, <span class="at">ping =</span> <span class="dv">5000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Wed May 15 00:47:37 2024 =-=-=-=-=
=-=-=-=-= Iteration 5000 Wed May 15 00:47:39 2024 =-=-=-=-=
=-=-=-=-= Iteration 10000 Wed May 15 00:47:41 2024 =-=-=-=-=
=-=-=-=-= Iteration 15000 Wed May 15 00:47:44 2024 =-=-=-=-=
=-=-=-=-= Iteration 20000 Wed May 15 00:47:46 2024 =-=-=-=-=</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>ajuste_pre_2 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(y_mod <span class="sc">~</span> x, mod_esp_2, <span class="at">niter =</span> <span class="dv">25000</span>, <span class="at">ping =</span> <span class="dv">5000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Wed May 15 00:47:48 2024 =-=-=-=-=
=-=-=-=-= Iteration 5000 Wed May 15 00:47:50 2024 =-=-=-=-=
=-=-=-=-= Iteration 10000 Wed May 15 00:47:53 2024 =-=-=-=-=
=-=-=-=-= Iteration 15000 Wed May 15 00:47:55 2024 =-=-=-=-=
=-=-=-=-= Iteration 20000 Wed May 15 00:47:58 2024 =-=-=-=-=</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CompareBstsModels</span>(<span class="fu">list</span>(ajuste_pre_1, ajuste_pre_2))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Seleccionamos el primer modelo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ajuste_pre_1)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ajuste_pre_1, <span class="st">"components"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-45-2.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Extraemos predicciones que automáticamente hace <em>bsts</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># quitar burn-in</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>estado_contrib <span class="ot">&lt;-</span> ajuste_pre_1<span class="sc">$</span>state.contributions[<span class="sc">-</span><span class="fu">seq_len</span>(<span class="dv">500</span>), , ,drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># sumar contribuciones de componentes</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>pred_cf <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">aperm</span>(estado_contrib, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>)), <span class="at">dims =</span> <span class="dv">2</span>)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="co"># extraer period post-intervencion</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>pred_cf <span class="ot">&lt;-</span> pred_cf[, <span class="dv">71</span><span class="sc">:</span><span class="dv">100</span>]</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(pred_cf)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24500    30</code></pre>
</div>
</div>
<p>Y estimamos el efecto promedio en estos 30 días utilizando el valor observado de <span class="math inline">\(y\)</span> menos las simulaciones correspondientes del contrafactual:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>media_dia_post <span class="ot">&lt;-</span> <span class="fu">apply</span>(pred_cf, <span class="dv">1</span>, mean)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>diferencia <span class="ot">&lt;-</span>  <span class="fu">mean</span>(y[<span class="dv">71</span><span class="sc">:</span><span class="dv">100</span>]) <span class="sc">-</span> media_dia_post</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(diferencia)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9.212833</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(diferencia, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">3</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  2.5%  97.5% 
 6.551 10.340 </code></pre>
</div>
</div>
<p>O más simplemente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">CausalImpact</span>(<span class="at">bsts.model =</span> ajuste_pre_1,</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">post.period.response =</span> y[<span class="dv">71</span><span class="sc">:</span><span class="dv">100</span>])</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Posterior inference {CausalImpact}

                         Average       Cumulative   
Actual                   87            2613         
Prediction (s.d.)        78 (0.63)     2333 (18.96) 
95% CI                   [77, 79]      [2302, 2378] 
                                                    
Absolute effect (s.d.)   9.4 (0.63)    280.5 (18.96)
95% CI                   [7.8, 10]     [235.2, 312] 
                                                    
Relative effect (s.d.)   12% (0.9%)    12% (0.9%)   
95% CI                   [9.9%, 14%]   [9.9%, 14%]  

Posterior tail-area probability p:   4e-05
Posterior prob. of a causal effect:  99.99573%

For more details, type: summary(impact, "report")</code></pre>
</div>
</div>
<p>Podemos hacer esto automáticamente usando funciones del paquete:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>pre_periodo <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">70</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>post_periodo <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">71</span>, <span class="dv">100</span>)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>impact <span class="ot">&lt;-</span> <span class="fu">CausalImpact</span>(datos_tbl <span class="sc">|&gt;</span> <span class="fu">select</span>(y, x), </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  pre_periodo, post_periodo, <span class="at">model.args =</span> <span class="fu">list</span>(<span class="at">niter =</span> <span class="dv">5000</span>))</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(impact)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(impact)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Posterior inference {CausalImpact}

                         Average      Cumulative  
Actual                   87           2613        
Prediction (s.d.)        78 (0.7)     2335 (20.9) 
95% CI                   [76, 79]     [2294, 2376]
                                                  
Absolute effect (s.d.)   9.3 (0.7)    278.5 (20.9)
95% CI                   [7.9, 11]    [236.9, 319]
                                                  
Relative effect (s.d.)   12% (1%)     12% (1%)    
95% CI                   [10%, 14%]   [10%, 14%]  

Posterior tail-area probability p:   2e-04
Posterior prob. of a causal effect:  99.97997%

For more details, type: summary(impact, "report")</code></pre>
</div>
</div>
</section>
<section id="ejemplo-2" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ejemplo-2">Ejemplo 2</h3>
<p>Nótese adicionalmente esta estimación es no-paramétrica, y no establecemos un modelo explícito para el efecto de la intervención.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CausalImpact)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bsts)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">461</span>)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">+</span> <span class="fu">arima.sim</span>(<span class="at">model =</span> <span class="fu">list</span>(<span class="at">ar =</span> <span class="fl">0.999</span>), <span class="at">n =</span> <span class="dv">100</span>)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>x_int <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fl">1.2</span> <span class="sc">*</span> x <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">100</span>)</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">71</span><span class="sc">:</span><span class="dv">100</span>] <span class="ot">&lt;-</span> y[<span class="dv">71</span><span class="sc">:</span><span class="dv">100</span>] <span class="sc">+</span> <span class="dv">5</span> <span class="sc">*</span> (<span class="dv">71</span><span class="sc">:</span><span class="dv">100</span> <span class="sc">-</span> <span class="dv">71</span>) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">25</span> <span class="sc">*</span> (<span class="dv">71</span><span class="sc">:</span><span class="dv">100</span> <span class="sc">-</span><span class="dv">71</span>) <span class="sc">/</span><span class="dv">100</span>)</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>x_int[<span class="dv">71</span><span class="sc">:</span><span class="dv">100</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>datos_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(y, x, x_int)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>pre_period <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">70</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>post_period <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">71</span>, <span class="dv">100</span>)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>impact <span class="ot">&lt;-</span> <span class="fu">CausalImpact</span>(datos_tbl <span class="sc">|&gt;</span> <span class="fu">select</span>(y, x), pre_period, post_period)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(impact)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>En casos como este, muchas veces tiene más sentido considerar el efecto acumulado en lugar del promedio (por ejemplo si la variable <span class="math inline">\(y\)</span> son clicks o compras):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(impact)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Posterior inference {CausalImpact}

                         Average        Cumulative   
Actual                   126            3785         
Prediction (s.d.)        123 (0.32)     3703 (9.75)  
95% CI                   [123, 124]     [3684, 3722] 
                                                     
Absolute effect (s.d.)   2.7 (0.32)     82.0 (9.75)  
95% CI                   [2.1, 3.4]     [63.1, 100.8]
                                                     
Relative effect (s.d.)   2.2% (0.27%)   2.2% (0.27%) 
95% CI                   [1.7%, 2.7%]   [1.7%, 2.7%] 

Posterior tail-area probability p:   0.00101
Posterior prob. of a causal effect:  99.8993%

For more details, type: summary(impact, "report")</code></pre>
</div>
</div>
</section>
</section>
<section id="ejemplo-cinturones-de-seguridad" class="level2" data-number="12.6">
<h2 data-number="12.6" class="anchored" data-anchor-id="ejemplo-cinturones-de-seguridad"><span class="header-section-number">12.6</span> Ejemplo: cinturones de seguridad</h2>
<p>En el ejemplo de cinturones de seguridad, es necesario encontrar series que se razonable que no son afectadas por la introducción de la ley de cinturones de seguridad.</p>
<p>Supondremos (aunque puede ser discutible), que la ley no tendrá un efecto considerable en kilómetros recorridos o precio de la gasolina, y tampoco tendrá un efecto sobre pasajeros que viajan en los asientos traseros. Estas variables son candidatas para construir un modelo predictivo antes de la introducción de la ley.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>uk_drivers <span class="ot">&lt;-</span> Seatbelts <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span>  </span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ind =</span> <span class="fu">row_number</span>()) </span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>pre_periodo <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">which</span>(uk_drivers<span class="sc">$</span>law <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">max</span>())</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>pre_periodo</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   1 169</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>post_periodo <span class="ot">&lt;-</span> <span class="fu">c</span>(pre_periodo[<span class="dv">2</span>] <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">nrow</span>(uk_drivers))</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>datos_mod_tbl <span class="ot">&lt;-</span> uk_drivers <span class="sc">|&gt;</span> <span class="fu">select</span>(drivers, kms, rear, PetrolPrice,ind)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Podemos construir nuestro modelo manualmente (usualmente, varios modelo que comparamos en capacidad predictiva y calibración de intervalos):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>datos_ent_tbl <span class="ot">&lt;-</span> datos_mod_tbl</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>datos_ent_tbl <span class="ot">&lt;-</span> datos_mod_tbl <span class="sc">|&gt;</span> <span class="fu">filter</span>(ind <span class="sc">&lt;=</span> <span class="dv">140</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>modelo_ent  <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(),</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma.prior =</span> <span class="fu">SdPrior</span>(<span class="dv">5</span>, <span class="dv">10</span>),</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> datos_ent_tbl<span class="sc">$</span>drivers) <span class="sc">|&gt;</span> </span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">12</span>, datos_ent_tbl<span class="sc">$</span>drivers)</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>ajuste_ent <span class="ot">&lt;-</span> <span class="fu">bsts</span>(drivers <span class="sc">~</span> kms <span class="sc">+</span> rear <span class="sc">+</span> PetrolPrice, </span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>                 modelo_ent, <span class="at">data =</span> datos_ent_tbl,</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">niter =</span> <span class="dv">5000</span>, <span class="at">ping =</span> <span class="dv">5000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Wed May 15 00:48:06 2024 =-=-=-=-=</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ajuste_ent)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Checamos predicciones validando un periodo de validación hasta antes de la intervención:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>preds_val <span class="ot">&lt;-</span> <span class="fu">predict</span>(ajuste_ent, <span class="at">newdata =</span> datos_mod_tbl <span class="sc">|&gt;</span> </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(ind <span class="sc">&gt;</span> <span class="dv">140</span>, ind <span class="sc">&lt;</span> <span class="dv">169</span>)) </span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>drivers_val <span class="ot">&lt;-</span> datos_mod_tbl <span class="sc">|&gt;</span> </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(ind <span class="sc">&gt;</span> <span class="dv">140</span>, ind <span class="sc">&lt;</span> <span class="dv">169</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(drivers)</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">pred =</span> preds_val<span class="sc">$</span>mean, </span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">pred_inf =</span> preds_val<span class="sc">$</span>interval[<span class="dv">1</span>, ],</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">pred_sup =</span> preds_val<span class="sc">$</span>interval[<span class="dv">2</span>, ],</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">drivers =</span> drivers_val) <span class="sc">|&gt;</span> </span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> drivers, <span class="at">y =</span> pred, <span class="at">ymin =</span> pred_inf,<span class="at">ymax =</span> pred_sup )) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_linerange</span>(<span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span> </span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>() <span class="sc">+</span> <span class="fu">coord_fixed</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MAPE</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">abs</span>(preds_val<span class="sc">$</span>mean <span class="sc">-</span> drivers_val)<span class="sc">/</span>drivers_val)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.05839834</code></pre>
</div>
</div>
<p>Estas son las variables que utilizamos en el modelo (el color indica el signo cuando entra en el modelo):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ajuste_ent, <span class="st">"coefficients"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Y ahora ajustamos el modelo a todos los datos pre intervención:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>datos_mod_tbl<span class="sc">$</span>y <span class="ot">&lt;-</span> datos_mod_tbl<span class="sc">$</span>drivers</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>datos_mod_tbl<span class="sc">$</span>y[post_periodo[<span class="dv">1</span>]<span class="sc">:</span>post_periodo[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>modelo_1  <span class="ot">&lt;-</span> <span class="fu">AddLocalLevel</span>(<span class="fu">list</span>(), </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigma.prior =</span> <span class="fu">SdPrior</span>(<span class="dv">5</span>, <span class="dv">10</span>),</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    datos_mod_tbl<span class="sc">$</span>y) <span class="sc">|&gt;</span> </span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AddSeasonal</span>(<span class="at">nseasons =</span> <span class="dv">12</span>, datos_mod_tbl<span class="sc">$</span>y)</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>ajuste_1 <span class="ot">&lt;-</span> <span class="fu">bsts</span>(y <span class="sc">~</span> kms <span class="sc">+</span> rear <span class="sc">+</span> PetrolPrice, modelo_1, <span class="at">data =</span> datos_mod_tbl,</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">niter =</span> <span class="dv">5000</span>, <span class="at">ping =</span> <span class="dv">5000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>=-=-=-=-= Iteration 0 Wed May 15 00:48:14 2024 =-=-=-=-=</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>impacto <span class="ot">&lt;-</span> <span class="fu">CausalImpact</span>(<span class="at">bsts.model =</span> ajuste_1,</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">post.period.response =</span> </span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>        datos_mod_tbl<span class="sc">$</span>drivers[post_periodo[<span class="dv">1</span>]<span class="sc">:</span>post_periodo[<span class="dv">2</span>]])</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(impacto)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>impacto</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Posterior inference {CausalImpact}

                         Average        Cumulative    
Actual                   1322           30399         
Prediction (s.d.)        1625 (40)      37376 (929)   
95% CI                   [1546, 1708]   [35564, 39284]
                                                      
Absolute effect (s.d.)   -303 (40)      -6977 (929)   
95% CI                   [-386, -225]   [-8885, -5165]
                                                      
Relative effect (s.d.)   -19% (2%)      -19% (2%)     
95% CI                   [-23%, -15%]   [-23%, -15%]  

Posterior tail-area probability p:   0.00021
Posterior prob. of a causal effect:  99.97937%

For more details, type: summary(impact, "report")</code></pre>
</div>
</div>
<p>Finalmente, podemos checar cómo cambiaron las variables del modelo predictivo post-entrenamiento. Por ejemplo, para las muertes y heridas graves de pasajeros de los asientos traseros:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>uk_drivers <span class="sc">|&gt;</span> </span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ind)) <span class="sc">+</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> drivers)) <span class="sc">+</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> rear), <span class="at">colour =</span> <span class="st">"red"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15-aplicaciones-series_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>O más simplemente, podemos usar los defaults de CausalImpact:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>impacto_auto <span class="ot">&lt;-</span> <span class="fu">CausalImpact</span>(datos_mod_tbl <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>y), pre_periodo, post_periodo)</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>impacto_auto</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Posterior inference {CausalImpact}

                         Average        Cumulative    
Actual                   1322           30399         
Prediction (s.d.)        1610 (46)      37036 (1065)  
95% CI                   [1517, 1707]   [34895, 39271]
                                                      
Absolute effect (s.d.)   -289 (46)      -6637 (1065)  
95% CI                   [-386, -195]   [-8872, -4496]
                                                      
Relative effect (s.d.)   -18% (2.4%)    -18% (2.4%)   
95% CI                   [-23%, -13%]   [-23%, -13%]  

Posterior tail-area probability p:   0.00101
Posterior prob. of a causal effect:  99.8995%

For more details, type: summary(impact, "report")</code></pre>
</div>
</div>
<p><em>Nota</em>: los valores de las iniciales que usa por default <em>CausalImpact</em> son diferentes a los de <em>bsts</em>.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-causalimpact" class="csl-entry" role="listitem">
Brodersen, Kay H., Fabian Gallusser, Jim Koehler, Nicolas Remy, y Steven L. Scott. 2015. <span>«Inferring causal impact using Bayesian structural time-series models»</span>. <em>Annals of Applied Statistics</em> 9: 247-74.
</div>
<div id="ref-durbinkoopman" class="csl-entry" role="listitem">
Durbin, J., y S. J. Koopman. 2001. <em>Time Series Analysis by State Space Methods</em>. Oxford Statistical Science Series. Clarendon Press. <a href="https://books.google.com.mx/books?id=XRCu5iSz\_HwC">https://books.google.com.mx/books?id=XRCu5iSz\_HwC</a>.
</div>
<div id="ref-hyndman2014" class="csl-entry" role="listitem">
Hyndman, R. J., y G. Athanasopoulos. 2014. <em>Forecasting: principles and practice</em>. OTexts. <a href="https://books.google.com.mx/books?id=gDuRBAAAQBAJ">https://books.google.com.mx/books?id=gDuRBAAAQBAJ</a>.
</div>
<div id="ref-scottvarian2015" class="csl-entry" role="listitem">
Scott, Steven L., y Hal R. Varian. 2015. <em><span>Bayesian Variable Selection for Nowcasting Economic Time Series</span></em>. University of Chicago Press. <a href="https://doi.org/10.7208/chicago/9780226206981.003.0004">https://doi.org/10.7208/chicago/9780226206981.003.0004</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./14-series-de-tiempo.html" class="pagination-link" aria-label="Modelos de espacio de estados">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modelos de espacio de estados</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>
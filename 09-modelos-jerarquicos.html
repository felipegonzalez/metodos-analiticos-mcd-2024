<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Métodos analíticos - 9&nbsp; Modelos jerárquicos</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./08-mcmc.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Buscar"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./09-modelos-jerarquicos.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Modelos jerárquicos</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Métodos analíticos</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Buscar"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Temario y referencias</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduccion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-flujo-basico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Flujo de trabajo básico: motivación</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-flujo-basico-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Flujo de trabajo básico: refinando el modelo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-modelos-genericos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Componentes de modelación 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-dags.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Modelos gráficos y causalidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-calculo-do.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Identificación y cálculo-do</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-buenos-malos-controles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Buenos y malos controles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-mcmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-modelos-jerarquicos.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Modelos jerárquicos</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#primer-ejemplo-construyendo-un-modelo-jerárquico." id="toc-primer-ejemplo-construyendo-un-modelo-jerárquico." class="nav-link active" data-scroll-target="#primer-ejemplo-construyendo-un-modelo-jerárquico."><span class="header-section-number">9.1</span> Primer ejemplo: construyendo un modelo jerárquico.</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Modelos jerárquicos</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Muchas veces, cuando las observaciones están agrupadas por variables categóricas, puede ser que obtengamos mejores estimaciones cuando consideramos modelos no solo para los observaciones, sino también para la variación que esperamos en parámetros relacionadas con los grupos. Esta es una técnica de modelación con la que en muchos casos podemos mejorar estimaciones, aprovechando de manera más eficiente la información que tenemos.</p>
<p>En nuestros ejemplos anteriores, por ejemplo, hemos visto casos donde al <strong>estratificar</strong> construimos modelos individuales, por ejemplo, en regresión lineal, si <span class="math inline">\(g(i)\)</span> es el grupo de la observación <span class="math inline">\(i\)</span>, utilizamos modelos de la forma:</p>
<p><span class="math display">\[\alpha_{g(i)} + \beta_{g(i)} x_i + \epsilon_i\]</span> Este modelo, donde ordenada al origen y coeficientes varían por grupo, tienen a veces el problema de resultar en estimaciones con alta variabilidad y poco informativas, especialmente cuando tenemos pocos datos por grupo. Cuando es el caso de que estos coeficientes no varían por grupo, podemos adoptar un modelo más simple, como <span class="math display">\[\alpha + \beta x_i + \epsilon_i,\]</span> que da estimaciones con menos error, pero perdemos el objetivo de la estratificación a menos que en efecto los coeficientes no varían mucho por grupo.</p>
<p>Una alternativa intermedia es construir un modelo donde <em>aprendamos</em> la estructura de variabilidad de <span class="math inline">\(\alpha_g\)</span> y <span class="math inline">\(\beta_g\)</span> a lo largo de los grupos: aprendemos de cada grupo, pero los coeficientes de cada grupo tienen una distribución a priori con parámetros que podemos aprender de los datos. Esto resulta en varias mejorías:</p>
<ol type="1">
<li>Cuando tenemos muchos datos en un grupo <span class="math inline">\(g\)</span>, usamos principalmente los datos en ese grupo para estimar los parámetros de ese grupo.</li>
<li>Cuando tenemos pocos datos en un grupo <span class="math inline">\(g\)</span>, podemos usar información del comportamiento a lo largo de los grupos para regularizar las estimaciones relacionadas con ese grupo.</li>
<li>Evitamos por un lado tener modelos subajustados (donde no consideramos distintos modelos por grupo), pero también sobreajustados (cuando tenemos poca información por grupo). El nivel de regularización lo aprendemos de los datos.</li>
</ol>
<p>El objetivo de todo esto es obtener mejores estimaciones de las cantidades de interés. Veremos más adelante cómo se relaciona esto con inferencia causal.</p>
<section id="primer-ejemplo-construyendo-un-modelo-jerárquico." class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="primer-ejemplo-construyendo-un-modelo-jerárquico."><span class="header-section-number">9.1</span> Primer ejemplo: construyendo un modelo jerárquico.</h2>
<p>Consideramos un ejemplo simple, donde queremos estimar el efecto del hospital en la tasa de mortalidad de pacientes de cirugía de corazón. Este ejemplo se puede encontrar en <span class="citation" data-cites="albert2009bayesian">Albert (<a href="#ref-albert2009bayesian" role="doc-biblioref">2009</a>)</span>. Plantearemos 3 alternativas de modelación para resolver el problema: modelo de unidades iguales, modelo de unidades independientes y finalmente modelo jerárquico.</p>
<p>Tenemos datos todas las cirugías de transplante de corazón llevadas a cabo en Estados Unidos en un periodo de 24 meses, entre octubre de 1987 y diciembre de 1989. Para cada uno de los 131 hospitales, se registró el número de cirugías de transplante de corazón, y el número de muertes durante los 30 días posteriores a la cirugía <span class="math inline">\(y\)</span>. Además, se cuenta con una predicción de la probabilidad de muerte de cada paciente individual. Esta predicción esta basada en un modelo logístico que incluye información a nivel paciente como condición médica antes de la cirugía, género, sexo y raza. En cada hospital se suman las probabilidades de muerte de sus pacientes para calcular el número esperado de muertes <span class="math inline">\(e\)</span>, que llamamos como la exposición del hospital. <span class="math inline">\(e\)</span> refleja el riesgo de muerte debido a la mezcla de pacientes que componen un hospital particular.</p>
<p>El diagrama simple que consideraremos es uno donde hospital es causa tanto de su exposición <span class="math inline">\(e\)</span> (por su tamaño, tipo de casos que atrae, etc), como de el número de personas fallecidas. A su vez, la exposición <span class="math inline">\(e\)</span> es causa del número de muertes <span class="math inline">\(y\)</span>. Nos interesa estimar el efecto directo de hospital en el número de muertes.</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DiagrammeR)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">theme_set</span>(ggplot2<span class="sc">::</span><span class="fu">theme_light</span>())</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>datos_hosp <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../datos/hearttransplants.csv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">row_number</span>())</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(datos_hosp)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
      e     y hospital
  &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;
1   532     0        1
2   584     0        2
3   672     2        3
4   722     1        4
5   904     1        5
6  1236     0        6</code></pre>
</div>
</div>
<p>Consideramos la cantidad <span class="math inline">\(y/e\)</span> como una estimación cruda de la tasa de mortalidad. En la siguiente gráfica, observamos que parece ser la variabilidad es alta cuando el número de expuestos es relativamente baja. Nótese que la tasa de mortalidad no es muy alta en general, y que el número de muertes es relativamente bajo en muchos hospitales (puede tomar valores 0, 1, 2, etc.) Esto produce variabilidad alta para exposiciones bajas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(datos_hosp, <span class="fu">aes</span>(<span class="at">x =</span> e, <span class="at">y =</span> <span class="dv">1000</span> <span class="sc">*</span> y <span class="sc">/</span> e, <span class="at">color =</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> y))) <span class="sc">+</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">scale_x_log10</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Número de expuestos e"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Consideramos primero un modelo donde consideramos que todos los hospitales tienen una misma tasa de mortalidad. Si <span class="math inline">\(e_j\)</span> es la exposición del hospital <span class="math inline">\(j\)</span> y <span class="math inline">\(y_j\)</span> el número de muertes, entonces podemos considerar un modelo de la forma</p>
<p><span class="math display">\[y_j \sim \text{Poisson}(e_j \lambda),\]</span> Es decir, el número de muertes es Poisson con valor esperado igual al número de expuestos multiplicado por la tasa común de mortalidad.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>mod_agregado <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/heart-agregado.stan"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>datos_agregado <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(datos_hosp), <span class="at">y =</span> datos_hosp<span class="sc">$</span>y, <span class="at">e =</span> datos_hosp<span class="sc">$</span>e)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>ajuste_agregado <span class="ot">&lt;-</span> mod_agregado<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_agregado, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 0.1 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 0.1 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 0.1 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 0.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.1 seconds.
Total execution time: 0.6 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ajuste_agregado<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"lambda"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  variable  mean median     sd    mad    q5   q95  rhat ess_bulk ess_tail
  &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 lambda   0.941  0.940 0.0578 0.0577 0.847  1.04  1.01    1481.    2106.</code></pre>
</div>
</div>
<p>Los diagnósticos básicos parecen ser apropiados. Procedemos a hacer un chequeo predictivo posterior:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">912</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>ajuste_agregado<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"y_sim"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"y_sim"</span>), <span class="at">names_to =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"hospital"</span>), <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">as.integer</span>(hospital)) <span class="sc">|&gt;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(datos_hosp, <span class="at">by =</span> <span class="st">"hospital"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(hospital <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">94</span>, <span class="dv">20</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> hospital) <span class="sc">+</span> </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> y), <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Y vemos fallas en el ajuste del modelo, con varias observaciones en los extremos de las colas.</p>
<p>Podemos considerar un modelo donde cada hospital tiene su propia tasa de mortalidad.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>mod_ind <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/heart-individual.stan"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_ind)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  array[N]  int e;
  array[N]  int y;
}

parameters {
  vector&lt;lower=0&gt;[N] lambda;
}

transformed parameters {
  vector[N] media_hospital;
  // lambda es por cada 1000 expuestos:
  for (i in 1:N){
    media_hospital[i] = lambda[i] * e[i] / 1000;
  }
}

model {
  // partes no determinísticas
  y ~ poisson(media_hospital);
  lambda ~ exponential(1);
}

generated quantities {
  array[N] int y_sim;
  for (i in 1:N){
    y_sim[i] = poisson_rng(media_hospital[i]);
  }
}</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>datos_ind <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(datos_hosp), <span class="at">y =</span> datos_hosp<span class="sc">$</span>y, <span class="at">e =</span> datos_hosp<span class="sc">$</span>e)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ajuste_ind <span class="ot">&lt;-</span> mod_ind<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_ind, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 0.3 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 0.3 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 0.3 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 0.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.3 seconds.
Total execution time: 1.3 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>resumen <span class="ot">&lt;-</span> ajuste_ind<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"lambda"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, rhat, ess_bulk)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>resumen <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lambda[1]</td>
<td style="text-align: right;">0.6583536</td>
<td style="text-align: right;">0.6586216</td>
<td style="text-align: right;">1.0006192</td>
<td style="text-align: right;">5165.406</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[2]</td>
<td style="text-align: right;">0.6275285</td>
<td style="text-align: right;">0.6100568</td>
<td style="text-align: right;">1.0006134</td>
<td style="text-align: right;">5304.057</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[3]</td>
<td style="text-align: right;">1.7901338</td>
<td style="text-align: right;">1.0150032</td>
<td style="text-align: right;">1.0025797</td>
<td style="text-align: right;">7752.468</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[4]</td>
<td style="text-align: right;">1.1631030</td>
<td style="text-align: right;">0.8126933</td>
<td style="text-align: right;">1.0029684</td>
<td style="text-align: right;">6266.203</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[5]</td>
<td style="text-align: right;">1.0546849</td>
<td style="text-align: right;">0.7280221</td>
<td style="text-align: right;">1.0031314</td>
<td style="text-align: right;">7189.272</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[6]</td>
<td style="text-align: right;">0.4379974</td>
<td style="text-align: right;">0.4299703</td>
<td style="text-align: right;">1.0009799</td>
<td style="text-align: right;">5048.264</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[7]</td>
<td style="text-align: right;">0.4997928</td>
<td style="text-align: right;">0.4831605</td>
<td style="text-align: right;">1.0016690</td>
<td style="text-align: right;">5114.259</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[8]</td>
<td style="text-align: right;">0.8132338</td>
<td style="text-align: right;">0.5780811</td>
<td style="text-align: right;">1.0020729</td>
<td style="text-align: right;">7136.650</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[9]</td>
<td style="text-align: right;">2.2283861</td>
<td style="text-align: right;">1.1061633</td>
<td style="text-align: right;">0.9995477</td>
<td style="text-align: right;">7795.995</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[10]</td>
<td style="text-align: right;">0.4943771</td>
<td style="text-align: right;">0.4791999</td>
<td style="text-align: right;">1.0015410</td>
<td style="text-align: right;">6199.135</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[11]</td>
<td style="text-align: right;">0.5702635</td>
<td style="text-align: right;">0.5669676</td>
<td style="text-align: right;">0.9999858</td>
<td style="text-align: right;">4844.867</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[12]</td>
<td style="text-align: right;">0.7276062</td>
<td style="text-align: right;">0.5194843</td>
<td style="text-align: right;">0.9996745</td>
<td style="text-align: right;">7401.780</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[13]</td>
<td style="text-align: right;">0.5402685</td>
<td style="text-align: right;">0.5416521</td>
<td style="text-align: right;">1.0009094</td>
<td style="text-align: right;">4667.626</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[14]</td>
<td style="text-align: right;">1.4168025</td>
<td style="text-align: right;">0.8179681</td>
<td style="text-align: right;">1.0001357</td>
<td style="text-align: right;">8158.471</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[15]</td>
<td style="text-align: right;">1.8374637</td>
<td style="text-align: right;">0.8959153</td>
<td style="text-align: right;">1.0003162</td>
<td style="text-align: right;">7266.626</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[16]</td>
<td style="text-align: right;">0.4686611</td>
<td style="text-align: right;">0.4580127</td>
<td style="text-align: right;">1.0018647</td>
<td style="text-align: right;">5925.258</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[17]</td>
<td style="text-align: right;">0.4299892</td>
<td style="text-align: right;">0.4270344</td>
<td style="text-align: right;">1.0000900</td>
<td style="text-align: right;">4716.068</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[18]</td>
<td style="text-align: right;">1.4398167</td>
<td style="text-align: right;">0.7206289</td>
<td style="text-align: right;">1.0014807</td>
<td style="text-align: right;">7010.188</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[19]</td>
<td style="text-align: right;">0.4361010</td>
<td style="text-align: right;">0.3004024</td>
<td style="text-align: right;">1.0020841</td>
<td style="text-align: right;">7361.362</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[20]</td>
<td style="text-align: right;">0.9095600</td>
<td style="text-align: right;">0.6463542</td>
<td style="text-align: right;">0.9999059</td>
<td style="text-align: right;">6731.727</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[21]</td>
<td style="text-align: right;">0.8950893</td>
<td style="text-align: right;">0.6226518</td>
<td style="text-align: right;">1.0012198</td>
<td style="text-align: right;">7102.283</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[22]</td>
<td style="text-align: right;">0.9026263</td>
<td style="text-align: right;">0.6513811</td>
<td style="text-align: right;">1.0023325</td>
<td style="text-align: right;">7832.570</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[23]</td>
<td style="text-align: right;">2.0032715</td>
<td style="text-align: right;">0.9300883</td>
<td style="text-align: right;">1.0002577</td>
<td style="text-align: right;">8627.692</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[24]</td>
<td style="text-align: right;">1.5902697</td>
<td style="text-align: right;">0.8109377</td>
<td style="text-align: right;">1.0013903</td>
<td style="text-align: right;">8360.192</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[25]</td>
<td style="text-align: right;">1.3937997</td>
<td style="text-align: right;">0.6810875</td>
<td style="text-align: right;">1.0001507</td>
<td style="text-align: right;">7706.375</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[26]</td>
<td style="text-align: right;">0.6984656</td>
<td style="text-align: right;">0.5001702</td>
<td style="text-align: right;">0.9999789</td>
<td style="text-align: right;">6761.789</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[27]</td>
<td style="text-align: right;">0.4461970</td>
<td style="text-align: right;">0.4635060</td>
<td style="text-align: right;">1.0008701</td>
<td style="text-align: right;">6028.760</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[28]</td>
<td style="text-align: right;">1.2594830</td>
<td style="text-align: right;">0.6986847</td>
<td style="text-align: right;">1.0012426</td>
<td style="text-align: right;">7572.902</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[29]</td>
<td style="text-align: right;">1.1320465</td>
<td style="text-align: right;">0.6506051</td>
<td style="text-align: right;">1.0010134</td>
<td style="text-align: right;">7522.168</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[30]</td>
<td style="text-align: right;">1.8764928</td>
<td style="text-align: right;">0.8466750</td>
<td style="text-align: right;">1.0000906</td>
<td style="text-align: right;">8114.597</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[31]</td>
<td style="text-align: right;">1.7583001</td>
<td style="text-align: right;">0.8069553</td>
<td style="text-align: right;">1.0031715</td>
<td style="text-align: right;">7914.872</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[32]</td>
<td style="text-align: right;">1.6035141</td>
<td style="text-align: right;">0.7899954</td>
<td style="text-align: right;">1.0008976</td>
<td style="text-align: right;">8036.806</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[33]</td>
<td style="text-align: right;">1.1555324</td>
<td style="text-align: right;">0.6697436</td>
<td style="text-align: right;">1.0003042</td>
<td style="text-align: right;">7501.702</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[34]</td>
<td style="text-align: right;">1.5264033</td>
<td style="text-align: right;">0.6616486</td>
<td style="text-align: right;">1.0025811</td>
<td style="text-align: right;">7766.213</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[35]</td>
<td style="text-align: right;">0.7899508</td>
<td style="text-align: right;">0.5578459</td>
<td style="text-align: right;">0.9999789</td>
<td style="text-align: right;">7090.187</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[36]</td>
<td style="text-align: right;">1.4532723</td>
<td style="text-align: right;">0.7375873</td>
<td style="text-align: right;">1.0007186</td>
<td style="text-align: right;">9869.132</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[37]</td>
<td style="text-align: right;">0.4285978</td>
<td style="text-align: right;">0.4199888</td>
<td style="text-align: right;">0.9999393</td>
<td style="text-align: right;">5751.457</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[38]</td>
<td style="text-align: right;">1.9897239</td>
<td style="text-align: right;">0.8793718</td>
<td style="text-align: right;">1.0003754</td>
<td style="text-align: right;">9144.105</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[39]</td>
<td style="text-align: right;">0.7450916</td>
<td style="text-align: right;">0.5182003</td>
<td style="text-align: right;">0.9995554</td>
<td style="text-align: right;">8130.725</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[40]</td>
<td style="text-align: right;">1.1374976</td>
<td style="text-align: right;">0.6525920</td>
<td style="text-align: right;">1.0017931</td>
<td style="text-align: right;">8589.492</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[41]</td>
<td style="text-align: right;">1.4244404</td>
<td style="text-align: right;">0.7006266</td>
<td style="text-align: right;">1.0023593</td>
<td style="text-align: right;">6858.366</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[42]</td>
<td style="text-align: right;">1.6637849</td>
<td style="text-align: right;">0.7509851</td>
<td style="text-align: right;">0.9996539</td>
<td style="text-align: right;">7139.173</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[43]</td>
<td style="text-align: right;">1.8140081</td>
<td style="text-align: right;">0.8307266</td>
<td style="text-align: right;">1.0031303</td>
<td style="text-align: right;">8294.113</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[44]</td>
<td style="text-align: right;">0.8571984</td>
<td style="text-align: right;">0.4790812</td>
<td style="text-align: right;">1.0023603</td>
<td style="text-align: right;">7703.580</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[45]</td>
<td style="text-align: right;">1.0880935</td>
<td style="text-align: right;">0.6318477</td>
<td style="text-align: right;">1.0006352</td>
<td style="text-align: right;">7566.251</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[46]</td>
<td style="text-align: right;">1.4361456</td>
<td style="text-align: right;">0.6503897</td>
<td style="text-align: right;">0.9994384</td>
<td style="text-align: right;">8163.939</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[47]</td>
<td style="text-align: right;">0.8847706</td>
<td style="text-align: right;">0.5167225</td>
<td style="text-align: right;">1.0009238</td>
<td style="text-align: right;">8324.206</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[48]</td>
<td style="text-align: right;">1.0750511</td>
<td style="text-align: right;">0.5339827</td>
<td style="text-align: right;">1.0016644</td>
<td style="text-align: right;">8622.261</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[49]</td>
<td style="text-align: right;">0.3018790</td>
<td style="text-align: right;">0.2959550</td>
<td style="text-align: right;">1.0005851</td>
<td style="text-align: right;">5793.900</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[50]</td>
<td style="text-align: right;">0.3197025</td>
<td style="text-align: right;">0.3256233</td>
<td style="text-align: right;">0.9994628</td>
<td style="text-align: right;">5081.758</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[51]</td>
<td style="text-align: right;">0.7794332</td>
<td style="text-align: right;">0.4571045</td>
<td style="text-align: right;">1.0016552</td>
<td style="text-align: right;">9014.116</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[52]</td>
<td style="text-align: right;">1.5544563</td>
<td style="text-align: right;">0.6441122</td>
<td style="text-align: right;">1.0010498</td>
<td style="text-align: right;">9468.760</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[53]</td>
<td style="text-align: right;">1.4271320</td>
<td style="text-align: right;">0.5891077</td>
<td style="text-align: right;">1.0008465</td>
<td style="text-align: right;">8036.982</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[54]</td>
<td style="text-align: right;">0.5978108</td>
<td style="text-align: right;">0.4191586</td>
<td style="text-align: right;">1.0009834</td>
<td style="text-align: right;">7923.881</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[55]</td>
<td style="text-align: right;">0.5552029</td>
<td style="text-align: right;">0.3868425</td>
<td style="text-align: right;">0.9998611</td>
<td style="text-align: right;">7153.238</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[56]</td>
<td style="text-align: right;">0.8218314</td>
<td style="text-align: right;">0.4135715</td>
<td style="text-align: right;">0.9999527</td>
<td style="text-align: right;">8158.309</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[57]</td>
<td style="text-align: right;">0.5449502</td>
<td style="text-align: right;">0.3894453</td>
<td style="text-align: right;">0.9999776</td>
<td style="text-align: right;">6458.686</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[58]</td>
<td style="text-align: right;">0.5348793</td>
<td style="text-align: right;">0.3716342</td>
<td style="text-align: right;">1.0007056</td>
<td style="text-align: right;">6879.272</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[59]</td>
<td style="text-align: right;">0.9940355</td>
<td style="text-align: right;">0.4830594</td>
<td style="text-align: right;">1.0003936</td>
<td style="text-align: right;">10337.022</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[60]</td>
<td style="text-align: right;">0.4437015</td>
<td style="text-align: right;">0.3096729</td>
<td style="text-align: right;">1.0029815</td>
<td style="text-align: right;">6798.740</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[61]</td>
<td style="text-align: right;">0.8094635</td>
<td style="text-align: right;">0.4614335</td>
<td style="text-align: right;">0.9997315</td>
<td style="text-align: right;">7392.990</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[62]</td>
<td style="text-align: right;">1.6002911</td>
<td style="text-align: right;">0.6164370</td>
<td style="text-align: right;">1.0024416</td>
<td style="text-align: right;">7827.165</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[63]</td>
<td style="text-align: right;">0.2097533</td>
<td style="text-align: right;">0.2161231</td>
<td style="text-align: right;">1.0001642</td>
<td style="text-align: right;">5961.516</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[64]</td>
<td style="text-align: right;">0.5998704</td>
<td style="text-align: right;">0.3543889</td>
<td style="text-align: right;">1.0010214</td>
<td style="text-align: right;">7784.407</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[65]</td>
<td style="text-align: right;">0.8302986</td>
<td style="text-align: right;">0.4806738</td>
<td style="text-align: right;">1.0025724</td>
<td style="text-align: right;">8145.229</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[66]</td>
<td style="text-align: right;">0.5185593</td>
<td style="text-align: right;">0.3582384</td>
<td style="text-align: right;">1.0000323</td>
<td style="text-align: right;">6377.592</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[67]</td>
<td style="text-align: right;">0.5622628</td>
<td style="text-align: right;">0.3337068</td>
<td style="text-align: right;">1.0017643</td>
<td style="text-align: right;">7154.676</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[68]</td>
<td style="text-align: right;">2.0368689</td>
<td style="text-align: right;">0.6876336</td>
<td style="text-align: right;">1.0055722</td>
<td style="text-align: right;">9092.125</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[69]</td>
<td style="text-align: right;">1.5065795</td>
<td style="text-align: right;">0.5699950</td>
<td style="text-align: right;">1.0005292</td>
<td style="text-align: right;">8331.294</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[70]</td>
<td style="text-align: right;">0.3844750</td>
<td style="text-align: right;">0.2785353</td>
<td style="text-align: right;">1.0024007</td>
<td style="text-align: right;">6767.158</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[71]</td>
<td style="text-align: right;">1.4130430</td>
<td style="text-align: right;">0.5030808</td>
<td style="text-align: right;">1.0027316</td>
<td style="text-align: right;">9470.380</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[72]</td>
<td style="text-align: right;">0.9854344</td>
<td style="text-align: right;">0.4297633</td>
<td style="text-align: right;">1.0011536</td>
<td style="text-align: right;">9078.722</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[73]</td>
<td style="text-align: right;">0.3803165</td>
<td style="text-align: right;">0.2642860</td>
<td style="text-align: right;">0.9998781</td>
<td style="text-align: right;">6647.621</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[74]</td>
<td style="text-align: right;">0.7987972</td>
<td style="text-align: right;">0.3949402</td>
<td style="text-align: right;">1.0025064</td>
<td style="text-align: right;">8176.634</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[75]</td>
<td style="text-align: right;">1.0660119</td>
<td style="text-align: right;">0.4160935</td>
<td style="text-align: right;">1.0009367</td>
<td style="text-align: right;">8879.975</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[76]</td>
<td style="text-align: right;">0.4578378</td>
<td style="text-align: right;">0.2659640</td>
<td style="text-align: right;">1.0003575</td>
<td style="text-align: right;">8105.424</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[77]</td>
<td style="text-align: right;">0.6694614</td>
<td style="text-align: right;">0.3042366</td>
<td style="text-align: right;">1.0001769</td>
<td style="text-align: right;">7553.550</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[78]</td>
<td style="text-align: right;">0.6279796</td>
<td style="text-align: right;">0.3145321</td>
<td style="text-align: right;">1.0010509</td>
<td style="text-align: right;">8771.816</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[79]</td>
<td style="text-align: right;">0.9175721</td>
<td style="text-align: right;">0.4044257</td>
<td style="text-align: right;">1.0010852</td>
<td style="text-align: right;">9683.504</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[80]</td>
<td style="text-align: right;">1.0506304</td>
<td style="text-align: right;">0.4302338</td>
<td style="text-align: right;">1.0022860</td>
<td style="text-align: right;">7827.670</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[81]</td>
<td style="text-align: right;">0.5012500</td>
<td style="text-align: right;">0.3018368</td>
<td style="text-align: right;">1.0017463</td>
<td style="text-align: right;">7269.050</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[82]</td>
<td style="text-align: right;">0.9981823</td>
<td style="text-align: right;">0.3795039</td>
<td style="text-align: right;">1.0020283</td>
<td style="text-align: right;">8411.693</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[83]</td>
<td style="text-align: right;">1.4705479</td>
<td style="text-align: right;">0.4957901</td>
<td style="text-align: right;">1.0014892</td>
<td style="text-align: right;">8909.492</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[84]</td>
<td style="text-align: right;">0.4915877</td>
<td style="text-align: right;">0.1923660</td>
<td style="text-align: right;">1.0009710</td>
<td style="text-align: right;">8681.406</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[85]</td>
<td style="text-align: right;">0.1462425</td>
<td style="text-align: right;">0.1448864</td>
<td style="text-align: right;">1.0002353</td>
<td style="text-align: right;">5320.621</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[86]</td>
<td style="text-align: right;">0.9944543</td>
<td style="text-align: right;">0.3670536</td>
<td style="text-align: right;">1.0001632</td>
<td style="text-align: right;">9571.313</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[87]</td>
<td style="text-align: right;">1.3736207</td>
<td style="text-align: right;">0.4610920</td>
<td style="text-align: right;">1.0023358</td>
<td style="text-align: right;">8707.553</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[88]</td>
<td style="text-align: right;">1.1210221</td>
<td style="text-align: right;">0.3999280</td>
<td style="text-align: right;">1.0004132</td>
<td style="text-align: right;">11185.793</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[89]</td>
<td style="text-align: right;">0.5515533</td>
<td style="text-align: right;">0.2814439</td>
<td style="text-align: right;">1.0009379</td>
<td style="text-align: right;">9472.479</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[90]</td>
<td style="text-align: right;">0.5020421</td>
<td style="text-align: right;">0.2537327</td>
<td style="text-align: right;">0.9997052</td>
<td style="text-align: right;">7704.323</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[91]</td>
<td style="text-align: right;">1.1323293</td>
<td style="text-align: right;">0.3517581</td>
<td style="text-align: right;">1.0021811</td>
<td style="text-align: right;">11321.426</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[92]</td>
<td style="text-align: right;">0.7582604</td>
<td style="text-align: right;">0.2697603</td>
<td style="text-align: right;">1.0006837</td>
<td style="text-align: right;">9264.479</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[93]</td>
<td style="text-align: right;">1.4530631</td>
<td style="text-align: right;">0.3388141</td>
<td style="text-align: right;">1.0010033</td>
<td style="text-align: right;">9858.270</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[94]</td>
<td style="text-align: right;">1.3687930</td>
<td style="text-align: right;">0.3160478</td>
<td style="text-align: right;">1.0007887</td>
<td style="text-align: right;">8029.575</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>El problema en este caso es que tenemos intervalos que simplemente no son creíbles, en particular con aquellos hospitales que tienen poca exposición.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">912</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ajuste_ind<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"lambda"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"lambda"</span>), <span class="at">names_to =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"hospital"</span>), <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">as.integer</span>(hospital)) <span class="sc">|&gt;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(datos_hosp, <span class="at">by =</span> <span class="st">"hospital"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">factor</span>(hospital)) <span class="sc">|&gt;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hospital, e, y) <span class="sc">|&gt;</span> </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">inf =</span> <span class="fu">quantile</span>(value, <span class="fl">0.1</span>), <span class="at">sup =</span> <span class="fu">quantile</span>(value, <span class="fl">0.9</span>)) <span class="sc">|&gt;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> e)) <span class="sc">+</span> <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> inf, <span class="at">ymax =</span> sup)) <span class="sc">+</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">1000</span> <span class="sc">*</span> y <span class="sc">/</span> e), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Número de expuestos e"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Muertes por mil expuestos"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>En este caso, la variabilidad es muy alta para hospitales con poca exposición, tanto en los datos observados como en los intervalos. Los intervalos no aportan mucha información. En este punto utilizar iniciales fuertes para las <span class="math inline">\(\lambda_j\)</span> si tenemos la información disponible. Sin embargo, los resultados serán altamente sensible a esta información inicial.</p>
<p>Una alternativa intermedia es poner una distribución inicial sobre las tasas que pueda adaptarse a los datos. Esta es una estrategia intermedia, donde permitimos variación en las <span class="math inline">\(\lambda_j\)</span> que sea consistente con la variación que observamos a lo largo de los hospitales.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>mod_jer <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/heart-jerarquico.stan"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_jer)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  array[N]  int e;
  array[N]  int y;
}

parameters {
  vector&lt;lower=0&gt;[N] lambda;
  real&lt;lower=0&gt; alpha;
  real&lt;lower=0&gt; mu;
}

transformed parameters {
  vector[N] media_hospital;
  // lambda es por cada 1000 expuestos:
  for (i in 1:N){
    media_hospital[i] = lambda[i] * e[i] /1000;
  }
}

model {
  // partes no determinísticas
  y ~ poisson(media_hospital);
  lambda ~ gamma(alpha, alpha / mu);
  mu ~ exponential(1);
  alpha ~ exponential(1);
}

generated quantities {
  array[N] int y_sim;
  for (i in 1:N){
    y_sim[i] = poisson_rng(media_hospital[i]);
  }
}</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>datos_jer <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(datos_hosp), <span class="at">y =</span> datos_hosp<span class="sc">$</span>y, <span class="at">e =</span> datos_hosp<span class="sc">$</span>e)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ajuste_jer <span class="ot">&lt;-</span> mod_jer<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_ind, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">step_size =</span> <span class="fl">0.5</span>, <span class="at">iter_sampling =</span> <span class="dv">3000</span>, <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 1 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 1 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 1 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 1 finished in 0.7 seconds.
Chain 2 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 2 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 2 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 2 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 2 finished in 0.7 seconds.
Chain 3 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 3 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 3 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 3 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 3 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 3 finished in 0.7 seconds.
Chain 4 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 4 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 4 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 4 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 4 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 4 finished in 0.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.7 seconds.
Total execution time: 3.3 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>resumen <span class="ot">&lt;-</span> ajuste_jer<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"mu"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, rhat, ess_bulk)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>resumen <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">alpha</td>
<td style="text-align: right;">4.3771616</td>
<td style="text-align: right;">1.3246645</td>
<td style="text-align: right;">1.000421</td>
<td style="text-align: right;">2640.041</td>
</tr>
<tr class="even">
<td style="text-align: left;">mu</td>
<td style="text-align: right;">0.9626838</td>
<td style="text-align: right;">0.0818993</td>
<td style="text-align: right;">1.000104</td>
<td style="text-align: right;">9910.558</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>El problema en este caso es que tenemos intervalos que simplemente no son creíbles, en particular con aquellos hospitales que tienen poca exposición.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">912</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>ajuste_jer<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"lambda"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"lambda"</span>), <span class="at">names_to =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"hospital"</span>), <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">as.integer</span>(hospital)) <span class="sc">|&gt;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(datos_hosp, <span class="at">by =</span> <span class="st">"hospital"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">factor</span>(hospital)) <span class="sc">|&gt;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hospital, e, y) <span class="sc">|&gt;</span> </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">inf =</span> <span class="fu">quantile</span>(value, <span class="fl">0.1</span>), <span class="at">sup =</span> <span class="fu">quantile</span>(value, <span class="fl">0.9</span>), <span class="at">median =</span> <span class="fu">median</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> e)) <span class="sc">+</span> <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> inf, <span class="at">ymax =</span> sup)) <span class="sc">+</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">1000</span> <span class="sc">*</span> y <span class="sc">/</span> e), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> median)) <span class="sc">+</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Número de expuestos e"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Muertes por mil expuestos"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Ejercicio</strong>: repetir el análisis posterior predictivo que vimos para el modelo agregado.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-albert2009bayesian" class="csl-entry" role="listitem">
Albert, Jim. 2009. <em>Bayesian computation with R</em>. Dordrecht: Springer. <a href="http://www.springerlink.com/content/978-0-387-92298-0#section=15956&amp;page=1">http://www.springerlink.com/content/978-0-387-92298-0#section=15956&amp;page=1</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./08-mcmc.html" class="pagination-link" aria-label="Markov Chain Monte Carlo">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Métodos analíticos - 9&nbsp; Modelos jerárquicos</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./13-exp-naturales.html" rel="next">
<link href="./08-mcmc.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Sin resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Buscar"
  }
}</script>
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="site_libs/viz-1.8.2/viz.js"></script>
<link href="site_libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="site_libs/grViz-binding-1.0.10/grViz.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./09-modelos-jerarquicos.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Modelos jerárquicos</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Alternar barra lateral" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Métodos analíticos</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Buscar"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Temario y referencias</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduccion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-flujo-basico.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Flujo de trabajo básico: motivación</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-flujo-basico-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Flujo de trabajo básico: refinando el modelo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-modelos-genericos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Componentes de modelación 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-dags.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Modelos gráficos y causalidad</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-calculo-do.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Identificación y cálculo-do</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-buenos-malos-controles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Buenos y malos controles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-mcmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-modelos-jerarquicos.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Modelos jerárquicos</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-exp-naturales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Otros métodos para inferencia causal</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-series-de-tiempo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modelos de espacio de estados</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-aplicaciones-series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Aplicaciones de modelos de espacio de estados</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#primer-ejemplo-construyendo-un-modelo-jerárquico." id="toc-primer-ejemplo-construyendo-un-modelo-jerárquico." class="nav-link active" data-scroll-target="#primer-ejemplo-construyendo-un-modelo-jerárquico."><span class="header-section-number">9.1</span> Primer ejemplo: construyendo un modelo jerárquico.</a></li>
  <li><a href="#modelos-jerárquicos-para-estructuras-causales" id="toc-modelos-jerárquicos-para-estructuras-causales" class="nav-link" data-scroll-target="#modelos-jerárquicos-para-estructuras-causales"><span class="header-section-number">9.2</span> Modelos jerárquicos para estructuras causales</a></li>
  <li><a href="#primera-parte-de-estructura-jerárquica" id="toc-primera-parte-de-estructura-jerárquica" class="nav-link" data-scroll-target="#primera-parte-de-estructura-jerárquica"><span class="header-section-number">9.3</span> Primera parte de estructura jerárquica</a></li>
  <li><a href="#agregando-covariables" id="toc-agregando-covariables" class="nav-link" data-scroll-target="#agregando-covariables"><span class="header-section-number">9.4</span> Agregando covariables</a></li>
  <li><a href="#parametrización-no-centrada" id="toc-parametrización-no-centrada" class="nav-link" data-scroll-target="#parametrización-no-centrada"><span class="header-section-number">9.5</span> Parametrización no centrada</a></li>
  <li><a href="#variables-correlacionadas" id="toc-variables-correlacionadas" class="nav-link" data-scroll-target="#variables-correlacionadas"><span class="header-section-number">9.6</span> Variables correlacionadas</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Modelos jerárquicos</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Muchas veces, cuando las observaciones están agrupadas por variables categóricas, puede ser que obtengamos mejores estimaciones cuando consideramos modelos no solo para los observaciones, sino también para la variación que esperamos en parámetros relacionadas con los grupos. Esta es una técnica de modelación con la que en muchos casos podemos mejorar estimaciones, aprovechando de manera más eficiente la información que tenemos.</p>
<p>En nuestros ejemplos anteriores, por ejemplo, hemos visto casos donde al <strong>estratificar</strong> construimos modelos individuales, por ejemplo, en regresión lineal, si <span class="math inline">\(g(i)\)</span> es el grupo de la observación <span class="math inline">\(i\)</span>, utilizamos modelos de la forma:</p>
<p><span class="math display">\[\alpha_{g(i)} + \beta_{g(i)} x_i + \epsilon_i\]</span> Este modelo, donde ordenada al origen y coeficientes varían por grupo, tienen a veces el problema de resultar en estimaciones con alta variabilidad y poco informativas, especialmente cuando tenemos pocos datos por grupo. Cuando es el caso de que estos coeficientes no varían por grupo, podemos adoptar un modelo más simple, como <span class="math display">\[\alpha + \beta x_i + \epsilon_i,\]</span> que da estimaciones con menos error, pero perdemos el objetivo de la estratificación a menos que en efecto los coeficientes no varían mucho por grupo.</p>
<p>Una alternativa intermedia es construir un modelo donde <em>aprendamos</em> la estructura de variabilidad de <span class="math inline">\(\alpha_g\)</span> y <span class="math inline">\(\beta_g\)</span> a lo largo de los grupos: aprendemos de cada grupo, pero los coeficientes de cada grupo tienen una distribución a priori con parámetros que podemos aprender de los datos. Esto resulta en varias mejorías:</p>
<ol type="1">
<li>Cuando tenemos muchos datos en un grupo <span class="math inline">\(g\)</span>, usamos principalmente los datos en ese grupo para estimar los parámetros de ese grupo.</li>
<li>Cuando tenemos pocos datos en un grupo <span class="math inline">\(g\)</span>, podemos usar información del comportamiento a lo largo de los grupos para regularizar las estimaciones relacionadas con ese grupo.</li>
<li>Evitamos por un lado tener modelos subajustados (donde no consideramos distintos modelos por grupo), pero también sobreajustados (cuando tenemos poca información por grupo). El nivel de regularización lo aprendemos de los datos.</li>
</ol>
<p>El objetivo de todo esto es obtener mejores estimaciones de las cantidades de interés. Veremos más adelante cómo se relaciona esto con inferencia causal.</p>
<section id="primer-ejemplo-construyendo-un-modelo-jerárquico." class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="primer-ejemplo-construyendo-un-modelo-jerárquico."><span class="header-section-number">9.1</span> Primer ejemplo: construyendo un modelo jerárquico.</h2>
<p>Consideramos un ejemplo simple, donde queremos estimar el efecto del hospital en la tasa de mortalidad de pacientes de cirugía de corazón. Este ejemplo se puede encontrar en <span class="citation" data-cites="albert2009bayesian">Albert (<a href="#ref-albert2009bayesian" role="doc-biblioref">2009</a>)</span>. Plantearemos 3 alternativas de modelación para resolver el problema: modelo de unidades iguales, modelo de unidades independientes y finalmente modelo jerárquico.</p>
<p>Tenemos datos todas las cirugías de transplante de corazón llevadas a cabo en Estados Unidos en un periodo de 24 meses, entre octubre de 1987 y diciembre de 1989. Para cada uno de los 131 hospitales, se registró el número de cirugías de transplante de corazón, y el número de muertes durante los 30 días posteriores a la cirugía <span class="math inline">\(y\)</span>. Además, se cuenta con una predicción de la probabilidad de muerte de cada paciente individual. Esta predicción esta basada en un modelo logístico que incluye información a nivel paciente como condición médica antes de la cirugía, género, sexo y raza. En cada hospital se suman las probabilidades de muerte de sus pacientes para calcular el número esperado de muertes <span class="math inline">\(e\)</span>, que llamamos como la exposición del hospital. <span class="math inline">\(e\)</span> refleja el riesgo de muerte debido a la mezcla de pacientes que componen un hospital particular.</p>
<p>El diagrama simple que consideraremos es uno donde hospital es causa tanto de su exposición <span class="math inline">\(e\)</span> (por su tamaño, tipo de casos que atrae, etc), como de el número de personas fallecidas. A su vez, la exposición <span class="math inline">\(e\)</span> es causa del número de muertes <span class="math inline">\(y\)</span>. Nos interesa estimar el efecto directo de hospital en el número de muertes.</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DiagrammeR)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">theme_set</span>(ggplot2<span class="sc">::</span><span class="fu">theme_light</span>())</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>datos_hosp <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../datos/hearttransplants.csv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">row_number</span>())</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(datos_hosp)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
      e     y hospital
  &lt;dbl&gt; &lt;dbl&gt;    &lt;int&gt;
1   532     0        1
2   584     0        2
3   672     2        3
4   722     1        4
5   904     1        5
6  1236     0        6</code></pre>
</div>
</div>
<p>Consideramos la cantidad <span class="math inline">\(y/e\)</span> como una estimación cruda de la tasa de mortalidad. En la siguiente gráfica, observamos que parece ser la variabilidad es alta cuando el número de expuestos es relativamente baja. Nótese que la tasa de mortalidad no es muy alta en general, y que el número de muertes es relativamente bajo en muchos hospitales (puede tomar valores 0, 1, 2, etc.) Esto produce variabilidad alta para exposiciones bajas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(datos_hosp, <span class="fu">aes</span>(<span class="at">x =</span> e, <span class="at">y =</span> <span class="dv">1000</span> <span class="sc">*</span> y <span class="sc">/</span> e, <span class="at">color =</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> y))) <span class="sc">+</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">scale_x_log10</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Número de expuestos e"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Consideramos primero un modelo donde consideramos que todos los hospitales tienen una misma tasa de mortalidad. Si <span class="math inline">\(e_j\)</span> es la exposición del hospital <span class="math inline">\(j\)</span> y <span class="math inline">\(y_j\)</span> el número de muertes, entonces podemos considerar un modelo de la forma</p>
<p><span class="math display">\[y_j \sim \text{Poisson}(e_j \lambda),\]</span> Es decir, el número de muertes es Poisson con valor esperado igual al número de expuestos multiplicado por la tasa común de mortalidad.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>mod_agregado <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/heart-agregado.stan"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>datos_agregado <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(datos_hosp), <span class="at">y =</span> datos_hosp<span class="sc">$</span>y, <span class="at">e =</span> datos_hosp<span class="sc">$</span>e)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>ajuste_agregado <span class="ot">&lt;-</span> mod_agregado<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_agregado, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 0.1 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 0.1 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 0.1 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 0.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.1 seconds.
Total execution time: 0.7 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ajuste_agregado<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"lambda"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  variable  mean median     sd    mad    q5   q95  rhat ess_bulk ess_tail
  &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 lambda   0.941  0.940 0.0580 0.0570 0.849  1.04  1.00    1310.    1696.</code></pre>
</div>
</div>
<p>Los diagnósticos básicos parecen ser apropiados. Procedemos a hacer un chequeo predictivo posterior:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">912</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>ajuste_agregado<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"y_sim"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"y_sim"</span>), <span class="at">names_to =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"hospital"</span>), <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">as.integer</span>(hospital)) <span class="sc">|&gt;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(datos_hosp, <span class="at">by =</span> <span class="st">"hospital"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(hospital <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">94</span>, <span class="dv">20</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> hospital) <span class="sc">+</span> </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> y), <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Y vemos fallas en el ajuste del modelo, con varias observaciones en los extremos de las colas.</p>
<p>Podemos considerar un modelo donde cada hospital tiene su propia tasa de mortalidad.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>mod_ind <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/heart-individual.stan"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_ind)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  array[N]  int e;
  array[N]  int y;
}

parameters {
  vector&lt;lower=0&gt;[N] lambda;
}

transformed parameters {
  vector[N] media_hospital;
  // lambda es por cada 1000 expuestos:
  for (i in 1:N){
    media_hospital[i] = lambda[i] * e[i] / 1000;
  }
}

model {
  // partes no determinísticas
  y ~ poisson(media_hospital);
  lambda ~ exponential(1);
}

generated quantities {
  array[N] int y_sim;
  for (i in 1:N){
    y_sim[i] = poisson_rng(media_hospital[i]);
  }
}</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>datos_ind <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(datos_hosp), <span class="at">y =</span> datos_hosp<span class="sc">$</span>y, <span class="at">e =</span> datos_hosp<span class="sc">$</span>e)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ajuste_ind <span class="ot">&lt;-</span> mod_ind<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_ind, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 0.3 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 0.3 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 0.3 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 0.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.3 seconds.
Total execution time: 1.3 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>resumen <span class="ot">&lt;-</span> ajuste_ind<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"lambda"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, rhat, ess_bulk)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>resumen <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lambda[1]</td>
<td style="text-align: right;">0.6583536</td>
<td style="text-align: right;">0.6586216</td>
<td style="text-align: right;">1.0006192</td>
<td style="text-align: right;">5165.406</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[2]</td>
<td style="text-align: right;">0.6275285</td>
<td style="text-align: right;">0.6100568</td>
<td style="text-align: right;">1.0006134</td>
<td style="text-align: right;">5304.057</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[3]</td>
<td style="text-align: right;">1.7901338</td>
<td style="text-align: right;">1.0150032</td>
<td style="text-align: right;">1.0025797</td>
<td style="text-align: right;">7752.468</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[4]</td>
<td style="text-align: right;">1.1631030</td>
<td style="text-align: right;">0.8126933</td>
<td style="text-align: right;">1.0029684</td>
<td style="text-align: right;">6266.203</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[5]</td>
<td style="text-align: right;">1.0546849</td>
<td style="text-align: right;">0.7280221</td>
<td style="text-align: right;">1.0031314</td>
<td style="text-align: right;">7189.272</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[6]</td>
<td style="text-align: right;">0.4379974</td>
<td style="text-align: right;">0.4299703</td>
<td style="text-align: right;">1.0009799</td>
<td style="text-align: right;">5048.264</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[7]</td>
<td style="text-align: right;">0.4997928</td>
<td style="text-align: right;">0.4831605</td>
<td style="text-align: right;">1.0016690</td>
<td style="text-align: right;">5114.259</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[8]</td>
<td style="text-align: right;">0.8132338</td>
<td style="text-align: right;">0.5780811</td>
<td style="text-align: right;">1.0020729</td>
<td style="text-align: right;">7136.650</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[9]</td>
<td style="text-align: right;">2.2283861</td>
<td style="text-align: right;">1.1061633</td>
<td style="text-align: right;">0.9995477</td>
<td style="text-align: right;">7795.995</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[10]</td>
<td style="text-align: right;">0.4943771</td>
<td style="text-align: right;">0.4791999</td>
<td style="text-align: right;">1.0015410</td>
<td style="text-align: right;">6199.135</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[11]</td>
<td style="text-align: right;">0.5702635</td>
<td style="text-align: right;">0.5669676</td>
<td style="text-align: right;">0.9999858</td>
<td style="text-align: right;">4844.867</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[12]</td>
<td style="text-align: right;">0.7276062</td>
<td style="text-align: right;">0.5194843</td>
<td style="text-align: right;">0.9996745</td>
<td style="text-align: right;">7401.780</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[13]</td>
<td style="text-align: right;">0.5402685</td>
<td style="text-align: right;">0.5416521</td>
<td style="text-align: right;">1.0009094</td>
<td style="text-align: right;">4667.626</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[14]</td>
<td style="text-align: right;">1.4168025</td>
<td style="text-align: right;">0.8179681</td>
<td style="text-align: right;">1.0001357</td>
<td style="text-align: right;">8158.471</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[15]</td>
<td style="text-align: right;">1.8374637</td>
<td style="text-align: right;">0.8959153</td>
<td style="text-align: right;">1.0003162</td>
<td style="text-align: right;">7266.626</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[16]</td>
<td style="text-align: right;">0.4686611</td>
<td style="text-align: right;">0.4580127</td>
<td style="text-align: right;">1.0018647</td>
<td style="text-align: right;">5925.258</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[17]</td>
<td style="text-align: right;">0.4299892</td>
<td style="text-align: right;">0.4270344</td>
<td style="text-align: right;">1.0000900</td>
<td style="text-align: right;">4716.068</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[18]</td>
<td style="text-align: right;">1.4398167</td>
<td style="text-align: right;">0.7206289</td>
<td style="text-align: right;">1.0014807</td>
<td style="text-align: right;">7010.188</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[19]</td>
<td style="text-align: right;">0.4361010</td>
<td style="text-align: right;">0.3004024</td>
<td style="text-align: right;">1.0020841</td>
<td style="text-align: right;">7361.362</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[20]</td>
<td style="text-align: right;">0.9095600</td>
<td style="text-align: right;">0.6463542</td>
<td style="text-align: right;">0.9999059</td>
<td style="text-align: right;">6731.727</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[21]</td>
<td style="text-align: right;">0.8950893</td>
<td style="text-align: right;">0.6226518</td>
<td style="text-align: right;">1.0012198</td>
<td style="text-align: right;">7102.283</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[22]</td>
<td style="text-align: right;">0.9026263</td>
<td style="text-align: right;">0.6513811</td>
<td style="text-align: right;">1.0023325</td>
<td style="text-align: right;">7832.570</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[23]</td>
<td style="text-align: right;">2.0032715</td>
<td style="text-align: right;">0.9300883</td>
<td style="text-align: right;">1.0002577</td>
<td style="text-align: right;">8627.692</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[24]</td>
<td style="text-align: right;">1.5902697</td>
<td style="text-align: right;">0.8109377</td>
<td style="text-align: right;">1.0013903</td>
<td style="text-align: right;">8360.192</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[25]</td>
<td style="text-align: right;">1.3937997</td>
<td style="text-align: right;">0.6810875</td>
<td style="text-align: right;">1.0001507</td>
<td style="text-align: right;">7706.375</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[26]</td>
<td style="text-align: right;">0.6984656</td>
<td style="text-align: right;">0.5001702</td>
<td style="text-align: right;">0.9999789</td>
<td style="text-align: right;">6761.789</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[27]</td>
<td style="text-align: right;">0.4461970</td>
<td style="text-align: right;">0.4635060</td>
<td style="text-align: right;">1.0008701</td>
<td style="text-align: right;">6028.760</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[28]</td>
<td style="text-align: right;">1.2594830</td>
<td style="text-align: right;">0.6986847</td>
<td style="text-align: right;">1.0012426</td>
<td style="text-align: right;">7572.902</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[29]</td>
<td style="text-align: right;">1.1320465</td>
<td style="text-align: right;">0.6506051</td>
<td style="text-align: right;">1.0010134</td>
<td style="text-align: right;">7522.168</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[30]</td>
<td style="text-align: right;">1.8764928</td>
<td style="text-align: right;">0.8466750</td>
<td style="text-align: right;">1.0000906</td>
<td style="text-align: right;">8114.597</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[31]</td>
<td style="text-align: right;">1.7583001</td>
<td style="text-align: right;">0.8069553</td>
<td style="text-align: right;">1.0031715</td>
<td style="text-align: right;">7914.872</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[32]</td>
<td style="text-align: right;">1.6035141</td>
<td style="text-align: right;">0.7899954</td>
<td style="text-align: right;">1.0008976</td>
<td style="text-align: right;">8036.806</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[33]</td>
<td style="text-align: right;">1.1555324</td>
<td style="text-align: right;">0.6697436</td>
<td style="text-align: right;">1.0003042</td>
<td style="text-align: right;">7501.702</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[34]</td>
<td style="text-align: right;">1.5264033</td>
<td style="text-align: right;">0.6616486</td>
<td style="text-align: right;">1.0025811</td>
<td style="text-align: right;">7766.213</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[35]</td>
<td style="text-align: right;">0.7899508</td>
<td style="text-align: right;">0.5578459</td>
<td style="text-align: right;">0.9999789</td>
<td style="text-align: right;">7090.187</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[36]</td>
<td style="text-align: right;">1.4532723</td>
<td style="text-align: right;">0.7375873</td>
<td style="text-align: right;">1.0007186</td>
<td style="text-align: right;">9869.132</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[37]</td>
<td style="text-align: right;">0.4285978</td>
<td style="text-align: right;">0.4199888</td>
<td style="text-align: right;">0.9999393</td>
<td style="text-align: right;">5751.457</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[38]</td>
<td style="text-align: right;">1.9897239</td>
<td style="text-align: right;">0.8793718</td>
<td style="text-align: right;">1.0003754</td>
<td style="text-align: right;">9144.105</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[39]</td>
<td style="text-align: right;">0.7450916</td>
<td style="text-align: right;">0.5182003</td>
<td style="text-align: right;">0.9995554</td>
<td style="text-align: right;">8130.725</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[40]</td>
<td style="text-align: right;">1.1374976</td>
<td style="text-align: right;">0.6525920</td>
<td style="text-align: right;">1.0017931</td>
<td style="text-align: right;">8589.492</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[41]</td>
<td style="text-align: right;">1.4244404</td>
<td style="text-align: right;">0.7006266</td>
<td style="text-align: right;">1.0023593</td>
<td style="text-align: right;">6858.366</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[42]</td>
<td style="text-align: right;">1.6637849</td>
<td style="text-align: right;">0.7509851</td>
<td style="text-align: right;">0.9996539</td>
<td style="text-align: right;">7139.173</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[43]</td>
<td style="text-align: right;">1.8140081</td>
<td style="text-align: right;">0.8307266</td>
<td style="text-align: right;">1.0031303</td>
<td style="text-align: right;">8294.113</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[44]</td>
<td style="text-align: right;">0.8571984</td>
<td style="text-align: right;">0.4790812</td>
<td style="text-align: right;">1.0023603</td>
<td style="text-align: right;">7703.580</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[45]</td>
<td style="text-align: right;">1.0880935</td>
<td style="text-align: right;">0.6318477</td>
<td style="text-align: right;">1.0006352</td>
<td style="text-align: right;">7566.251</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[46]</td>
<td style="text-align: right;">1.4361456</td>
<td style="text-align: right;">0.6503897</td>
<td style="text-align: right;">0.9994384</td>
<td style="text-align: right;">8163.939</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[47]</td>
<td style="text-align: right;">0.8847706</td>
<td style="text-align: right;">0.5167225</td>
<td style="text-align: right;">1.0009238</td>
<td style="text-align: right;">8324.206</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[48]</td>
<td style="text-align: right;">1.0750511</td>
<td style="text-align: right;">0.5339827</td>
<td style="text-align: right;">1.0016644</td>
<td style="text-align: right;">8622.261</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[49]</td>
<td style="text-align: right;">0.3018790</td>
<td style="text-align: right;">0.2959550</td>
<td style="text-align: right;">1.0005851</td>
<td style="text-align: right;">5793.900</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[50]</td>
<td style="text-align: right;">0.3197025</td>
<td style="text-align: right;">0.3256233</td>
<td style="text-align: right;">0.9994628</td>
<td style="text-align: right;">5081.758</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[51]</td>
<td style="text-align: right;">0.7794332</td>
<td style="text-align: right;">0.4571045</td>
<td style="text-align: right;">1.0016552</td>
<td style="text-align: right;">9014.116</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[52]</td>
<td style="text-align: right;">1.5544563</td>
<td style="text-align: right;">0.6441122</td>
<td style="text-align: right;">1.0010498</td>
<td style="text-align: right;">9468.760</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[53]</td>
<td style="text-align: right;">1.4271320</td>
<td style="text-align: right;">0.5891077</td>
<td style="text-align: right;">1.0008465</td>
<td style="text-align: right;">8036.982</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[54]</td>
<td style="text-align: right;">0.5978108</td>
<td style="text-align: right;">0.4191586</td>
<td style="text-align: right;">1.0009834</td>
<td style="text-align: right;">7923.881</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[55]</td>
<td style="text-align: right;">0.5552029</td>
<td style="text-align: right;">0.3868425</td>
<td style="text-align: right;">0.9998611</td>
<td style="text-align: right;">7153.238</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[56]</td>
<td style="text-align: right;">0.8218314</td>
<td style="text-align: right;">0.4135715</td>
<td style="text-align: right;">0.9999527</td>
<td style="text-align: right;">8158.309</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[57]</td>
<td style="text-align: right;">0.5449502</td>
<td style="text-align: right;">0.3894453</td>
<td style="text-align: right;">0.9999776</td>
<td style="text-align: right;">6458.686</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[58]</td>
<td style="text-align: right;">0.5348793</td>
<td style="text-align: right;">0.3716342</td>
<td style="text-align: right;">1.0007056</td>
<td style="text-align: right;">6879.272</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[59]</td>
<td style="text-align: right;">0.9940355</td>
<td style="text-align: right;">0.4830594</td>
<td style="text-align: right;">1.0003936</td>
<td style="text-align: right;">10337.022</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[60]</td>
<td style="text-align: right;">0.4437015</td>
<td style="text-align: right;">0.3096729</td>
<td style="text-align: right;">1.0029815</td>
<td style="text-align: right;">6798.740</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[61]</td>
<td style="text-align: right;">0.8094635</td>
<td style="text-align: right;">0.4614335</td>
<td style="text-align: right;">0.9997315</td>
<td style="text-align: right;">7392.990</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[62]</td>
<td style="text-align: right;">1.6002911</td>
<td style="text-align: right;">0.6164370</td>
<td style="text-align: right;">1.0024416</td>
<td style="text-align: right;">7827.165</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[63]</td>
<td style="text-align: right;">0.2097533</td>
<td style="text-align: right;">0.2161231</td>
<td style="text-align: right;">1.0001642</td>
<td style="text-align: right;">5961.516</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[64]</td>
<td style="text-align: right;">0.5998704</td>
<td style="text-align: right;">0.3543889</td>
<td style="text-align: right;">1.0010214</td>
<td style="text-align: right;">7784.407</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[65]</td>
<td style="text-align: right;">0.8302986</td>
<td style="text-align: right;">0.4806738</td>
<td style="text-align: right;">1.0025724</td>
<td style="text-align: right;">8145.229</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[66]</td>
<td style="text-align: right;">0.5185593</td>
<td style="text-align: right;">0.3582384</td>
<td style="text-align: right;">1.0000323</td>
<td style="text-align: right;">6377.592</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[67]</td>
<td style="text-align: right;">0.5622628</td>
<td style="text-align: right;">0.3337068</td>
<td style="text-align: right;">1.0017643</td>
<td style="text-align: right;">7154.676</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[68]</td>
<td style="text-align: right;">2.0368689</td>
<td style="text-align: right;">0.6876336</td>
<td style="text-align: right;">1.0055722</td>
<td style="text-align: right;">9092.125</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[69]</td>
<td style="text-align: right;">1.5065795</td>
<td style="text-align: right;">0.5699950</td>
<td style="text-align: right;">1.0005292</td>
<td style="text-align: right;">8331.294</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[70]</td>
<td style="text-align: right;">0.3844750</td>
<td style="text-align: right;">0.2785353</td>
<td style="text-align: right;">1.0024007</td>
<td style="text-align: right;">6767.158</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[71]</td>
<td style="text-align: right;">1.4130430</td>
<td style="text-align: right;">0.5030808</td>
<td style="text-align: right;">1.0027316</td>
<td style="text-align: right;">9470.380</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[72]</td>
<td style="text-align: right;">0.9854344</td>
<td style="text-align: right;">0.4297633</td>
<td style="text-align: right;">1.0011536</td>
<td style="text-align: right;">9078.722</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[73]</td>
<td style="text-align: right;">0.3803165</td>
<td style="text-align: right;">0.2642860</td>
<td style="text-align: right;">0.9998781</td>
<td style="text-align: right;">6647.621</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[74]</td>
<td style="text-align: right;">0.7987972</td>
<td style="text-align: right;">0.3949402</td>
<td style="text-align: right;">1.0025064</td>
<td style="text-align: right;">8176.634</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[75]</td>
<td style="text-align: right;">1.0660119</td>
<td style="text-align: right;">0.4160935</td>
<td style="text-align: right;">1.0009367</td>
<td style="text-align: right;">8879.975</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[76]</td>
<td style="text-align: right;">0.4578378</td>
<td style="text-align: right;">0.2659640</td>
<td style="text-align: right;">1.0003575</td>
<td style="text-align: right;">8105.424</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[77]</td>
<td style="text-align: right;">0.6694614</td>
<td style="text-align: right;">0.3042366</td>
<td style="text-align: right;">1.0001769</td>
<td style="text-align: right;">7553.550</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[78]</td>
<td style="text-align: right;">0.6279796</td>
<td style="text-align: right;">0.3145321</td>
<td style="text-align: right;">1.0010509</td>
<td style="text-align: right;">8771.816</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[79]</td>
<td style="text-align: right;">0.9175721</td>
<td style="text-align: right;">0.4044257</td>
<td style="text-align: right;">1.0010852</td>
<td style="text-align: right;">9683.504</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[80]</td>
<td style="text-align: right;">1.0506304</td>
<td style="text-align: right;">0.4302338</td>
<td style="text-align: right;">1.0022860</td>
<td style="text-align: right;">7827.670</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[81]</td>
<td style="text-align: right;">0.5012500</td>
<td style="text-align: right;">0.3018368</td>
<td style="text-align: right;">1.0017463</td>
<td style="text-align: right;">7269.050</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[82]</td>
<td style="text-align: right;">0.9981823</td>
<td style="text-align: right;">0.3795039</td>
<td style="text-align: right;">1.0020283</td>
<td style="text-align: right;">8411.693</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[83]</td>
<td style="text-align: right;">1.4705479</td>
<td style="text-align: right;">0.4957901</td>
<td style="text-align: right;">1.0014892</td>
<td style="text-align: right;">8909.492</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[84]</td>
<td style="text-align: right;">0.4915877</td>
<td style="text-align: right;">0.1923660</td>
<td style="text-align: right;">1.0009710</td>
<td style="text-align: right;">8681.406</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[85]</td>
<td style="text-align: right;">0.1462425</td>
<td style="text-align: right;">0.1448864</td>
<td style="text-align: right;">1.0002353</td>
<td style="text-align: right;">5320.621</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[86]</td>
<td style="text-align: right;">0.9944543</td>
<td style="text-align: right;">0.3670536</td>
<td style="text-align: right;">1.0001632</td>
<td style="text-align: right;">9571.313</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[87]</td>
<td style="text-align: right;">1.3736207</td>
<td style="text-align: right;">0.4610920</td>
<td style="text-align: right;">1.0023358</td>
<td style="text-align: right;">8707.553</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[88]</td>
<td style="text-align: right;">1.1210221</td>
<td style="text-align: right;">0.3999280</td>
<td style="text-align: right;">1.0004132</td>
<td style="text-align: right;">11185.793</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[89]</td>
<td style="text-align: right;">0.5515533</td>
<td style="text-align: right;">0.2814439</td>
<td style="text-align: right;">1.0009379</td>
<td style="text-align: right;">9472.479</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[90]</td>
<td style="text-align: right;">0.5020421</td>
<td style="text-align: right;">0.2537327</td>
<td style="text-align: right;">0.9997052</td>
<td style="text-align: right;">7704.323</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[91]</td>
<td style="text-align: right;">1.1323293</td>
<td style="text-align: right;">0.3517581</td>
<td style="text-align: right;">1.0021811</td>
<td style="text-align: right;">11321.426</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[92]</td>
<td style="text-align: right;">0.7582604</td>
<td style="text-align: right;">0.2697603</td>
<td style="text-align: right;">1.0006837</td>
<td style="text-align: right;">9264.479</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lambda[93]</td>
<td style="text-align: right;">1.4530631</td>
<td style="text-align: right;">0.3388141</td>
<td style="text-align: right;">1.0010033</td>
<td style="text-align: right;">9858.270</td>
</tr>
<tr class="even">
<td style="text-align: left;">lambda[94]</td>
<td style="text-align: right;">1.3687930</td>
<td style="text-align: right;">0.3160478</td>
<td style="text-align: right;">1.0007887</td>
<td style="text-align: right;">8029.575</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>El problema en este caso es que tenemos intervalos que simplemente no son creíbles, en particular con aquellos hospitales que tienen poca exposición.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">912</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ajuste_ind<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"lambda"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"lambda"</span>), <span class="at">names_to =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"hospital"</span>), <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">as.integer</span>(hospital)) <span class="sc">|&gt;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(datos_hosp, <span class="at">by =</span> <span class="st">"hospital"</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">factor</span>(hospital)) <span class="sc">|&gt;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hospital, e, y) <span class="sc">|&gt;</span> </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">inf =</span> <span class="fu">quantile</span>(value, <span class="fl">0.1</span>), <span class="at">sup =</span> <span class="fu">quantile</span>(value, <span class="fl">0.9</span>)) <span class="sc">|&gt;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> e)) <span class="sc">+</span> <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> inf, <span class="at">ymax =</span> sup)) <span class="sc">+</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">1000</span> <span class="sc">*</span> y <span class="sc">/</span> e), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Número de expuestos e"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Muertes por mil expuestos"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>En este caso, la variabilidad es muy alta para hospitales con poca exposición, tanto en los datos observados como en los intervalos. Los intervalos no aportan mucha información. En este punto utilizar iniciales fuertes para las <span class="math inline">\(\lambda_j\)</span> si tenemos la información disponible. Sin embargo, los resultados serán altamente sensible a esta información inicial.</p>
<p>Una alternativa intermedia es poner una distribución inicial sobre las tasas que pueda adaptarse a los datos. Esta es una estrategia intermedia, donde permitimos variación en las <span class="math inline">\(\lambda_j\)</span> que sea consistente con la variación que observamos a lo largo de los hospitales.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>mod_jer <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/heart-jerarquico.stan"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_jer)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  array[N]  int e;
  array[N]  int y;
}

parameters {
  vector&lt;lower=0&gt;[N] lambda;
  real&lt;lower=0&gt; alpha;
  real&lt;lower=0&gt; mu;
}

transformed parameters {
  vector[N] media_hospital;
  // lambda es por cada 1000 expuestos:
  for (i in 1:N){
    media_hospital[i] = lambda[i] * e[i] /1000;
  }
}

model {
  // partes no determinísticas
  y ~ poisson(media_hospital);
  lambda ~ gamma(alpha, alpha / mu);
  mu ~ exponential(1);
  alpha ~ exponential(1);
}

generated quantities {
  array[N] int y_sim;
  for (i in 1:N){
    y_sim[i] = poisson_rng(media_hospital[i]);
  }
}</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>datos_jer <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(datos_hosp), <span class="at">y =</span> datos_hosp<span class="sc">$</span>y, <span class="at">e =</span> datos_hosp<span class="sc">$</span>e)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ajuste_jer <span class="ot">&lt;-</span> mod_jer<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_ind, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">step_size =</span> <span class="fl">0.5</span>, <span class="at">iter_sampling =</span> <span class="dv">3000</span>, <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 1 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 1 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 1 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 1 finished in 0.7 seconds.
Chain 2 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 2 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 2 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 2 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 2 finished in 0.7 seconds.
Chain 3 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 3 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 3 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 3 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 3 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 3 finished in 0.7 seconds.
Chain 4 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 4 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 4 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 4 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 4 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 4 finished in 0.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.7 seconds.
Total execution time: 3.3 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>resumen <span class="ot">&lt;-</span> ajuste_jer<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"mu"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(variable, mean, sd, rhat, ess_bulk)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>resumen <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">alpha</td>
<td style="text-align: right;">4.3771616</td>
<td style="text-align: right;">1.3246645</td>
<td style="text-align: right;">1.000421</td>
<td style="text-align: right;">2640.041</td>
</tr>
<tr class="even">
<td style="text-align: left;">mu</td>
<td style="text-align: right;">0.9626838</td>
<td style="text-align: right;">0.0818993</td>
<td style="text-align: right;">1.000104</td>
<td style="text-align: right;">9910.558</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>El problema en este caso es que tenemos intervalos que simplemente no son creíbles, en particular con aquellos hospitales que tienen poca exposición.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">912</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>ajuste_jer<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"lambda"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"lambda"</span>), <span class="at">names_to =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"hospital"</span>), <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">as.integer</span>(hospital)) <span class="sc">|&gt;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(datos_hosp, <span class="at">by =</span> <span class="st">"hospital"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">factor</span>(hospital)) <span class="sc">|&gt;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hospital, e, y) <span class="sc">|&gt;</span> </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">inf =</span> <span class="fu">quantile</span>(value, <span class="fl">0.1</span>), <span class="at">sup =</span> <span class="fu">quantile</span>(value, <span class="fl">0.9</span>), <span class="at">median =</span> <span class="fu">median</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> e)) <span class="sc">+</span> <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> inf, <span class="at">ymax =</span> sup)) <span class="sc">+</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="dv">1000</span> <span class="sc">*</span> y <span class="sc">/</span> e), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> median)) <span class="sc">+</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Número de expuestos e"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Muertes por mil expuestos"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Los resultados del chequo predictivo posterior da mejores resultados (compara con el modelo agregado):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">912</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>ajuste_jer<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"y_sim"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"y_sim"</span>), <span class="at">names_to =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"hospital"</span>), <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">as.integer</span>(hospital)) <span class="sc">|&gt;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(datos_hosp, <span class="at">by =</span> <span class="st">"hospital"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(hospital <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">94</span>, <span class="dv">20</span>)) <span class="sc">|&gt;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> hospital) <span class="sc">+</span> </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> y), <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Modelos jerárquicos y estimación
</div>
</div>
<div class="callout-body-container callout-body">
<p>Los modelos jerárquicos nos permiten ajustar modelos con <em>agregación parcial</em>: es decir, estimamos parámetros a nivel de grupo con mejor precisión que si ajustamos modelos individuales (varianza muy alta) o agregamos los datos e ignoramos el grupo (sesgo alto).</p>
<p>La regularización que ocurre en estos modelos está relacionada a la inicial que estimamos sobre parámetros indiviiduales: cuando hay muchos datos en un grupo, la inicial es menos importante, y cuando hay más datos en un grupo, la inicial es menos importante. El grado de regularización es estimado de la evidencia de variación entre los grupos.</p>
</div>
</div>
</section>
<section id="modelos-jerárquicos-para-estructuras-causales" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="modelos-jerárquicos-para-estructuras-causales"><span class="header-section-number">9.2</span> Modelos jerárquicos para estructuras causales</h2>
<p>Tomaremos ahora el ejemplo de <span class="citation" data-cites="rethinking">McElreath (<a href="#ref-rethinking" role="doc-biblioref">2020</a>)</span> de un estudio de fertilidad en Bangladesh. Nos interesa entender causas del uso de anticonceptivos en mujeres de Bangladesh, en particular:</p>
<ul>
<li>¿Cómo cambia con la edad y el tamaño de la familia el uso de anticonceptivos? Queremos ver si es posible contestar esta pregunta de forma causal con los datos disponibles.</li>
</ul>
<p>En nuestros datos tenemos muestras por distritos (zonas geográficas) que nos puede ayudar o controlar efectos relacionados con variables relacionadas con distrito (como acceso a servicios de salud, etc).</p>
<p>Comenzamos con un diagrama que describe causas posibles de uso de anticonceptivos:</p>
<ul>
<li>Los distritos (zona donde vive cada persona) influye causalmente en uso de anticonceptivos.</li>
<li>La edad de la mujer influye en el uso de anticonceptivos.</li>
<li>El número de hijos influye en el uso de anticonceptivos.</li>
<li>El status de urbano/rural influye en el uso de anticonceptivos.</li>
</ul>
<p>Nuestro primer diagrama es:</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">'</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2, rankdir=BT]</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="st">    AC</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="st">    Distrito</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="st">    Edad</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="st">    Hijos</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="st">    Urbano</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="st">   Edad -&gt; AC [color="red"]</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="st">   Hijos -&gt; AC [color="red"]</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="st">   Urbano -&gt; AC</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="st">   Distrito -&gt; AC</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="st">  rank = same; Urbano; Hijos</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="st">'</span>, <span class="at">width =</span> <span class="dv">350</span>, <span class="at">height =</span> <span class="dv">140</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-c6b3e204df1a58fcf966" style="width:100%;height:260px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-c6b3e204df1a58fcf966">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2, rankdir=BT]\n  node [shape=plaintext]\n    AC\n    Distrito\n    Edad\n    Hijos\n    Urbano\n  edge [minlen = 3]\n   Edad -> AC [color=\"red\"]\n   Hijos -> AC [color=\"red\"]\n   Urbano -> AC\n   Distrito -> AC\n   \n{\n  rank = same; Urbano; Hijos\n}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Donde las flechas rojas son efectos causales de interés, y queremos considerar si es posible identificarlos y estimarlos posteriormente. Para decidir cómo construir nuestro modelo (qué variables podemos incluir o no y por qué), consideraremos relaciones entre las causas, que mostramos como flechas rojas.</p>
<ul>
<li>Ninguna variable es causa de edad, pero Edad puede ser causa de número de hijos (más tiempo para tener más hijos).</li>
<li>Urbano/rural puede ser causa número de hijos (costumbres)</li>
<li>Distritos tienen distintos niveles de regiones urbano/rural</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">'</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2, rankdir=BT]</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="st">    AC</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="st">    Distrito</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="st">    Edad</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="st">    Hijos</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="st">    Urbano</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="st">   Edad -&gt; AC [color="red"]</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="st">   Hijos -&gt; AC [color="red"]</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="st">   Urbano -&gt; AC</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="st">   Distrito -&gt; AC</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="st">   Edad -&gt; Hijos </span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="st">   Urbano -&gt; Hijos</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="st">   Distrito -&gt; Urbano</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="st">  rank = same; Urbano; Hijos</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="st">  rank = min; Urbano; Hijos</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="st">'</span>, <span class="at">width =</span> <span class="dv">350</span>, <span class="at">height =</span> <span class="dv">140</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-e637d7e101c29751d63e" style="width:100%;height:260px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-e637d7e101c29751d63e">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2, rankdir=BT]\n  node [shape=plaintext]\n    AC\n    Distrito\n    Edad\n    Hijos\n    Urbano\n  edge [minlen = 3]\n   Edad -> AC [color=\"red\"]\n   Hijos -> AC [color=\"red\"]\n   Urbano -> AC\n   Distrito -> AC\n   Edad -> Hijos \n   Urbano -> Hijos\n   Distrito -> Urbano\n{\n  rank = same; Urbano; Hijos\n  rank = min; Urbano; Hijos\n}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>De este diagrama, concluimos para empezar:</p>
<ul>
<li>Para el efecto total de edad, <strong>no</strong> debemos estratificar por número de hijos (bloqueamos un camino causal).</li>
</ul>
<p>Finalmente, puedes pensar en otras relaciones entre causas que puedan dificultar la identificación causal, como las que marcamos en naranja en el siguiente diagrama, donde</p>
<ul>
<li>Tipo de familia (no observado) puede afectar tanto a número de niños como a uso de anticonceptivos. Esta sería una variable confusora para estimar el efecto de número de niños sobre uso de anticonceptivos.</li>
</ul>
<p>Vemos que encontrar el efecto causal de número de hijos puede tener dificultades considerables en este caso:</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grViz</span>(<span class="st">'</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="st">digraph {</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [ranksep = 0.2, rankdir=BT]</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=plaintext]</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="st">    AC</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="st">    Distrito</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="st">    Edad</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="st">    Hijos</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="st">    Urbano</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape=ellipse]</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="st">    Familia</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="st">  edge [minlen = 3]</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="st">   Edad -&gt; AC [color="red"]</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="st">   Hijos -&gt; AC [color="red"]</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="st">   Urbano -&gt; AC</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="st">   Distrito -&gt; AC</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="st">   Edad -&gt; Hijos </span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="st">   Urbano -&gt; Hijos</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="st">   Distrito -&gt; Urbano</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="st">   Familia -&gt; Hijos [color="orange"]</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="st">   Familia -&gt; AC [color="orange"]</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="st">  rank = same; Urbano; Hijos</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="st">    rank = min; Urbano; Hijos</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="st">'</span>, <span class="at">width =</span> <span class="dv">350</span>, <span class="at">height =</span> <span class="dv">140</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-9ba901fb8f3c3e051450" style="width:100%;height:260px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-9ba901fb8f3c3e051450">{"x":{"diagram":"\ndigraph {\n  graph [ranksep = 0.2, rankdir=BT]\n  node [shape=plaintext]\n    AC\n    Distrito\n    Edad\n    Hijos\n    Urbano\n  node [shape=ellipse]\n    Familia\n  edge [minlen = 3]\n   Edad -> AC [color=\"red\"]\n   Hijos -> AC [color=\"red\"]\n   Urbano -> AC\n   Distrito -> AC\n   Edad -> Hijos \n   Urbano -> Hijos\n   Distrito -> Urbano\n   Familia -> Hijos [color=\"orange\"]\n   Familia -> AC [color=\"orange\"]\n\n{\n  rank = same; Urbano; Hijos\n    rank = min; Urbano; Hijos\n\n}\n}\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="primera-parte-de-estructura-jerárquica" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="primera-parte-de-estructura-jerárquica"><span class="header-section-number">9.3</span> Primera parte de estructura jerárquica</h2>
<p>Empecemos primero como en nuestro ejemplo anterior, modelando jerárquicamente el uso de anticonceptivos segun distrito (solo vemos el efecto <span class="math inline">\(D\to AC\)</span>). Esta variable nos puede ayudar a controlar variables asociadas con distrito que mejore la estimación de otras cantidades de interés, y es importante usar una estructura jerárquica pues los tamaños de muestra por distrito son considerablemente distintos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>bangladesh <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../datos/bangladesh.csv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">district =</span> <span class="fu">factor</span>(district, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">61</span>)) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 1934 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (6): woman, district, use.contraception, living.children, age.centered, ...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>bangladesh  <span class="sc">|&gt;</span> <span class="fu">count</span>(district, <span class="at">.drop =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">district_fct =</span> <span class="fu">fct_reorder</span>(district, n)) <span class="sc">|&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.numeric</span>(district), <span class="at">y =</span> n)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Distrito num"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Nótese que un distrito no contiene ninguna observación, y que hay distritos con muy pocas observaciones. Este es un caso típico donde un modelo jerárquico puede mejorar nuestras estimaciones de la relación de distrito con la variable respuesta de interés.</p>
<p>Los datos, por persona, los modelamos como sigue (regresión logística): <span class="math display">\[
\begin{align}
C_i &amp;\sim \text{Bernoulli}(p_i)\\
\textrm{logit}(p_i) &amp;= \alpha_{D[i]}  \\
\alpha_j &amp;\sim N(\bar{\alpha},\sigma) \\
\bar{\alpha} &amp;\sim N(0, 1) \\
\sigma &amp;\sim N^+(0, 1) \\
\end{align}
\]</span> Que implementado en stan puede quedar como:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>mod_1_bangladesh <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/bangladesh-1.stan"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_1_bangladesh)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  int&lt;lower=0&gt; N_d;
  array[N]  int ac_uso;
  array[N]  int distrito;
}

parameters {
  real alpha_bar;
  vector[N_d] alpha;
  real &lt;lower=0&gt; sigma;
}

transformed parameters {

}

model {
  // partes no determinísticas
  ac_uso ~ bernoulli_logit(alpha[distrito]);
  alpha ~ normal(alpha_bar, sigma);
  // parámetros poblacionales
  alpha_bar ~ normal(0, 1);
  sigma ~ normal(0, 1);
}

generated quantities {
  vector[N_d] prob_distrito;
  for (i in 1:N_d) {
    prob_distrito[i] = inv_logit(alpha[i]);
  }

}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>datos_lst <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">ac_uso =</span> bangladesh<span class="sc">$</span>use.contraception,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">distrito =</span> <span class="fu">as.integer</span>(bangladesh<span class="sc">$</span>district),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(bangladesh),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_d =</span> <span class="dv">61</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>ajuste_1_bangladesh <span class="ot">&lt;-</span> mod_1_bangladesh<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lst,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">refresh =</span> <span class="dv">1000</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 1.5 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 1.5 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 1.4 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 1.5 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.5 seconds.
Total execution time: 6.3 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>ajuste_1_bangladesh<span class="sc">$</span><span class="fu">cmdstan_diagnose</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processing csv files: /tmp/RtmpUfNyuC/bangladesh-1-202405150012-1-41cb20.csv, /tmp/RtmpUfNyuC/bangladesh-1-202405150012-2-41cb20.csv, /tmp/RtmpUfNyuC/bangladesh-1-202405150012-3-41cb20.csv, /tmp/RtmpUfNyuC/bangladesh-1-202405150012-4-41cb20.csv

Checking sampler transitions treedepth.
Treedepth satisfactory for all transitions.

Checking sampler transitions for divergences.
No divergent transitions found.

Checking E-BFMI - sampler transitions HMC potential energy.
E-BFMI satisfactory.

Effective sample size satisfactory.

Split R-hat values satisfactory all parameters.

Processing complete, no problems detected.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>ajuste_1_bangladesh<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha_bar"</span>, <span class="st">"sigma"</span>, <span class="st">"alpha"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">alpha_bar</td>
<td style="text-align: right;">-0.54</td>
<td style="text-align: right;">-0.54</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">-0.68</td>
<td style="text-align: right;">-0.40</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4085.44</td>
<td style="text-align: right;">3240.28</td>
</tr>
<tr class="even">
<td style="text-align: left;">sigma</td>
<td style="text-align: right;">0.52</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1466.15</td>
<td style="text-align: right;">2140.47</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[1]</td>
<td style="text-align: right;">-1.00</td>
<td style="text-align: right;">-1.00</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">-1.33</td>
<td style="text-align: right;">-0.67</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6708.19</td>
<td style="text-align: right;">2445.02</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[2]</td>
<td style="text-align: right;">-0.59</td>
<td style="text-align: right;">-0.59</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-1.19</td>
<td style="text-align: right;">-0.02</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7627.66</td>
<td style="text-align: right;">2919.07</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[3]</td>
<td style="text-align: right;">-0.24</td>
<td style="text-align: right;">-0.25</td>
<td style="text-align: right;">0.52</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">-1.04</td>
<td style="text-align: right;">0.61</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6914.02</td>
<td style="text-align: right;">2660.74</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[4]</td>
<td style="text-align: right;">-0.18</td>
<td style="text-align: right;">-0.18</td>
<td style="text-align: right;">0.29</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">-0.65</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6717.37</td>
<td style="text-align: right;">3126.67</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[5]</td>
<td style="text-align: right;">-0.58</td>
<td style="text-align: right;">-0.57</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">-1.05</td>
<td style="text-align: right;">-0.11</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7317.02</td>
<td style="text-align: right;">2743.21</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[6]</td>
<td style="text-align: right;">-0.81</td>
<td style="text-align: right;">-0.80</td>
<td style="text-align: right;">0.24</td>
<td style="text-align: right;">0.24</td>
<td style="text-align: right;">-1.21</td>
<td style="text-align: right;">-0.43</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6410.45</td>
<td style="text-align: right;">3010.84</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[7]</td>
<td style="text-align: right;">-0.76</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-1.37</td>
<td style="text-align: right;">-0.16</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7030.13</td>
<td style="text-align: right;">2965.32</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[8]</td>
<td style="text-align: right;">-0.51</td>
<td style="text-align: right;">-0.51</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">-0.98</td>
<td style="text-align: right;">-0.06</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">8071.81</td>
<td style="text-align: right;">3194.77</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[9]</td>
<td style="text-align: right;">-0.71</td>
<td style="text-align: right;">-0.71</td>
<td style="text-align: right;">0.34</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: right;">-1.27</td>
<td style="text-align: right;">-0.16</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7868.70</td>
<td style="text-align: right;">2515.75</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[10]</td>
<td style="text-align: right;">-1.14</td>
<td style="text-align: right;">-1.13</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">0.43</td>
<td style="text-align: right;">-1.85</td>
<td style="text-align: right;">-0.49</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4682.64</td>
<td style="text-align: right;">3203.02</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[11]</td>
<td style="text-align: right;">-1.55</td>
<td style="text-align: right;">-1.53</td>
<td style="text-align: right;">0.43</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">-2.31</td>
<td style="text-align: right;">-0.90</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3598.80</td>
<td style="text-align: right;">2719.42</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[12]</td>
<td style="text-align: right;">-0.61</td>
<td style="text-align: right;">-0.61</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">-1.11</td>
<td style="text-align: right;">-0.11</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7084.31</td>
<td style="text-align: right;">3243.42</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[13]</td>
<td style="text-align: right;">-0.43</td>
<td style="text-align: right;">-0.43</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: right;">-0.97</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7175.59</td>
<td style="text-align: right;">2941.12</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[14]</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.69</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6439.59</td>
<td style="text-align: right;">2988.87</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[15]</td>
<td style="text-align: right;">-0.56</td>
<td style="text-align: right;">-0.56</td>
<td style="text-align: right;">0.34</td>
<td style="text-align: right;">0.34</td>
<td style="text-align: right;">-1.13</td>
<td style="text-align: right;">-0.01</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">8492.92</td>
<td style="text-align: right;">2772.50</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[16]</td>
<td style="text-align: right;">-0.12</td>
<td style="text-align: right;">-0.12</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-0.68</td>
<td style="text-align: right;">0.47</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7681.17</td>
<td style="text-align: right;">2730.42</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[17]</td>
<td style="text-align: right;">-0.75</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-1.33</td>
<td style="text-align: right;">-0.19</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7398.34</td>
<td style="text-align: right;">3177.56</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[18]</td>
<td style="text-align: right;">-0.63</td>
<td style="text-align: right;">-0.63</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">-1.07</td>
<td style="text-align: right;">-0.21</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7939.92</td>
<td style="text-align: right;">3138.83</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[19]</td>
<td style="text-align: right;">-0.49</td>
<td style="text-align: right;">-0.49</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">-1.03</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7839.24</td>
<td style="text-align: right;">3075.07</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[20]</td>
<td style="text-align: right;">-0.48</td>
<td style="text-align: right;">-0.48</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">-1.11</td>
<td style="text-align: right;">0.16</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">8125.28</td>
<td style="text-align: right;">2828.64</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[21]</td>
<td style="text-align: right;">-0.51</td>
<td style="text-align: right;">-0.51</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">-1.10</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7697.11</td>
<td style="text-align: right;">3023.53</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[22]</td>
<td style="text-align: right;">-0.96</td>
<td style="text-align: right;">-0.94</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">-1.58</td>
<td style="text-align: right;">-0.36</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5859.65</td>
<td style="text-align: right;">3134.66</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[23]</td>
<td style="text-align: right;">-0.76</td>
<td style="text-align: right;">-0.75</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">-1.39</td>
<td style="text-align: right;">-0.15</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6525.52</td>
<td style="text-align: right;">2626.27</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[24]</td>
<td style="text-align: right;">-1.18</td>
<td style="text-align: right;">-1.15</td>
<td style="text-align: right;">0.43</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">-1.91</td>
<td style="text-align: right;">-0.50</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5731.86</td>
<td style="text-align: right;">2963.71</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[25]</td>
<td style="text-align: right;">-0.27</td>
<td style="text-align: right;">-0.28</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: right;">-0.64</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7193.19</td>
<td style="text-align: right;">2720.95</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[26]</td>
<td style="text-align: right;">-0.50</td>
<td style="text-align: right;">-0.49</td>
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">-1.16</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7883.64</td>
<td style="text-align: right;">3156.22</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[27]</td>
<td style="text-align: right;">-1.19</td>
<td style="text-align: right;">-1.17</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">-1.69</td>
<td style="text-align: right;">-0.70</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6331.04</td>
<td style="text-align: right;">2802.17</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[28]</td>
<td style="text-align: right;">-0.96</td>
<td style="text-align: right;">-0.96</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">0.27</td>
<td style="text-align: right;">-1.43</td>
<td style="text-align: right;">-0.50</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7081.91</td>
<td style="text-align: right;">2409.17</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[29]</td>
<td style="text-align: right;">-0.80</td>
<td style="text-align: right;">-0.80</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">-1.33</td>
<td style="text-align: right;">-0.30</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7163.13</td>
<td style="text-align: right;">2631.89</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[30]</td>
<td style="text-align: right;">-0.14</td>
<td style="text-align: right;">-0.14</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: right;">-0.51</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7345.14</td>
<td style="text-align: right;">2399.03</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[31]</td>
<td style="text-align: right;">-0.30</td>
<td style="text-align: right;">-0.30</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">-0.76</td>
<td style="text-align: right;">0.16</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6597.27</td>
<td style="text-align: right;">2535.55</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[32]</td>
<td style="text-align: right;">-0.98</td>
<td style="text-align: right;">-0.97</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-1.58</td>
<td style="text-align: right;">-0.41</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5813.85</td>
<td style="text-align: right;">2675.61</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[33]</td>
<td style="text-align: right;">-0.43</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">-1.05</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7067.69</td>
<td style="text-align: right;">2939.45</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[34]</td>
<td style="text-align: right;">0.27</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">-0.21</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5706.61</td>
<td style="text-align: right;">2959.05</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[35]</td>
<td style="text-align: right;">-0.13</td>
<td style="text-align: right;">-0.13</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">-0.55</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6863.83</td>
<td style="text-align: right;">3322.41</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[36]</td>
<td style="text-align: right;">-0.58</td>
<td style="text-align: right;">-0.56</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">-1.18</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7167.41</td>
<td style="text-align: right;">3256.03</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[37]</td>
<td style="text-align: right;">-0.22</td>
<td style="text-align: right;">-0.23</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">-0.85</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7072.38</td>
<td style="text-align: right;">3072.21</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[38]</td>
<td style="text-align: right;">-0.72</td>
<td style="text-align: right;">-0.71</td>
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">-1.41</td>
<td style="text-align: right;">-0.05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7256.40</td>
<td style="text-align: right;">3111.33</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[39]</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">-0.71</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7096.85</td>
<td style="text-align: right;">3273.86</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[40]</td>
<td style="text-align: right;">-0.26</td>
<td style="text-align: right;">-0.26</td>
<td style="text-align: right;">0.27</td>
<td style="text-align: right;">0.27</td>
<td style="text-align: right;">-0.70</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7961.40</td>
<td style="text-align: right;">3175.23</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[41]</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">-0.20</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">-0.71</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">6772.06</td>
<td style="text-align: right;">2794.87</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[42]</td>
<td style="text-align: right;">-0.24</td>
<td style="text-align: right;">-0.24</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">-0.92</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7046.38</td>
<td style="text-align: right;">2770.57</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[43]</td>
<td style="text-align: right;">-0.04</td>
<td style="text-align: right;">-0.04</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">-0.46</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7561.89</td>
<td style="text-align: right;">2316.58</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[44]</td>
<td style="text-align: right;">-0.96</td>
<td style="text-align: right;">-0.95</td>
<td style="text-align: right;">0.34</td>
<td style="text-align: right;">0.34</td>
<td style="text-align: right;">-1.53</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6056.58</td>
<td style="text-align: right;">3031.15</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[45]</td>
<td style="text-align: right;">-0.66</td>
<td style="text-align: right;">-0.65</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">-1.13</td>
<td style="text-align: right;">-0.19</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6817.39</td>
<td style="text-align: right;">2466.31</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[46]</td>
<td style="text-align: right;">-0.01</td>
<td style="text-align: right;">-0.01</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">-0.33</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7247.88</td>
<td style="text-align: right;">2908.16</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[47]</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">-0.95</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7726.65</td>
<td style="text-align: right;">2941.93</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[48]</td>
<td style="text-align: right;">-0.07</td>
<td style="text-align: right;">-0.08</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">-0.51</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">7051.22</td>
<td style="text-align: right;">3035.58</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[49]</td>
<td style="text-align: right;">-0.86</td>
<td style="text-align: right;">-0.85</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">-1.66</td>
<td style="text-align: right;">-0.11</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6613.44</td>
<td style="text-align: right;">2913.84</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[50]</td>
<td style="text-align: right;">-0.29</td>
<td style="text-align: right;">-0.30</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-0.88</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">7805.72</td>
<td style="text-align: right;">3156.53</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[51]</td>
<td style="text-align: right;">-0.28</td>
<td style="text-align: right;">-0.27</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">-0.73</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">7001.68</td>
<td style="text-align: right;">2937.20</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[52]</td>
<td style="text-align: right;">-0.30</td>
<td style="text-align: right;">-0.29</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: right;">0.24</td>
<td style="text-align: right;">-0.69</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6897.06</td>
<td style="text-align: right;">2924.66</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[53]</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">-0.41</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-1.02</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">8921.96</td>
<td style="text-align: right;">2768.60</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[54]</td>
<td style="text-align: right;">-0.54</td>
<td style="text-align: right;">-0.53</td>
<td style="text-align: right;">0.53</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">-1.42</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6146.52</td>
<td style="text-align: right;">2658.35</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[55]</td>
<td style="text-align: right;">-0.79</td>
<td style="text-align: right;">-0.77</td>
<td style="text-align: right;">0.47</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">-1.60</td>
<td style="text-align: right;">-0.03</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6719.53</td>
<td style="text-align: right;">2708.30</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[56]</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">-0.34</td>
<td style="text-align: right;">0.55</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6564.85</td>
<td style="text-align: right;">2834.75</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[57]</td>
<td style="text-align: right;">-1.07</td>
<td style="text-align: right;">-1.05</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-1.65</td>
<td style="text-align: right;">-0.51</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6170.13</td>
<td style="text-align: right;">3165.92</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[58]</td>
<td style="text-align: right;">-0.30</td>
<td style="text-align: right;">-0.30</td>
<td style="text-align: right;">0.29</td>
<td style="text-align: right;">0.29</td>
<td style="text-align: right;">-0.79</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6784.27</td>
<td style="text-align: right;">3517.21</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[59]</td>
<td style="text-align: right;">-1.00</td>
<td style="text-align: right;">-0.98</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">-1.78</td>
<td style="text-align: right;">-0.29</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6168.08</td>
<td style="text-align: right;">2615.60</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha[60]</td>
<td style="text-align: right;">-1.00</td>
<td style="text-align: right;">-0.99</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">-1.55</td>
<td style="text-align: right;">-0.49</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5765.81</td>
<td style="text-align: right;">3026.31</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alpha[61]</td>
<td style="text-align: right;">-1.06</td>
<td style="text-align: right;">-1.05</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.29</td>
<td style="text-align: right;">-1.58</td>
<td style="text-align: right;">-0.58</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6304.21</td>
<td style="text-align: right;">3056.65</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>Los diagnósticos no apuntan a ningún problema, y obtenemos estimaciones tanto para los parámetros poblacionales como para los parámetros por distrito.</p>
<p>Veamos cómo se ven las estimaciones crudas (proporción de uso de anticonceptivos en cada distrito) contra las estimaciones de nuestro modelo jerárquico.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>probs_1 <span class="ot">&lt;-</span> ajuste_1_bangladesh<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"prob_distrito"</span>, <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"prob"</span>), <span class="at">names_to =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"district"</span>), </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">extra =</span> <span class="st">"drop"</span>, <span class="at">convert =</span> <span class="cn">TRUE</span>)  <span class="sc">|&gt;</span> </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(district) <span class="sc">|&gt;</span> <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(value),</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">q5 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.05</span>),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">q95 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.95</span>)) </span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>resumen_1 <span class="ot">&lt;-</span> bangladesh <span class="sc">|&gt;</span> <span class="fu">group_by</span>(district) <span class="sc">|&gt;</span> </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">prop_cruda =</span> <span class="fu">mean</span>(use.contraception), <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">district =</span> <span class="fu">as.integer</span>(district))</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>probs_1 <span class="sc">|&gt;</span> <span class="fu">left_join</span>(resumen_1) <span class="sc">|&gt;</span> </span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> district)) <span class="sc">+</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> media), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q5, <span class="at">ymax =</span> q95), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> prop_cruda, <span class="at">size =</span> n), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Observaciones</strong>: - Nótese que cuando la muestra de un distrito es chica, la cantidad de encogimiento es grande (el estimador crudo está cercano de nuestro estimador jerárquico si la muestra es grande). El caso extremo es el distrito 53, donde tenemos muestra de 0. En ese caso, usamos la inicial ajustada para producir estimaciones de la posterior - Adicionalmente, cuando la muestra es chica en un distrito, tenemos también más incertidumbre en la estimación de la proporción de uso de anticonceptivos. - Examina por ejemplo el distrito 11: obtuvimos 0 casos de usos de anticonceptivos, y es una mala estimación de esta proporción. El estimador del modelo jerárquico es de los más bajos, pero se encoge hacia la media poblacional.</p>
</section>
<section id="agregando-covariables" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="agregando-covariables"><span class="header-section-number">9.4</span> Agregando covariables</h2>
<p>Consideremos ahora la variable de urbano-rural. Incluiremos esta variable también, considerando que su efecto puede variar por distrito:</p>
<p><span class="math display">\[
\begin{align}
C_i &amp;\sim \text{Bernoulli}(p_i)\\
\textrm{logit}(p_i) &amp;= \alpha_{D[i]} + \beta_{D[i]} U_i \\
\alpha_j &amp;\sim N(\bar{\alpha},\sigma_{\alpha}) \\
\beta_j &amp;\sim N(\bar{\beta},\sigma_{ \beta}) \\
\bar{\alpha}, \bar{\beta}  &amp;\sim N(0, 1)\\
\sigma_{\alpha}, \sigma_{\beta} &amp;\sim N^+(0, 1) \\
\end{align}
\]</span> Que implementado en stan puede quedar como:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>mod_2_bangladesh <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/bangladesh-2.stan"</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_2_bangladesh)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  int&lt;lower=0&gt; N_d;
  array[N]  int ac_uso;
  array[N]  int distrito;
  vector[N] urbano;
}

parameters {
  real alpha_bar;
  real beta_bar;
  vector[N_d] alpha;
  vector[N_d] beta;
  real &lt;lower=0&gt; sigma_alpha;
  real &lt;lower=0&gt; sigma_beta;
}

transformed parameters {

}

model {
  // partes no determinísticas
  ac_uso ~ bernoulli_logit(alpha[distrito] + beta[distrito] .* urbano);
  alpha ~ normal(alpha_bar, sigma_alpha);
  beta ~ normal(beta_bar, sigma_beta);
  // parámetros poblacionales
  alpha_bar ~ normal(0, 1);
  beta_bar ~ normal(0, 1);
  sigma_alpha ~ normal(0, 1);
  sigma_beta ~ normal(0, 1);
}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>datos_lst <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">ac_uso =</span> bangladesh<span class="sc">$</span>use.contraception,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">distrito =</span> <span class="fu">as.integer</span>(bangladesh<span class="sc">$</span>district),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">urbano =</span> bangladesh<span class="sc">$</span>urban,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(bangladesh),</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_d =</span> <span class="dv">61</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>ajuste_2_bangladesh <span class="ot">&lt;-</span> mod_2_bangladesh<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lst,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">refresh =</span> <span class="dv">1000</span>, <span class="at">seed =</span> <span class="dv">9394</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: normal_lpdf: Scale parameter is 0, but must be positive! (in '/tmp/RtmpUfNyuC/model-2b341f1a722f.stan', line 26, column 2 to column 38)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 4.1 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 4.1 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: normal_lpdf: Scale parameter is 0, but must be positive! (in '/tmp/RtmpUfNyuC/model-2b341f1a722f.stan', line 25, column 2 to column 41)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 4.1 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 3.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 3.9 seconds.
Total execution time: 15.8 seconds.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 19 of 4000 (0.0%) transitions ended with a divergence.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 3 of 4 chains had an E-BFMI less than 0.3.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
</div>
<p>Y encontramos divergencias en el ajuste. Veamos los tamaños efectivos de muestra y los valores rhat:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>ajuste_2_bangladesh<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha_bar"</span>, <span class="st">"beta_bar"</span>, <span class="st">"sigma_alpha"</span>, <span class="st">"sigma_beta"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">alpha_bar</td>
<td style="text-align: right;">-0.70</td>
<td style="text-align: right;">-0.70</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">-0.85</td>
<td style="text-align: right;">-0.55</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2294.96</td>
<td style="text-align: right;">2911.84</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta_bar</td>
<td style="text-align: right;">0.62</td>
<td style="text-align: right;">0.62</td>
<td style="text-align: right;">0.16</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">0.87</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1307.26</td>
<td style="text-align: right;">2195.23</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma_alpha</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">0.64</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">575.25</td>
<td style="text-align: right;">685.91</td>
</tr>
<tr class="even">
<td style="text-align: left;">sigma_beta</td>
<td style="text-align: right;">0.57</td>
<td style="text-align: right;">0.57</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: right;">0.91</td>
<td style="text-align: right;">1.02</td>
<td style="text-align: right;">139.35</td>
<td style="text-align: right;">143.32</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>Aunque los valores de rhat no presentan problema, vemos que los tamaños efectivos de muestra para las desviaciones estándar poblacionales son malos (especialmente para el parámetro asociado a <span class="math inline">\(\beta\)</span>). Las trazas indican que quizá el problema no es muy grave, pero las cadenas muestran cierta heterogeneidad y autocorrelación alta:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>ajuste_2_bangladesh<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"sigma_beta"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mcmc_trace</span>()</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Aunque quizá en este ejemplo es posible correr más iteraciones y obtener resultados más confiables, en estos casos es mejor diagnosticar el problema y corregirlo: obtendremos mejores estimaciones de manera más rápida.</p>
</section>
<section id="parametrización-no-centrada" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="parametrización-no-centrada"><span class="header-section-number">9.5</span> Parametrización no centrada</h2>
<p>El problema que ocurre en este modelo es uno que aparece con cierta frecuencia en modelos jerárquicos, y está relacionado con el embudo de Neal que vimos al final de la sección anterior.</p>
<p>En nuestro ejemplo <span class="math inline">\(\beta_j\)</span> tienen una inicial que depende de parámetros <span class="math inline">\(N(\beta_0,\sigma_{\beta})\)</span>. Cuando <span class="math inline">\(\sigma_{\beta}\)</span> es chica, esperamos que haya poca variación en las <span class="math inline">\(\beta_j\)</span>, y cuando es grande, por el contrario, esperamos que haya mucha variación. Esto produce una especie de embudo de Neal:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>sims_beta <span class="ot">&lt;-</span> ajuste_2_bangladesh<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma_beta"</span>), <span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>diagnosticos_tbl <span class="ot">&lt;-</span> ajuste_2_bangladesh<span class="sc">$</span><span class="fu">sampler_diagnostics</span>(<span class="at">format =</span> <span class="st">"df"</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>sims_beta <span class="ot">&lt;-</span> <span class="fu">left_join</span>(sims_beta, diagnosticos_tbl)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(.chain, .iteration, .draw)`</code></pre>
</div>
</div>
<p>Podemos examinar gráficas de pares para ver donde aparece el problema: efectivamente, ocurre para valores chicos de <span class="math inline">\(\sigma\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>sims_beta <span class="sc">|&gt;</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">log</span>(sigma_beta), <span class="at">x =</span> <span class="st">`</span><span class="at">beta[1]</span><span class="st">`</span>, <span class="at">size =</span> <span class="fu">factor</span>(divergent__),</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> <span class="fu">factor</span>(divergent__))) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"log sigma_beta"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"beta"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Para corregir este problema (en el mejor de los casos ineficiencia), podemos usar el mismo truco que vimos al final de la sección anterior. En lugar de escribir <span class="math display">\[\alpha_j = N(\bar{\alpha}, \sigma_{\alpha})\]</span> Definimos los valores <span class="math inline">\(z_j\)</span> como <span class="math inline">\(z_j\sim N(0,1)\)</span> y escribimos <span class="math display">\[\alpha_j = \bar{\alpha} + \sigma_{\alpha} z_j\]</span> Y lo mismo para el parámetro <span class="math inline">\(\beta\)</span>. <strong>Se trata exactamente del mismo modelo</strong>, pero está parametrizado de manera distinta.</p>
<p>Nuestro modelo reparametrizado se vería como sigue:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>mod_3_bangladesh <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/bangladesh-3.stan"</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_3_bangladesh)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  int&lt;lower=0&gt; N_d;
  array[N]  int ac_uso;
  array[N]  int distrito;
  vector[N] urbano;
}

parameters {
  real alpha_bar;
  real beta_bar;
  vector[N_d] z_alpha;
  vector[N_d] z_beta;
  real &lt;lower=0&gt; sigma_alpha;
  real &lt;lower=0&gt; sigma_beta;
}

transformed parameters {
  vector[N_d] alpha;
  vector[N_d] beta;

  alpha = alpha_bar + sigma_alpha * z_alpha;
  beta = beta_bar + sigma_beta * z_beta;
}

model {
  // partes no determinísticas
  ac_uso ~ bernoulli_logit(alpha[distrito] + beta[distrito] .* urbano);
  z_alpha ~ normal(0, 1);
  z_beta ~ normal(0, 1);
  // parámetros poblacionales
  alpha_bar ~ normal(0, 1);
  beta_bar ~ normal(0, 1);
  sigma_alpha ~ normal(0, 1);
  sigma_beta ~ normal(0, 1);
}

generated quantities {
  vector[N_d] prob_distrito_urbano;
  vector[N_d] prob_distrito_rural;

  for (i in 1:N_d) {
    prob_distrito_urbano[i] = inv_logit(alpha[i] + beta[i]);
    prob_distrito_rural[i] = inv_logit(alpha[i]);
  }
  // Simular de a priori poblacional
  vector[2] beta_sim;
  beta_sim[1] = normal_rng(alpha_bar, sigma_alpha);
  beta_sim[2] = normal_rng(beta_bar, sigma_beta);
}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>ajuste_3_bangladesh <span class="ot">&lt;-</span> mod_3_bangladesh<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lst,</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">refresh =</span> <span class="dv">1000</span>, <span class="at">seed =</span> <span class="dv">9394</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 3.8 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 4.7 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 3.4 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 3.5 seconds.

All 4 chains finished successfully.
Mean chain execution time: 3.8 seconds.
Total execution time: 15.7 seconds.</code></pre>
</div>
</div>
<p>El resultado es mejor y logramos mejorar todos los diagnósticos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>ajuste_3_bangladesh<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha_bar"</span>, <span class="st">"beta_bar"</span>, <span class="st">"sigma_alpha"</span>, <span class="st">"sigma_beta"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">alpha_bar</td>
<td style="text-align: right;">-0.70</td>
<td style="text-align: right;">-0.70</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">-0.86</td>
<td style="text-align: right;">-0.55</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2294.89</td>
<td style="text-align: right;">2794.97</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta_bar</td>
<td style="text-align: right;">0.62</td>
<td style="text-align: right;">0.62</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">0.86</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2898.59</td>
<td style="text-align: right;">2781.62</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma_alpha</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">0.64</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1328.25</td>
<td style="text-align: right;">1940.52</td>
</tr>
<tr class="even">
<td style="text-align: left;">sigma_beta</td>
<td style="text-align: right;">0.56</td>
<td style="text-align: right;">0.56</td>
<td style="text-align: right;">0.21</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">0.91</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">755.45</td>
<td style="text-align: right;">805.18</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_trace</span>(ajuste_3_bangladesh<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"sigma_beta"</span>)))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Ahora podemos considerar el efecto de la variable urbano rural por distrito, donde vemos otra vez el efecto de agregación parcial, aunque esta vez el encogimiento es hacia la media de urbano y rural respectivamente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>probs_1 <span class="ot">&lt;-</span> ajuste_3_bangladesh<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"prob_distrito_urbano"</span>, <span class="st">"prob_distrito_rural"</span>), </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"prob"</span>), <span class="at">names_to =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(variable, <span class="st">"urbano"</span>), <span class="st">"urbano"</span>, <span class="st">"rural"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"district"</span>), </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">extra =</span> <span class="st">"drop"</span>, <span class="at">convert =</span> <span class="cn">TRUE</span>)  <span class="sc">|&gt;</span> </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(district, tipo) <span class="sc">|&gt;</span> <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(value),</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">q5 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.05</span>),</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">q95 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.95</span>)) </span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>resumen_1 <span class="ot">&lt;-</span> bangladesh <span class="sc">|&gt;</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="fu">ifelse</span>(urban <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"urbano"</span>, <span class="st">"rural"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="fu">factor</span>(tipo, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"urbano"</span>, <span class="st">"rural"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(district, tipo, <span class="at">.drop =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">prop_cruda =</span> <span class="fu">mean</span>(use.contraception), <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">district =</span> <span class="fu">as.integer</span>(district))</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>graf_1 <span class="ot">&lt;-</span> probs_1 <span class="sc">|&gt;</span> <span class="fu">left_join</span>(resumen_1) <span class="sc">|&gt;</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> district)) <span class="sc">+</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> media), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q5, <span class="at">ymax =</span> q95), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> prop_cruda, <span class="at">size =</span> n), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>tipo, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>graf_1</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Observaciones</strong>: - Nótese que generalmente tenemos muestras más chicos en zonas urbanas, y por eso vemos que hay más incertidumbre en las estimaciones urbanas. - Sin embargo, vemos que en general la variable urbana influye en el uso de anticonceptivos, aunque tenemos incertidumbre considerable en las estimaciones de las zonas urbanas de los distritos (menos muestra).</p>
<p>Podemos también comparar más directamente cómo cambia la probabilidad de zonas urbanas a rurales dentro de cada distrito:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>probs_1 <span class="sc">|&gt;</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>q5, <span class="sc">-</span>q95) <span class="sc">|&gt;</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> tipo, <span class="at">values_from =</span> media) <span class="sc">|&gt;</span> </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> urbano, <span class="at">y =</span> rural)) <span class="sc">+</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">"red"</span>) </span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Nótese que vemos aquí también la diferencia dentro de distritos entre zonas urbanas y rurales. Las medias posteriores en general están por debajo de la identidad. Adicionalmente, y como es de esperarse, hay correlación dentro de distritos entre las tasas de uso de anticonceptivos en zonas urbanas y rurales. Esto se debe, desde el punto de vista del modelo, a correlación entre el coeficiente <span class="math inline">\(\beta_{1,i}\)</span> común al efecto de urbano y rural: urbano es <span class="math inline">\(beta_{1,i} + beta_{2,i}\)</span> y rural <span class="math inline">\(\beta_{1,i}\)</span>. Es natural entonces observar una correlación positiva entre los dos siguientes coeficientes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>ajuste_3_bangladesh<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"beta_sim"</span>), <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">beta_sim[1]</span><span class="st">`</span>, <span class="at">x =</span> <span class="st">`</span><span class="at">beta_sim[1]</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">beta_sim[2]</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"coef_urbano"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"coef_rural"</span>) <span class="sc">+</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Esta última observación suguiere que todavía podemos mejorar nuestras estimaciones: el “encogimiento” en las dos dimensiones debe estar correlacionado dentro de los distritos. En este ejemplo, estamos dejando de utilizar información que está en los datos. Si observamos que el uso de anticonceptivos en una zona urbana de el distrito A tiene un valor dado, esto nos da información acerca del uso de anticonceptivos en la zona rural del distrito A. Veremos ahora cómo podemos aprovechar más eficientemente la información para hacer mejor estimaciones.</p>
</section>
<section id="variables-correlacionadas" class="level2" data-number="9.6">
<h2 data-number="9.6" class="anchored" data-anchor-id="variables-correlacionadas"><span class="header-section-number">9.6</span> Variables correlacionadas</h2>
<p>En nuestro ejemplo anterior, observamos que existe correlación entre las tasas de uso de anticonceptivos en zonas urbanas y rurales a lo largo de los distritos. En términos de nuestro modelo, los coeficientes <span class="math inline">\(\alpha_j +\beta_j\)</span> están correlacionados con los coeficientes <span class="math inline">\(\alpha_j\)</span>. Nótese que la inicial (o hiper-inicial) poblacional no incluye esta correlación, pero efectivamente la posterior captura la correlación. Podemos hacer la estimación más eficiente modelando explícitamente la correlación en la inicial poblacional. Con dos coeficientes podríamos modelar la población con una distribución normal multivariada.</p>
<p>Cambiamos nuestra notación por conveniencia: ahora <span class="math inline">\(\beta\)</span> es un vector que incluye la ordenada al origen <span class="math inline">\(\beta_1\)</span> y la pendiente <span class="math inline">\(\beta_2\)</span>.</p>
<p><span class="math display">\[\beta \sim NMV(\bar{\beta}, \Sigma)\]</span> adicionalmente a <span class="math inline">\(\bar{\beta} \sim N(0,I)\)</span> y <span class="math inline">\(\sigma_1, \sigma_2 \sim N^{+}(0,1)\)</span>.</p>
<p>Podemos pensar en la matriz de covarianzas <span class="math inline">\(\Sigma\)</span> como dada en dos partes: <span class="math inline">\(\Omega\)</span>, una matriz de correlaciones, y dos deviaciones estándar <span class="math inline">\(\sigma\)</span>, de modo que</p>
<p><span class="math display">\[\Sigma = \textrm{diag}(\sigma)\,\Omega\, \textrm{diag}(\sigma)\]</span></p>
<p>En nuestro ejemplo anterior teníamos <span class="math inline">\(\Omega = I\)</span>. En general, si <span class="math inline">\(\Omega\)</span> es una matriz de correlaciones, entonces <span class="math inline">\(\Sigma\)</span> se escribe como:</p>
<p>La pregunta ahora es qué distribución inicial le podemos dar a la matriz <span class="math inline">\(\Omega\)</span> de correlaciones. Aún cuando en este caso bivariado sólo tenemos que dar una inicial a la correlación y es posible definir alguna distribución inicial para <span class="math inline">\(\rho\in(-1,1)\)</span>, en general el problema de poner una distribución sobre matrices de correlación no es simple. Usamos la llamada <a href="https://mc-stan.org/docs/functions-reference/correlation_matrix_distributions.html#lkj-correlation">distribución LKJ</a>, <span class="math display">\[\Omega \sim \textrm{LKJ}(\eta)\]</span> con <span class="math inline">\(\eta&gt;0\)</span>. <span class="math inline">\(\eta\)</span> indica qué tan concentrada está la distribución en correlaciones cercanas a 0, o cuánta dispersión esperamos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>modelo_str <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="st">data{}</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="st">parameters {}</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="st">model {}</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[2,2] Omega_02;</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[2,2] Omega_2;</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="st">  matrix[2,2] Omega_20;</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="st">  Omega_02 = lkj_corr_rng(2, 0.2);</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="st">  Omega_2 = lkj_corr_rng(2, 2);</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="st">  Omega_20 = lkj_corr_rng(2, 20);</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>archivo <span class="ot">&lt;-</span><span class="fu">file</span>(<span class="st">"./src/ejemplo_lkj.stan"</span>)</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(modelo_str, archivo)</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(archivo)</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>sim_lkj <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">cmdstan_model</span>(<span class="st">"./src/ejemplo_lkj.stan"</span>)</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>salida <span class="ot">&lt;-</span> sim_lkj<span class="sc">$</span><span class="fu">sample</span>(<span class="at">fixed_param =</span> <span class="cn">TRUE</span>, <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>                         <span class="at">show_messages =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> salida<span class="sc">$</span><span class="fu">draws</span>(<span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">"[1,2]"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"valor"</span>) </span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>sims <span class="sc">|&gt;</span> </span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> valor)) <span class="sc">+</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Ahora intentamos ajustar un modelo con esta nueva distribución poblacional inicial:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>mod_4_bangladesh <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/bangladesh-4.stan"</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_4_bangladesh)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  int&lt;lower=0&gt; N_d;
  array[N]  int ac_uso;
  array[N]  int distrito;
  vector[N] urbano;
}

transformed data {
  matrix[N, 2] x;
  for (n in 1:N) {
    x[n,1] = 1;
    x[n,2] = urbano[n];
  }
}

parameters {
  vector[2] beta_bar;
  array[N_d] vector[2] beta;
  vector&lt;lower=0&gt;[2] sigma;
  corr_matrix[2] Omega;
}

transformed parameters {
  cov_matrix[2] Sigma;

  Sigma = quad_form_diag(Omega, sigma);
}

model {
  for(n in 1:N){
      ac_uso[n] ~ bernoulli_logit(x[n] * beta[distrito[n]]);
  }
  beta ~ multi_normal(beta_bar, Sigma);
  // parámetros poblacionales
  beta_bar ~ normal(0, 1);
  sigma ~ normal(0, 1);
  Omega ~ lkj_corr(4);
}

generated quantities {
  vector[N_d] prob_distrito_urbano;
  vector[N_d] prob_distrito_rural;

  for (i in 1:N_d) {
    prob_distrito_urbano[i] = inv_logit(beta[i][1] + beta[i][2]);
    prob_distrito_rural[i] = inv_logit(beta[i][1]);
  }
    // Simular de a priori poblacional
  vector[2] beta_sim;
  beta_sim = multi_normal_rng(beta_bar, Sigma);
}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>ajuste_4_bangladesh <span class="ot">&lt;-</span> mod_4_bangladesh<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lst,</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">1000</span>, <span class="at">init =</span> <span class="fl">0.1</span>, <span class="at">step_size =</span> <span class="fl">0.1</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">9394</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 18.8 seconds.
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 20.6 seconds.
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 21.7 seconds.
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 26.9 seconds.

All 4 chains finished successfully.
Mean chain execution time: 22.0 seconds.
Total execution time: 27.1 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>ajuste_4_bangladesh<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"beta_bar"</span>, <span class="st">"sigma"</span>, <span class="st">"Omega"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta_bar[1]</td>
<td style="text-align: right;">-0.70</td>
<td style="text-align: right;">-0.70</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">-0.87</td>
<td style="text-align: right;">-0.54</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3373.15</td>
<td style="text-align: right;">3227.70</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta_bar[2]</td>
<td style="text-align: right;">0.68</td>
<td style="text-align: right;">0.68</td>
<td style="text-align: right;">0.17</td>
<td style="text-align: right;">0.17</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">0.97</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1983.86</td>
<td style="text-align: right;">2546.75</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma[1]</td>
<td style="text-align: right;">0.56</td>
<td style="text-align: right;">0.55</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">0.73</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">652.47</td>
<td style="text-align: right;">980.05</td>
</tr>
<tr class="even">
<td style="text-align: left;">sigma[2]</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">0.46</td>
<td style="text-align: right;">1.10</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">534.12</td>
<td style="text-align: right;">626.36</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Omega[1,1]</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">Omega[2,1]</td>
<td style="text-align: right;">-0.55</td>
<td style="text-align: right;">-0.58</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">-0.80</td>
<td style="text-align: right;">-0.22</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">898.06</td>
<td style="text-align: right;">1562.15</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Omega[1,2]</td>
<td style="text-align: right;">-0.55</td>
<td style="text-align: right;">-0.58</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">-0.80</td>
<td style="text-align: right;">-0.22</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">898.06</td>
<td style="text-align: right;">1562.15</td>
</tr>
<tr class="even">
<td style="text-align: left;">Omega[2,2]</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>Aunque no tiene problemas graves de divergencia, el ajuste es lento como vemos en el tamaño efectivo bajo de las correlaciones entre la constante <span class="math inline">\(\beta_1\)</span> y el coeficiente de la variable urbana <span class="math inline">\(\beta_2\)</span>. Nota: observa que los coeficientes <span class="math inline">\(\beta_1\)</span> y <span class="math inline">\(\beta_2\)</span> son negativamente correlacionados. Sin embargo, la correlación entre <span class="math inline">\(\beta_1 + \beta_2\)</span> y <span class="math inline">\(\beta_1\)</span> es positiva como veremos más adelante.</p>
<p>Podemos usar también una parametrización no centrada para este modelo. Observamos primero que si <span class="math inline">\(\Omega\)</span> es una matriz de correlaciones, entonces siempre podemos escribir su factorización de Cholesky, dada por <span class="math inline">\(\Omega = LL^T\)</span>, donde <span class="math inline">\(L\)</span> es una matriz triangular inferior. De esta forma, podemos escribir</p>
<p><span class="math display">\[\Sigma = \textrm{diag}(\sigma)\,LL^T\, \textrm{diag}(\sigma)\]</span> De forma que el factor de Cholesky para <span class="math inline">\(\Sigma\)</span> es <span class="math inline">\(\textrm{diag}(\sigma)\,L\)</span>.</p>
<p>Ahora tomemos <span class="math inline">\(Z\sim NMV(0,I)\)</span> y definamos <span class="math inline">\(X = \textrm{diag}(\sigma)\,L\,Z\)</span>. Entonces se puede demostrar que <span class="math inline">\(X\sim NMV(0,\Sigma)\)</span>. De esta forma, si <span class="math inline">\(\beta \sim NMV(\bar{\beta}, \Sigma)\)</span>, podemos escribir <span class="math display">\[\beta = \bar{\beta} + \textrm{diag}(\sigma)\,L\,Z.\]</span> Nótese que el caso de una dimensión, para centrar multiplicábamos por la desviación estándar. El análogo en el caso multivariado es el factor de Cholesky de la covarianza, que es una especie de “raíz” de la covarianza.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>mod_5_bangladesh <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./src/bangladesh-5.stan"</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mod_5_bangladesh)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N;
  int&lt;lower=0&gt; N_d;
  array[N]  int ac_uso;
  array[N]  int distrito;
  vector[N] urbano;
}

transformed data {
  matrix[N, 2] x;
  for (n in 1:N) {
    x[n,1] = 1;
    x[n,2] = urbano[n];
  }
}

parameters {
  vector[2] beta_bar;
  vector&lt;lower=0&gt;[2] sigma;
  cholesky_factor_corr[2] L_Omega;
  matrix[2, N_d] z;
}

transformed parameters {
  cov_matrix[2] Sigma;
  corr_matrix[2] Omega;
  matrix[2, N_d] beta;

  // parametrización no centrada:
  beta = rep_matrix(beta_bar, N_d) + diag_pre_multiply(sigma, L_Omega) * z;

  // Esto solo para recordar dónde están covarianzas y correlaciones:
  // no son necesarias
  Omega = L_Omega * L_Omega';
  Sigma = quad_form_diag(Omega, sigma);

}

model {
  for(n in 1:N){
      ac_uso[n] ~ bernoulli_logit( x[n] * beta[,distrito[n]]);
  }
  to_vector(z) ~ std_normal();
  // parámetros poblacionales
  beta_bar ~ normal(0, 1);
  sigma ~ normal(0, 1);
  // La siguente línea es para tener Omega ~ lkj_corr(4)
  L_Omega ~ lkj_corr_cholesky(4);
}

generated quantities {
  vector[N_d] prob_distrito_urbano;
  vector[N_d] prob_distrito_rural;

  for (i in 1:N_d) {
    prob_distrito_urbano[i] = inv_logit(beta[1,i] + beta[2,i]);
    prob_distrito_rural[i] = inv_logit(beta[1,i]);
  }

  // Simular de a priori poblacional
  vector[2] beta_sim;
  beta_sim = multi_normal_rng(beta_bar, Sigma);

}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>ajuste_5_bangladesh <span class="ot">&lt;-</span> mod_5_bangladesh<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> datos_lst,</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">1000</span>, <span class="at">init =</span> <span class="fl">0.1</span>, <span class="at">step_size =</span> <span class="fl">0.1</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">seed =</span> <span class="dv">9394</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 13.3 seconds.
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 13.5 seconds.
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 13.6 seconds.
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 14.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 13.6 seconds.
Total execution time: 14.4 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>ajuste_5_bangladesh<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"beta_bar"</span>, <span class="st">"sigma"</span>, <span class="st">"Omega"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">median</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mad</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rhat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_bulk</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">beta_bar[1]</td>
<td style="text-align: right;">-0.70</td>
<td style="text-align: right;">-0.70</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">-0.87</td>
<td style="text-align: right;">-0.54</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1631.27</td>
<td style="text-align: right;">2042.08</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta_bar[2]</td>
<td style="text-align: right;">0.68</td>
<td style="text-align: right;">0.68</td>
<td style="text-align: right;">0.17</td>
<td style="text-align: right;">0.17</td>
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1998.80</td>
<td style="text-align: right;">2890.16</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sigma[1]</td>
<td style="text-align: right;">0.56</td>
<td style="text-align: right;">0.55</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">0.73</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">986.61</td>
<td style="text-align: right;">1820.06</td>
</tr>
<tr class="even">
<td style="text-align: left;">sigma[2]</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.21</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">1.09</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">593.66</td>
<td style="text-align: right;">317.85</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Omega[1,1]</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">Omega[2,1]</td>
<td style="text-align: right;">-0.54</td>
<td style="text-align: right;">-0.57</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">0.17</td>
<td style="text-align: right;">-0.79</td>
<td style="text-align: right;">-0.18</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1135.48</td>
<td style="text-align: right;">1200.95</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Omega[1,2]</td>
<td style="text-align: right;">-0.54</td>
<td style="text-align: right;">-0.57</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">0.17</td>
<td style="text-align: right;">-0.79</td>
<td style="text-align: right;">-0.18</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1135.48</td>
<td style="text-align: right;">1200.95</td>
</tr>
<tr class="even">
<td style="text-align: left;">Omega[2,2]</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>Este resultado es superior en convergencia al anterior.</p>
<p>Ahora podemos comparar nuestra estimaciones del efecto de la variable urbana/rural en cada distrito, considerando el modelo con correlación y sin correlación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>probs_corr <span class="ot">&lt;-</span> ajuste_5_bangladesh<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"prob_distrito_urbano"</span>, <span class="st">"prob_distrito_rural"</span>), </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"prob"</span>), <span class="at">names_to =</span> <span class="st">"variable"</span>) <span class="sc">|&gt;</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(variable, <span class="st">"urbano"</span>), <span class="st">"urbano"</span>, <span class="st">"rural"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="at">sep =</span> <span class="st">"[</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"variable"</span>, <span class="st">"district"</span>), </span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">extra =</span> <span class="st">"drop"</span>, <span class="at">convert =</span> <span class="cn">TRUE</span>)  <span class="sc">|&gt;</span> </span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(district, tipo) <span class="sc">|&gt;</span> <span class="fu">summarise</span>(<span class="at">media =</span> <span class="fu">mean</span>(value),</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">q5 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.05</span>),</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">q95 =</span> <span class="fu">quantile</span>(value, <span class="fl">0.95</span>)) </span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>resumen_corr <span class="ot">&lt;-</span> bangladesh <span class="sc">|&gt;</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="fu">ifelse</span>(urban <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"urbano"</span>, <span class="st">"rural"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tipo =</span> <span class="fu">factor</span>(tipo, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"urbano"</span>, <span class="st">"rural"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(district, tipo, <span class="at">.drop =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">prop_cruda =</span> <span class="fu">mean</span>(use.contraception), <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">district =</span> <span class="fu">as.integer</span>(district))</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>graf_corr <span class="ot">&lt;-</span> probs_corr <span class="sc">|&gt;</span> <span class="fu">left_join</span>(resumen_corr) <span class="sc">|&gt;</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> district)) <span class="sc">+</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> media), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q5, <span class="at">ymax =</span> q95), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> prop_cruda, <span class="at">size =</span> n), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>tipo, <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>graf_corr</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Las estimaciones son distintas comparando con el modelo sin correlación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>probs <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(probs_1 <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">modelo =</span> <span class="st">"Sin correlación"</span>),</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>                   probs_corr <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">modelo =</span> <span class="st">"Con correlación"</span>)) </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>probs <span class="sc">|&gt;</span> </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>q5, <span class="sc">-</span>q95) <span class="sc">|&gt;</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> tipo, <span class="at">values_from =</span> media) <span class="sc">|&gt;</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> urbano, <span class="at">y =</span> rural, <span class="at">label =</span> district)) <span class="sc">+</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>() <span class="sc">+</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>modelo)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Y veamos ahora cómo están correlacionados los coeficientes de urbano y rural:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>ajuste_5_bangladesh<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"beta_sim"</span>), <span class="at">format =</span> <span class="st">"df"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="st">`</span><span class="at">beta_sim[1]</span><span class="st">`</span>, <span class="at">x =</span> <span class="st">`</span><span class="at">beta_sim[1]</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">beta_sim[2]</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"coef_urbano"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"coef_rural"</span>) <span class="sc">+</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-modelos-jerarquicos_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Y vemos que en realidad los datos no sugieren que existe una correlación alta entre los coeficientes, a pesar de la parametrización que usamos. Por eso observamos un patrón de encogimiento diferente en el modelo con correlaciones. Veamos un ejemplo:</p>
<ul>
<li>Notemos por ejemplo el distrito 11, que sólo tiene observaciones de regiones rurales, con un tamaño de muestra relativamente chico:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>resumen_corr <span class="sc">|&gt;</span> <span class="fu">filter</span>(district <span class="sc">==</span> <span class="dv">11</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
# Groups:   district [61]
  district tipo   prop_cruda     n
     &lt;int&gt; &lt;fct&gt;       &lt;dbl&gt; &lt;int&gt;
1       11 urbano        NaN     0
2       11 rural           0    21</code></pre>
</div>
</div>
<ul>
<li><p>Su valor observado de uso de anticonceptivos es 0, muy baja, y naturalmente esperamos una estimación por arriba de cero, pero baja en la población de zonas rurales. Sin correlación, la estimación de zonas urbanas es considerablemente baja también.</p></li>
<li><p>Con correlación, sin embargo, la estimación de urbano es considerablemente más alta, cercana a la media poblacional.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>probs <span class="sc">|&gt;</span> <span class="fu">filter</span>(district <span class="sc">==</span> <span class="dv">11</span>) <span class="sc">|&gt;</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(tipo) <span class="sc">|&gt;</span> <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">district</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">tipo</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">media</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">q95</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">modelo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">11</td>
<td style="text-align: left;">rural</td>
<td style="text-align: right;">0.178</td>
<td style="text-align: right;">0.087</td>
<td style="text-align: right;">0.283</td>
<td style="text-align: left;">Sin correlación</td>
</tr>
<tr class="even">
<td style="text-align: right;">11</td>
<td style="text-align: left;">rural</td>
<td style="text-align: right;">0.160</td>
<td style="text-align: right;">0.074</td>
<td style="text-align: right;">0.265</td>
<td style="text-align: left;">Con correlación</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11</td>
<td style="text-align: left;">urbano</td>
<td style="text-align: right;">0.292</td>
<td style="text-align: right;">0.095</td>
<td style="text-align: right;">0.556</td>
<td style="text-align: left;">Sin correlación</td>
</tr>
<tr class="even">
<td style="text-align: right;">11</td>
<td style="text-align: left;">urbano</td>
<td style="text-align: right;">0.435</td>
<td style="text-align: right;">0.170</td>
<td style="text-align: right;">0.726</td>
<td style="text-align: left;">Con correlación</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-albert2009bayesian" class="csl-entry" role="listitem">
Albert, Jim. 2009. <em>Bayesian computation with R</em>. Dordrecht: Springer. <a href="http://www.springerlink.com/content/978-0-387-92298-0#section=15956&amp;page=1">http://www.springerlink.com/content/978-0-387-92298-0#section=15956&amp;page=1</a>.
</div>
<div id="ref-rethinking" class="csl-entry" role="listitem">
McElreath, R. 2020. <em>Statistical Rethinking: A Bayesian Course with Examples in R and Stan</em>. A Chapman &amp; Hall libro. CRC Press. <a href="https://books.google.com.mx/books?id=Ie2vxQEACAAJ">https://books.google.com.mx/books?id=Ie2vxQEACAAJ</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./08-mcmc.html" class="pagination-link" aria-label="Markov Chain Monte Carlo">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Markov Chain Monte Carlo</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./13-exp-naturales.html" class="pagination-link" aria-label="Otros métodos para inferencia causal">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Otros métodos para inferencia causal</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>